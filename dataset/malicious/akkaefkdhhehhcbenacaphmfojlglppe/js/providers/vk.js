const parser={r:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789+/=",vkId:0,getRealLink:function(a){var b=String.fromCharCode;if(~a.indexOf("audio_api_unavailable")){var c=a.split("?extra=")[1].split("#"),d=""===c[1]?"":this.a(c[1]);if(c=this.a(c[0]),"string"!=typeof d||!c)return a;for(var f,g,h=(d=d?d.split(b(9)):[]).length;h--;){if(f=(g=d[h].split(b(11))).splice(0,1,c)[0],!this.decodeUrl[f])return a;c=this.decodeUrl[f].apply(null,g)}if(c&&"http"===c.substr(0,4))return c}return a},a:function(b){if(!b||1==b.length%4)return!1;for(var c,d,f=0,g=0,h="";d=b.charAt(g++);)d=this.r.indexOf(d),~d&&(c=f%4?64*c+d:d,f++%4)&&(h+=String.fromCharCode(255&c>>(6&-2*f)));return h},s:function(b,c){var d=b.length,f=[];if(d){var g=d;for(c=Math.abs(c);g--;)f[g]=0|(c+=c*(g+d)/c)%d}return f},decodeUrl:{v:function(a){return a.split("").reverse().join("")},r:function(b,c){b=b.split("");for(var d,e=r+r,f=b.length;f--;)d=e.indexOf(b[f]),~d&&(b[f]=e.substr(d-c,1));return b.join("")},s:function(a,b){var c=a.length;if(c){var d=function(a,b){var c=a.length,d=[];if(c){var f=c;for(b=Math.abs(b);f--;)b=(c*(f+1)^b+f)%c,d[f]=b}return d}(a,b),e=0;for(a=a.split("");++e<c;)a[e]=a.splice(d[c-1-e],1,a[e])[0];a=a.join("")}return a},x:function(a,b){var c=[];return b=b.charCodeAt(0),each(a.split(""),function(a,d){c.push(String.fromCharCode(d.charCodeAt(0)^b))}),c.join("")},i:function(a,b){return parser.decodeUrl.s(a,b^parser.vkId)}}},VKProvider=class{constructor(a){this.c=a,this.code="vk",this.ids={},this.tracks=[],location.href.includes("vk.com/video")?this.videoSearch():this.audioSearch(),this.watchInterval=null,this.itinializeMessageListeners()}itinializeMessageListeners(){chrome.runtime.onMessage.addListener(a=>{"pageUpdated"===a.action&&(this.videos=[],this.tracks=[],this.setBadge(),this.ids={},this.passMediaBack({videos:this.videos,tracks:this.tracks}),location.href.includes("vk.com/video")?this.videoSearch():this.audioSearch())})}videoSearch(){this.watchInterval&&clearInterval(this.watchInterval);const a=this.getId();a&&!this.ids[a]&&this.addVideo(a)}audioSearch(){this.watchInterval&&clearInterval(this.watchInterval),this.watchInterval=setInterval(()=>this.setSongsCount(),2e3)}setSongsCount(){return this.getItems(a=>{"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener({tracks:a});const b=a.length;chrome.runtime.sendMessage({action:"setBadge",value:b||0})})}addVideo(a){this.ids[a]=!0,this.videos=[],this.tracks=[],this.getVideoData(a,a=>{a&&(this.videos=a,this.setBadge())})}parseObject(a){if(a){let b=[];for(let c in a)b.push(c+"="+a[c]);return b.join("&")}return""}getVideoData(a,b){if(!a.id)return!1;const c=a.id.split("_")[0],d={act:"show",al:"1",al_ad:"0",autoplay:"1",force_no_repeat:"1",list:a.hash,module:"profile_own_videos",playlist_id:c+"_1",show_next:"1",video:a.id},e=this.parseObject(d);chrome.runtime.sendMessage({action:"ajaxPost",method:"POST",url:"https://vk.com/al_video.php?act=show",data:e},a=>{let c=JSON.parse(a);if(c&&c.payload&&c.payload[1]&&c.payload[1][4]&&c.payload[1][4].player&&c.payload[1][4].player.params[0]){let a=c.payload[1][4].player.params[0],d=[];a.url240&&d.push({quality:"240p",url:a.url240,duration:a.duration}),a.url360&&d.push({quality:"360p",url:a.url360,duration:a.duration}),a.url480&&d.push({quality:"480p",url:a.url480,duration:a.duration}),a.url720&&d.push({quality:"720p",url:a.url720,duration:a.duration}),a.url1080&&d.push({quality:"10800p",url:a.url1080,duration:a.duration});let e=a.md_user||"",f=a.md_title||"";f=decodeURIComponent(f),f=decodeURI(f),f=unescape(f);let g=".mp4";a.is_flv&&(g=".flv");let h=e+" - "+f;if(h=this.decodeTitle(h),this.videos=d.map(a=>({title:f||"",user:e||"",quality:a.quality||"",url:a.url,duration:a.duration})),0===this.videos.length&&"youtube"===c.payload[1][4].player.type){const a={title:f||"",user:e||"",url:"fake_url",isYoutube:!0};this.videos.push(a)}if(0===this.videos.length&&"undefine"!==c.payload[1][4].player.params[0].live){const a={title:f||"",user:e||"",url:"fake_url",isLive:!0};this.videos.push(a)}const i=this.videos;"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener({videos:i}),b(i)}})}decodeTitle(a){var b=String.fromCharCode;return a=a.replace(/&#([0-9]{2,5});/g,function(c,a){return b(parseInt(a))}),a=a.replace(".mp4","").replace(".flv","").replace(".mp3",""),a=this.decodeHtml(a),a}decodeHtml(a){let b=document.createElement("textarea");return b.innerHTML=a,b.value}fetchIdUsingUrl(a){let b=/video([0-9-]+_[0-9-]+)/i,c=a.match(b);if(c&&c[1]){b=/%2F([0-9a-zA-Z-]+)/i;let d=!1,e=a.match(b);e&&e[1]&&(d=e[1]);let f={id:c[1],hash:d};return f}return!1}getId(){let a=!1;if(!a){const b=document.getElementsByClassName("video_box_wrap")[0];if(b){const c=b.getAttribute("id");if(c){let b=c.match(/([0-9-]+_[0-9-]+)/i);b&&b[1]&&(a={id:b[1],hash:!1})}}}if(a||(a=this.fetchIdUsingUrl(document.location.href)),!1===a.hash){const b=document.body.innerHTML;let c=new RegExp("Video.show\\(event, '"+a.id+"', {autoplay: 1, queue: 1, listId: '([0-9a-z]+)'","i"),d=b.match(c);if(d&&d[1])a.hash=d[1];else if(c=new RegExp("video"+a.id+"\\\\/([0-9a-z]+)","i"),d=b.match(c),d&&d[1])a.hash=d[1];else{const b=document.head.innerHTML;if(c=new RegExp("video"+a.id+"\\?list=([0-9a-z]+)","i"),d=b.match(c),d&&d[1])a.hash=d[1];else{let b=document.location.href;c=/video[0-9-_]+%2F([0-9a-zA-Z-]+)/i,d=b.match(c),d&&d[1]&&(a.hash=d[1])}}}return a}setBadge(){chrome.runtime.sendMessage({action:"setBadge",value:this.videos.length})}passMediaBack(a){"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener(a)}getItems(a){const b=[];let c=$(".audio_row");for(let d=0;d<c.length;d++){const a=this.buildAudioItem(c[d]);b.push(a)}a(b)}registerMediaUpdateListener(a){this.mediaUpdateListener=a}buildAudioItem(a){const b=this.getAudioInfo(a),{artist:c,title:d,length:e}=b,f={artist:c,name:`${c} - ${d}`,url:null,album:"",fullId:a.dataset.fullId,track_addon:b.track_addon,vkId:b.vk_id,length:e,sizes:{hq_bit:0,hq_bit_str:"",size:""}},g="".concat(f.fullId,"_").concat(f.track_addon),h="act=reload_audio&al=1&ids=".concat(g),i=f.length;return{id:f.vkId,url:"https://vk.com/al_audio.php",name:f.name,pr:"vk",data:{duration:i,body:h,link:"https://vk.com/al_audio.php"}}}getAudioInfo(a){const b=a.getAttribute("data-full-id");if(b){let b=JSON.parse(a.dataset.audio),c=b[13],d=b[15].vk_id;return{type:"getAudioInfo",fullId:a.dataset.fullId,length:b[5],artist:b[4],title:b[3],vk_id:d,track_addon:!~c.indexOf("///")?"".concat(c.split("/")[2],"_").concat(c.split("//").pop().split("/")[0]):"".concat(c.split("/")[2],"_").concat(c.split("///")[1].split("/")[0])}}}async getVKAudioSrc(a){return new Promise((b,c)=>{chrome.runtime.sendMessage({action:"fetchVKData",item:a},d=>{this.setCookie("remixcurr_audio",a.id);let e=this.parseVKResponse(d,a.title);if(!e)return c();if(/\.m3u8\?/.test(e)){const a=(e=e.replace("/index.m3u8",".mp3")).split("/"),b=-1===e.indexOf("audios")?0:1;a.splice(a.length-(2+b),1),e=a.join("/")}return b(e)})})}parseVKResponse(a){const b=JSON.parse(a);if(!b||!b.payload||!b.payload[1]||!b.payload[1][0]||!b.payload[1][0][0]||b.payload[1][0][1])return null;const c=b.payload[1][0][0],d=c[2];parser.vkId=c[15].vk_id;const e=parser.getRealLink(d);return e}setCookie(a,b,c){let e=c||{},f=e.expires;if("number"==typeof f&&f){let a=new Date;a.setTime(a.getTime()+1e3*f),f=e.expires=a}f&&f.toUTCString&&(e.expires=f.toUTCString());let g=encodeURIComponent(b),h=a+"="+g;for(let d in e){h+="; ".concat(d);let a=e[d];!0!==a&&(h+="=".concat(a))}document.cookie=h}};