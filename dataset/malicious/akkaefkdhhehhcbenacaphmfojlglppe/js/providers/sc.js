const SCProvider=class{constructor(a){this.c=a,this.code="sc",this.protocol="https:",this.host="soundcloud.com",this.client_id="02gUJC0hH2ct1EGOcYXQIzRFU91c72Ea",this.selectors={sound_badge:"soundBadgeList__item",sound_list:"soundList__item",track_list:"trackList__item",track_list_system:"systemPlaylistTrackList__item",chart_tracks:"chartTracks__item",engagement:"listenEngagement__actions",listen:"listenContent__sound",search:"searchItem__trackItem",panel:"playbackSoundBadge__avatar",single:"singleSound",discover_wave:"seedSound__waveform",history:"historicalPlays__item",cover_flow:"coverFlow__item"},this.processedItems=new Map,this.getClientId().then(()=>{this.runTrackWatcher(),this.itinializeMessageListeners()})}registerMediaUpdateListener(a){this.mediaUpdateListener=a}runTrackWatcher(){this.intervalId&&clearInterval(this.intervalId),this.setSongsCount(),this.intervalId=setInterval(()=>this.setSongsCount(),4e3)}itinializeMessageListeners(){chrome.runtime.onMessage.addListener(a=>{"pageUpdated"===a.action&&this.runTrackWatcher()})}selector(a){return Object.values(this.selectors).map(b=>`.${b}${a}`).join(",")}fetchSelectorNameByElem(a){const b=this.selectors;for(const c in b)if(a.hasClass(b[c]))return c}getClientId(){const a=this.protocol+"//"+this.host;return this.fetch(a,!1).then(a=>{const b=a.match(/<script[\s\S]*?>[\s\S]*?<\/script>/gi);if(!b||!b.length)throw new Error("Tags must be array");const c=function(a){const b=a.match(/client_id:\s*\"([^\"]+)\"/);let c=null;return b&&(c=b[1]),Promise.resolve(c)},d=a=>this.fetch(a,!1).then(c),e=b.map(function(a){const b=$(a),e=b.attr("src");return"string"==typeof e&&e.length?d(e):c(b.text())});return Promise.all(e)}).then(a=>{const b=a.filter(function(a,b,c){return a&&c.indexOf(a)===b})[0];if("string"!=typeof b||!b.length)throw new Error("Client id must be string");return this.client_id=b,b})}fetch(a,b=!0){return new Promise(c=>{chrome.runtime.sendMessage({action:"ajaxGet",url:a},a=>{c(b?JSON.parse(a):a)})})}captureAudioFiles(){return $(this.selector(""))}parseLinks(a){return Promise.all(a.map(a=>this.processedItems.has(a)?Promise.resolve(this.processedItems.get(a)):this.getUrlConfig(a).then(b=>{if(!b||!b.media||!b.media.transcodings)return null;let c=b.media.transcodings.find(({format:a})=>"progressive"===a.protocol&&"audio/mpeg"===a.mime_type);if(!c)return null;const d={id:a,name:`${b.user.username} - ${b.title}`,pr:"sc",data:{url:`${c.url}?client_id=${this.client_id}`}};return this.processedItems.set(a,d),d})))}startParsing(a){return[...a].map(a=>{const b=$(a),c=this.fetchSelectorNameByElem(b);if(!c)return null;return"sound_badge"===c||"sound_list"===c||"search"===c||"discover_wave"===c||"history"===c?b.find("a.soundTitle__title[href]").attr("href"):"track_list"===c||"track_list_system"===c?b.find("a.trackItem__trackTitle[href]").attr("href"):"badge"===c||"discover"===c?b.find("a.audibleTile__artworkLink[href]").attr("href"):"chart_tracks"===c?b.find(".chartTrack__title > a[href]").attr("href"):"panel"===c?b.attr("href"):"engagement"===c||"listen"===c?location.href:"single"===c?b.find(".soundHeader__title a[href]:last-child").attr("href"):"cover_flow"===c?b.find("a.audibleTile__artworkLink[href]").attr("href"):null}).filter(a=>"string"==typeof a).map(a=>this.normalizeUrl(a))}getUrlConfig(a){return this.fetch(a,!1).then(function(a){if("string"!=typeof a)return null;var b=a.match(/<script>[\s\S]*?<\/script>/gi);if(!b||!b.length)return null;var c=null;for(var d in b)try{c=b[d];var e=c.indexOf("},[{");if(0>e)continue;c=c.substr(e+2),c=c.substr(0,c.length-11),c=JSON.parse(c);break}catch(a){}if(!Array.isArray(c))throw new Error("JSON must be array");return(c=c.reduce(function(a,b){var c=b.data,d=c.filter(function(a){return a.hasOwnProperty("id")&&a.hasOwnProperty("media")&&a.hasOwnProperty("kind")&&"track"===a.kind});return d.length?a.concat(d):a},[]),!!c.length)&&(c=c[0],"object"==typeof c&&c)})}normalizeUrl(a){a=a.replace(/#.*$/i,""),-1<a.search(/^\/\/(?:[\w-]+\.)?soundcloud\.com(?:\d+)?\//i)?a=this.protocol+a:-1===a.search(/https?:\/\//i)&&("/"!==a.charAt(0)&&(a="/"+a),a=this.protocol+"//"+this.host+a);const b=new URL(a);return`${b.protocol}//${b.host}${b.pathname.replace(/\/sets\//gi,"/")}`}getItems(a){const b=this.captureAudioFiles(),c=this.startParsing(b);this.parseLinks(c).then(b=>{a(b.filter(Boolean))})}setSongsCount(){return this.getItems(a=>{"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener({tracks:a}),chrome.runtime.sendMessage({action:"setBadge",value:a.length||0})})}};