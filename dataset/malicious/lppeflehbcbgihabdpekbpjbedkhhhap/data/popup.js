function debounce(t,e=300){let i;return(...a)=>{clearTimeout(i),i=setTimeout((()=>{t.apply(this,a)}),e)}}class Popup{constructor(){this.gainValueInput=document.querySelector("#volume-slider"),this.volumeCurrent=document.querySelector("#volume-current"),this.tabsList=document.querySelector(".tabs__list"),this.notification__close=document.querySelector(".js-notification__close"),this.controller=document.querySelector("#insite-controller"),this.playingTabId=null,this.storage=null,this.handleDocumentKeyPress=this.handleDocumentKeyPress.bind(this),this.tabsData={},this.run(),this.gain=null,chrome.tabs.onUpdated.addListener(debounce((()=>{this.showPlayingTabs()}),500)),chrome.tabs.onRemoved.addListener((t=>{this.getPopupId(t).then((t=>this.getWindow(t))).then((t=>chrome.windows.remove(t))).then((()=>this.showPlayingTabs()))}))}run(){return this.getPlayingTabId().then((()=>this.initializeAudioContext())).then((()=>this.renderVolumeControlValue(0))).then((()=>this.showPlayingTabs())).then((()=>this.initListeners())).then((()=>this.initStorage()))}getPopupId(t){return new Promise((e=>{const i=`popup_${t}`;chrome.storage.local.get([i],(t=>{e(t[i])}))}))}getWindow(t){return new Promise((e=>{chrome.windows.get(t,(t=>{e(t.id)}))}))}async initializeAudioContext(){const t=(await chrome.tabs.getCurrent())?.id;chrome.tabCapture.getMediaStreamId({consumerTabId:t,targetTabId:this.playingTabId},(t=>{this.getMediaStream(t).then((t=>{const e=new AudioContext,i=e.createMediaStreamSource(t);this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination)}))}))}getPlayingTabId(){return new Promise((t=>{chrome.tabs.query({active:!0},(e=>{chrome.runtime.lastError?console.log():(this.playingTabId=e[0].id,this.currentTab=e[0],console.log(this.playingTabId),t(this.playingTabId))}))}))}showPlayingTabs(){this.tabsList.innerHTML="",chrome.tabs.query({audible:!0,windowType:"normal"},(t=>{t.sort(((t,e)=>e.id-t.id)),t.forEach((t=>{const e=document.querySelector("#template-tab").content;e.querySelector(".tab").dataset.tabId=t.id,e.querySelector(".tab__icon-image").src=t.favIconUrl,e.querySelector(".tab__title").textContent=t.title,this.tabsList.appendChild(document.importNode(e,!0))}))}))}initStorage(){return new Promise(((t,e)=>{chrome.storage.local.get({usedIds:[],installationDate:null},(e=>{if(e.installationDate)this.storage=e,this.storage.installationDate=JSON.parse(e.installationDate);else{e.installationDate=new Date;const t=JSON.stringify(e.installationDate);this.storage=e,this.saveToStorage({installationDate:t})}t()}))}))}startNotifications(){const t=this.getCurrentNotification();t&&this.showNotification(t)}showNotification(t){document.querySelector(".js-notification").classList.add("is-active"),document.querySelector(".js-notification__close").dataset.id=t.id,document.querySelector(".js-notification__title").innerHTML=t.title,document.querySelector(".js-notification__message").innerHTML=t.message}getCurrentNotification(){const t=new Date,e=new Date(this.storage.installationDate);return NOTIFICATIONS.filter((e=>t>=new Date(e.dateFrom))).filter((e=>t<=new Date(e.dateTo))).filter((t=>-1===this.storage.usedIds.indexOf(t.id))).filter((i=>i.minDaysFromInstallation<=Math.floor((t-e)/1e3/60/60/23))).sort(((t,e)=>t.priority-e.priority)).pop()}initListeners(){this.initDOMListeners()}initDOMListeners(){$("#insite-controller").on("click",(t=>{this.handleGainChangeButton(t)})),this.gainValueInput.addEventListener("input",(t=>this.handleGainChange(t.target.value))),this.tabsList.addEventListener("click",(t=>this.handleTabListClick(t))),this.notification__close.addEventListener("click",(t=>this.closeNotification(t))),document.documentElement.addEventListener("keypress",this.handleDocumentKeyPress)}handleDocumentKeyPress(t){t.preventDefault();const e=t.key.toLowerCase(),i=+e;if(!isNaN(i)){const t=100*i,e=+this.gainValueInput.max;return+this.gainValueInput.min<=t&&t<=e?(this.gainValueInput.value=t,this.volumeCurrent.textContent=t,this.gainNode.gain.value=t/100,void chrome.tabs.sendMessage(this.playingTabId,{action:"showGain",installationDate:null})):void 0}"r"===e&&window.location.reload()}renderVolumeControlValue(t){console.log(t),this.gainValueInput.value=t,this.volumeCurrent.textContent=t}async handleGainChange(t){let e=this.playingTabId;const i=parseInt(t,10);this.gainNode.gain.value=i/100,this.renderVolumeControlValue(i),this.updateBadge(e,i),chrome.tabs.sendMessage(e,{action:"showGain",volume:i})}getMediaStream(t){return new Promise((e=>{const i=navigator.mediaDevices.getUserMedia({video:!1,audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:t}}});console.log(i),e(i)}))}updateBadge(t,e){chrome.action.setBadgeText({text:`${e}`,tabId:t})}handleGainChangeButton(t){let e=this.playingTabId;this.gainNode.gain.value=1,this.volumeCurrent.textContent=100,this.gainValueInput.textContent=100,$("#volume-slider").prop("value",100),$("#volume-slider").attr("disabled")?$("#volume-slider").attr("disabled",!1):$("#volume-slider").attr("disabled",!0),this.updateBadge(e,100),chrome.tabs.sendMessage(this.playingTabId,{action:"showGain",volume:100})}handleTabListClick(t){t.preventDefault();const e=t.target.closest(".tab"),i=parseInt(e.dataset.tabId,10);chrome.tabs.update(i,{active:!0},(t=>{chrome.windows.update(t.windowId,{focused:!0})}))}closeNotification(t){const e=t.target.dataset.id;this.storage.usedIds.push(e),this.saveToStorage({usedIds:this.storage.usedIds}),t.target.closest(".notification").classList.remove("is-active"),document.querySelector("html").style.minHeight="auto"}saveToStorage(t,e=(()=>{})){chrome.storage.local.set(t,(t=>{e()}))}}const popup=new Popup;