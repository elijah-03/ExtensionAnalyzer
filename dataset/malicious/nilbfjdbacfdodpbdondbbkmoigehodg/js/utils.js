!function(){window.storyUtils={queryHashesFailed429:0,workingQueryHashOwner:null,workingQueryHashSaved:null,queryHashes:[],queryHashForTryNow:null,zipCanceledCheckInterval:0,firstParamRequestJSONgraphqlQuery:960,trackFailsShortCode:0,trackFailsReelMedia:0,requestJSONgraphqlUser:function(a,b){if("function"==typeof b){var c="https://www.instagram.com/"+a+"/?__a=1";$.ajax({url:c,dataType:"json"}).done(function(d){var e;if(/^<!DOCTYPE\s+html>/.test(d)){var f=storyUtils.get_sharedDataFromHTML(d,c);f&&(e=storyUtils.getGraphQlFromSharedData(f,c))}else if("object"!=typeof d)try{e=JSON.parse(d)}catch(g){}else e=d;return e&&e.graphql?b(e):(storyUtils.trackUnknownAjaxResponse({method:"requestJSONgraphqlUser",url:c,data:d,random:.01}),storyUtils.requestHTMLgraphqlUser(a,b))}).fail(function(d){return storyUtils.trackFailedAjaxRequest({method:"requestJSONgraphqlUser",url:c,res:d,random:.01}),storyUtils.requestHTMLgraphqlUser(a,b)})}},requestHTMLgraphqlUser:function(a,b){if("string"==typeof a&&"function"==typeof b){var c="https://www.instagram.com/"+a;$.ajax(c).done(function(a){if(!a||!a.length||!/_sharedData/.test(a))return storyUtils.trackUnknownAjaxResponse({method:"requestHTMLgraphqlUser",url:c,data:a,random:.01}),b({error:1});var d=storyUtils.get_sharedDataFromHTML(a,c);if(!d)return b({error:1});var e=storyUtils.getGraphQlFromSharedData(d,c);return e&&e.graphql?void b(e):b({error:1})}).fail(function(a){return storyUtils.trackFailedAjaxRequest({method:"requestHTMLgraphqlUser",url:c,res:a,random:.01}),b({error:1})})}},requestJSONgraphqlQuery:function(a,b){if("function"==typeof b){var c,d,e,f="string"==typeof a.highlight_reel_id;if(f)c="highlight_reels",e='{"reel_ids":[],"tag_names":[],"location_ids":[],"highlight_reel_ids":["'+a.highlight_reel_id+'"],"precomposed_overlay":false}',d=storyUtils.workingQueryHashStoriesHighlight;else{var g=a.user_id,h=a.end_cursor,i=a.touch,j=a.from_saved,k=a.from_tagged,l=a.from_igtv;c=j?"saved":k||l?"tagged":"owner";var m=a.first||storyUtils.firstParamRequestJSONgraphqlQuery;e='{"id":"'+g+'","first":'+m+',"after":"'+h+'"}',j?d=storyUtils.workingQueryHashSaved:k?(d=storyUtils.workingQueryHashTagged,i&&(m=96),h||(e='{"id":"'+g+'","first":'+m+"}")):d=storyUtils.workingQueryHashOwner}null!==storyUtils.queryHashForTryNow&&(d=storyUtils.queryHashForTryNow,storyUtils.queryHashForTryNow=null);var n="https://www.instagram.com/graphql/query/?query_hash="+d+"&variables="+encodeURI(e);$.ajax({url:n,dataType:"json"}).done(function(a){clearInterval(storyUtils.zipCanceledCheckInterval);var e;if("object"!=typeof a)try{e=JSON.parse(a)}catch(g){}else e=a;return e||e.data?(f&&d!=storyUtils.workingQueryHashStoriesHighlight?(storyUtils.workingQueryHashStoriesHighlight=d,storyUtils.setNewWorkingQueryHash(d,c)):j&&d!=storyUtils.workingQueryHashSaved?(storyUtils.workingQueryHashSaved=d,storyUtils.setNewWorkingQueryHash(d,c)):k&&d!=storyUtils.workingQueryHashTagged?(storyUtils.workingQueryHashTagged=d,storyUtils.setNewWorkingQueryHash(d,c)):j||k||d==storyUtils.workingQueryHashOwner||(storyUtils.workingQueryHashOwner=d,storyUtils.setNewWorkingQueryHash(d,c)),storyUtils.queryHashesFailed429=0,void b(e)):(storyUtils.trackUnknownAjaxResponse({method:"requestJSONgraphqlQuery",url:n,data:a,random:.01}),b({error:1}))}).fail(function(e){if(clearInterval(storyUtils.zipCanceledCheckInterval),429==e.status){if(i||storyUtils.queryHashesFailed429>5)return storyUtils.queryHashesFailed429=0,clearInterval(storyUtils.zipCanceledCheckInterval),b({error:1});storyUtils.queryHashesFailed429++;var f=setTimeout(function(){storyUtils.requestJSONgraphqlQuery(a,b)},12e4*storyUtils.queryHashesFailed429);a.downloadZipObj&&(storyUtils.zipCanceledCheckInterval=setInterval(function(){a.downloadZipObj.zipCanceledByUser&&(clearTimeout(f),clearInterval(storyUtils.zipCanceledCheckInterval),storyUtils.zipCanceledCheckInterval=null,b({cancel:1}))},1e3))}else if(400==e.status)e.responseJSON&&(!e.responseJSON.message||"invalid query_hash"!==e.responseJSON.message&&"execution failure"!==e.responseJSON.message)&&storyUtils.trackEventWithRandom("requestJSONgraphqlQuery_unusual_400_response",{responseJSON:e.responseJSON},.01),e.responseJSON&&e.responseJSON.data&&e.responseJSON.errors&&e.responseJSON.message?setTimeout(function(){return storyUtils.firstParamRequestJSONgraphqlQuery=m/2,storyUtils.firstParamRequestJSONgraphqlQuery<12?b({error:1}):void storyUtils.requestJSONgraphqlQuery(a,b)},500):(storyUtils.removeNotWorkingQueryHash(d,c),storyUtils.queryHashes.length?(storyUtils.queryHashForTryNow=storyUtils.queryHashes.shift(),storyUtils.requestJSONgraphqlQuery(a,b)):storyUtils.getNewQueryHashes(function(d){return d&&d[c]&&d[c].length?(storyUtils.queryHashes=d[c],storyUtils.queryHashForTryNow=storyUtils.queryHashes.shift(),void storyUtils.requestJSONgraphqlQuery(a,b)):b({error:1})}));else{if(500!=e.status)return storyUtils.trackFailedAjaxRequest({method:"requestJSONgraphqlQuery",url:n,res:e,random:.01}),b({error:1});if(storyUtils.queryHashesFailed500>5)return storyUtils.queryHashesFailed500=0,clearInterval(storyUtils.zipCanceledCheckInterval),b({error:1});storyUtils.queryHashesFailed500++;var g=setTimeout(function(){storyUtils.requestJSONgraphqlQuery(a,b)},3e3*storyUtils.queryHashesFailed429);a.downloadZipObj&&(storyUtils.zipCanceledCheckInterval=setInterval(function(){a.downloadZipObj.zipCanceledByUser&&(clearTimeout(g),clearInterval(storyUtils.zipCanceledCheckInterval),storyUtils.zipCanceledCheckInterval=null,b({cancel:1}))},1e3))}})}},requestSearchInUsers:function(a,b){if("string"==typeof a&&0!=a.length){var c="https://i.instagram.com/api/v1/users/search/?&q="+a;$.ajax(c).done(function(a){return b(a&&a.users?{items:a.users}:{error:1})}).fail(function(a){return b({error:1})})}},requestTagStories:function(a,b){var c="https://i.instagram.com/api/v1/feed/tag/"+a+"/";$.ajax(c).done(function(a){return a&&a.story?b(a.story):void b()}).fail(function(a){return b({error:1})})},requestSearchInTags:function(a,b){if("string"==typeof a&&0!=a.length){var c="https://i.instagram.com/api/v1/tags/search/?q="+a;$.ajax(c).done(function(a){return b(a&&a.results?{items:a.results}:{error:1})}).fail(function(a){return b({error:1})})}},requestSearchInPlaces:function(a,b){if("string"==typeof a&&0!=a.length){var c="https://i.instagram.com/api/v1/fbsearch/places/?query="+a;$.ajax(c).done(function(a){return b(a&&a.items?{items:a.items}:{error:1})}).fail(function(a){return b({error:1})})}},requestUserStories:function(a,b){var c="https://i.instagram.com/api/v1/feed/user/"+a+"/story/";$.ajax(c).done(function(a){b(a&&null===a.reel?{empty:1}:a&&a.reel?a.reel:{error:1})}).fail(function(){b({error:1})})},requestLocationStories:function(a,b){!a||!a.toString().length;var c="https://i.instagram.com/api/v1/feed/location/"+a+"/";$.ajax(c).done(function(a){return b(a&&"ok"==a.status?a.story&&a.story.items&&a.story.items.length?a.story:{empty:1}:{error:1})}).fail(function(a){return b({error:1})})},get_sharedDataFromHTML:function(a,b){var c,d;if("string"!=typeof a||!a.length)return null;a=a.replace(/[\r\n\t\s]/g,"");var e=a.indexOf("window._sharedData");if(-1==e)return storyUtils.trackEventWithRandom("no_shared_data_start",{url:b},.001),null;var f=a.indexOf("</script>",e);if(-1==f)return storyUtils.trackEventWithRandom("no_shared_data_end",{url:b},.001),null;var g=a.substr(e,f-e);if(c=g.match(/({.+);$/),c=c&&c[1],!c)return storyUtils.trackEventWithRandom("no_shared_data_string",{url:b},.001),null;try{d=JSON.parse(c)}catch(h){}return d?d:(storyUtils.trackEventWithRandom("error_JSON_parse_shared_data",{url:b},.001),null)},getGraphQlFromSharedData:function(a,b){return a&&"object"==typeof a?a.entry_data?a.entry_data.PostPage?a.entry_data.PostPage[0]:a.entry_data.ProfilePage?a.entry_data.ProfilePage[0]:a.entry_data.FeedPage?a.entry_data.FeedPage[0]:a.entry_data.LandingPage?a.entry_data.LandingPage[0]:(storyUtils.trackEventWithRandom("error_get_graphql_from_shared_data",{url:b},.001),null):(storyUtils.trackEventWithRandom("no_entry_data_in_shared_data_object",{method:"getGraphQlFromSharedData",url:b},.001),null):(storyUtils.trackEventWithRandom("no_shared_data_object",{method:"getGraphQlFromSharedData",url:b},.001),null)},getShortCodesFromEdge:function(a,b){var c=[],d=!1,e=null,f=!1;try{var g=a.edges;g.length&&g.forEach(function(a){if(b){if(b.timeFrom&&b.timeFrom>a.node.taken_at_timestamp)return void(f=!0);if("photo"==b.mediaType&&"GraphVideo"==a.node.__typename||"video"==b.mediaType&&"GraphImage"==a.node.__typename)return}c.push(a.node.shortcode)}),d=a.page_info.has_next_page,e=a.page_info.end_cursor}catch(h){return storyUtils.trackEventWithRandom("error_in",{method:"getShortCodesFromEdge",error:h,url:window.location.href,data:a},.001),{error:1}}return{shortcodes:c,end_cursor:e,has_next_page:d,time_end:f,count:a.count}},getPostsDataFromUserGraphqlOther:function(a,b){storyUtils.requestJSONgraphqlQuery(a,function(c){try{if(a.from_saved)var d=c.data.user.edge_saved_media;else if(a.from_tagged)d=c.data.user.edge_user_to_photos_of_you;else{if(a.highlight_reel_id)return d=c.data.reels_media,f=storyUtils.getStoryItemsFromGraphql(d),b(f);d=c.data.user.edge_owner_to_timeline_media}}catch(e){return storyUtils.trackEventWithRandom("error_in",{method:"getPostsDataFromUserGraphqlOther",error:e,options:a,url:window.location.href,json:c},.001),b()}var f=storyUtils.getShortCodesFromEdge(d,a.advanced);b(f)})},getStoryItemsFromGraphql:function(a){var b=[];return a[0].items.forEach(function(a){try{var c,d,e,f=0,g=0,h=a.is_video?a.video_resources:a.display_resources;if(!h||!Array.isArray(h))return void storyUtils.trackEventWithRandom("no_mediaArray_in_story_graphql","",.01);if(h.forEach(function(a){try{(a.config_width>f||a.config_height>g)&&(f=a.config_width,g=a.config_height,c=a.src)}catch(b){storyUtils.trackErrorParseAjaxResponse({method:"getStoryItemsFromGraphql 1",error:b,data:a,random:.01})}}),!c)return void storyUtils.trackEventWithRandom("no_url_in_story_graphql",{mediaArray:h},.01);e=a.owner.username,d=storyUtils.getFileNameFromLink(c),b.push({url:c,filename:d,username:e})}catch(i){storyUtils.trackErrorParseAjaxResponse({method:"getStoryItemsFromGraphql 2",error:i,data:a,random:.01})}}),b},getFileNameFromLink:function(a,b){return"string"!=typeof a?null:/\.(png|jpg)/.test(a)?storyUtils.getFileNameFromImageLink(a,b):/\.(mp4|flv)/.test(a)?storyUtils.getFileNameFromVideoLink(a,b):null},getFileNameFromVideoLink:function(a,b){if("string"!=typeof a)return null;var c="mp4";-1!==a.indexOf(".flv")&&(c="flv");var d=a.match(/\/([^\/?]+)(?:$|\?)/);return d=d&&d[1],d||(d=Math.floor(1e4*Math.random())+"noname."+c),b&&(d=b+"_"+d),this.filename.modify(d)},getFileNameFromImageLink:function(a,b){if("string"!=typeof a)return null;var c="jpg";-1!==a.indexOf(".png")&&(c="png");var d=a.match(/\/([^\/?]+)(?:$|\?)/);return d=d&&d[1],d||(d=Math.floor(1e4*Math.random())+"_noname."+c),b&&(d=b+"_"+d),this.filename.modify(d)},trackEvent:function(a,b){var c={action:"trackEvent",event:a};"undefined"!=typeof b&&(c.details=JSON.stringify(b)),storyUtils.sendMessage(c)},trackEventWithRandom:function(a,b,c){c||(c=.05),Math.random()<c&&this.trackEvent(a,b)},trackFailedAjaxRequest:function(a){var b=a.res&&JSON.stringify(a.res.responseJSON);b=b||a.res&&a.res.responseText,b=b?b.substr(0,1500):null;var c=a.res&&a.res.status;storyUtils.trackEventWithRandom("fail_ajax_request",{method:a.method,url:a.url,resStatus:c,res:b},a.random)},trackUnknownAjaxResponse:function(a){storyUtils.trackEventWithRandom("unknown_ajax_response",{method:a.method,url:a.url,data:a.data},a.random)},trackErrorParseAjaxResponse:function(a){storyUtils.trackEventWithRandom("error_parse_ajax_response",{method:a.method,url:a.url,error:a.error,data:a.data},a.random)},trackEventPost:function(a,b,c){var d={action:"trackEventPost",url:b,event:a,details:c};storyUtils.sendMessage(d)},trackCodeError:function(a,b){return"object"!=typeof JSON||"function"!=typeof JSON.stringify?void storyUtils.sendMessage({action:"trackEvent",event:"no_json_object"}):void storyUtils.sendMessage({action:"trackEvent",event:"code_error",details:JSON.stringify({method:b,name:a.name,message:a.message,stack:a.stack,additional_info:a.additional_info||""})})},filename:{rtrim:/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,illegalRe:/[\/\?<>\\:\*\|"~]/g,controlRe:/[\x00-\x1f\x80-\x9f]/g,reservedRe:/^\.+/,partsRe:/^(.+)\.([a-z0-9]{1,4})$/i,specialChars:"nbsp,iexcl,cent,pound,curren,yen,brvbar,sect,uml,copy,ordf,laquo,not,shy,reg,macr,deg,plusmn,sup2,sup3,acute,micro,para,middot,cedil,sup1,ordm,raquo,frac14,frac12,frac34,iquest,Agrave,Aacute,Acirc,Atilde,Auml,Aring,AElig,Ccedil,Egrave,Eacute,Ecirc,Euml,Igrave,Iacute,Icirc,Iuml,ETH,Ntilde,Ograve,Oacute,Ocirc,Otilde,Ouml,times,Oslash,Ugrave,Uacute,Ucirc,Uuml,Yacute,THORN,szlig,agrave,aacute,acirc,atilde,auml,aring,aelig,ccedil,egrave,eacute,ecirc,euml,igrave,iacute,icirc,iuml,eth,ntilde,ograve,oacute,ocirc,otilde,ouml,divide,oslash,ugrave,uacute,ucirc,uuml,yacute,thorn,yuml".split(","),specialCharsList:[["amp","quot","lt","gt"],[38,34,60,62]],specialCharsRe:/&([^;]{2,6});/g,rnRe:/\r?\n/g,re1:/[\*\?"]/g,re2:/</g,re3:/>/g,spaceRe:/[\s\t\uFEFF\xA0]+/g,dblRe:/(\.|!|\?|_|,|\-|:|\+){2,}/g,re4:/[\.,:;\/\-_\+=']$/g,decodeUnicodeEscapeSequence:function(a){var b=/\\(\\u[0-9a-f]{4})/g;try{return JSON.parse(JSON.stringify(a).replace(b,"$1"))}catch(c){return a}},decodeSpecialChars:function(a){var b=this;return a.replace(this.specialCharsRe,function(a,c){var d=null;if("#"===c[0])return d=parseInt(c.substr(1)),isNaN(d)?"":String.fromCharCode(d);var e=b.specialCharsList[0].indexOf(c);return-1!==e?(d=b.specialCharsList[1][e],String.fromCharCode(d)):(e=b.specialChars.indexOf(c),-1!==e?(d=e+160,String.fromCharCode(d)):"")})},trim:function(a){return a.replace(this.rtrim,"")},getParts:function(a){return a.match(this.partsRe)},modify:function(a){if(!a)return"";a=this.decodeUnicodeEscapeSequence(a);try{a=decodeURIComponent(a)}catch(b){a=unescape(a)}if(a=this.decodeSpecialChars(a),a=a.replace(this.rnRe," "),a=this.trim(a),a=a.replace(this.re1,"").replace(this.re2,"(").replace(this.re3,")").replace(this.spaceRe," ").replace(this.dblRe,"$1").replace(this.illegalRe,"_").replace(this.controlRe,"").replace(this.reservedRe,"").replace(this.re4,""),a.length<=this.maxLength)return a;var c=this.getParts(a);return c&&3==c.length?(c[1]=c[1].substr(0,this.maxLength),c[1]+"."+c[2]):a}},fixForeach:function(){"undefined"==typeof NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),"undefined"==typeof HTMLCollection.prototype.forEach&&(HTMLCollection.prototype.forEach=Array.prototype.forEach),"undefined"==typeof NodeList.prototype.filter&&(NodeList.prototype.filter=Array.prototype.filter),"undefined"==typeof HTMLCollection.prototype.filter&&(HTMLCollection.prototype.filter=Array.prototype.filter)},isValidUrl:function(a){return!("string"!=typeof a||-1!=a.indexOf("blob:")||!a.match(/\.(png|jpg|mp4|flv)/))},isJqueryAjaxInstance:function(a){return"object"==typeof a&&a.hasOwnProperty("readyState")&&"function"==typeof a.success},getNewQueryHashes:function(a){storyUtils.sendMessage("getNewQueryHashes",a)},setNewWorkingQueryHash:function(a,b){storyUtils.sendMessage({action:"setNewWorkingQueryHash",query_hash:a,type:b})},getWorkingQueryHashes:function(){storyUtils.sendMessage("getWorkingQueryHashes",function(a){a&&(storyUtils.workingQueryHashOwner=a.owner,storyUtils.workingQueryHashSaved=a.saved,storyUtils.workingQueryHashTagged=a.tagged,storyUtils.workingQueryHashStoriesHighlight=a.highlight_reels)})},removeNotWorkingQueryHash:function(a,b){storyUtils.sendMessage({action:"removeNotWorkingQueryHash",query_hash:a,type:b})},downloadFile:function(a,b){return storyUtils.downloadByChromeApi(a,b)},downloadByChromeApi:function(a,b){storyUtils.sendMessage({action:"downloadFile",options:{url:a.url,filename:a.filename,isStory:"undefined"!=typeof a.isStory}},function(a){"function"==typeof b&&b(a)})},getUserNameFromWindowLocation:function(){var a=window.location.href.match(/instagram\.com\/([^\/]+)/);return a&&a[1].trim()||null},getTranslateXStyle:function(a){var b=a.style.transform,c=b.match(/translateX\((\d+)px\)/);return c&&parseInt(c[1])},calculateNativeHorizontalStoryElementsStep:function(a){var b=a.length-1;return this.getTranslateXStyle(a[b])-this.getTranslateXStyle(a[b-1])},sendMessage:function(a,b){"undefined"!=typeof b?chrome.runtime.sendMessage(a,b):chrome.runtime.sendMessage(a)},objectSortByProp:function(a,b,c){function d(a,d){var e=parseInt(a[b]),f=parseInt(d[b]);return c?f>e?1:e>f?-1:0:e>f?1:f>e?-1:0}a.sort(d)},bridge:function(a){"use strict";a.args=a.args||[],void 0===a.timeout&&(a.timeout=300);var b="ext-bridge-"+parseInt(1e3*Math.random())+"-"+Date.now(),c=function(d){window.removeEventListener("ext-bridge-"+b,c);var e;e=d.detail?JSON.parse(d.detail):void 0,a.cb(e)};window.addEventListener("ext-bridge-"+b,c);var d="("+function(a,b,c,d){var e=document.getElementById(c);e&&e.parentNode.removeChild(e);var f=!1,g=function(a){if(!f){f=!0;var b=new CustomEvent("ext-bridge-"+c,{detail:JSON.stringify(a)});window.dispatchEvent(b)}};d&&setTimeout(function(){g()},d),b.push(g),a.apply(null,b)}.toString()+")("+[a.func.toString(),JSON.stringify(a.args),JSON.stringify(b),parseInt(a.timeout)].join(",")+");",e=document.createElement("script");e.id=b,e.innerText=d,document.body.appendChild(e)},getMaxResolutionsUrl:function(a){var b=0,c=0,d=0;return a.each(function(a,e){e.getAttribute("height")>b?(b=e.getAttribute("height"),c=e.getAttribute("width"),d=a):e.getAttribute("width")>c&&(c=e.getAttribute("width"),b=e.getAttribute("height"),d=a)}),$(a.get(d)).text()},getIgtvFileName:function(a){var b=a.url||a.video_url,c="mp4";-1!==b.indexOf(".flv")&&(c="flv");var d=b.match(/\/([^\/?]+)(?:$|\?)/);return d=d&&d[1],d||(d=a.id+"."+c),"saved_live_"+d}}}();