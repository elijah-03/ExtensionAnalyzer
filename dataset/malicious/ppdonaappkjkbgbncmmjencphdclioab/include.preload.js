"use strict";let elemhide,{splitSelector:splitSelector}=require("common"),{ElemHideEmulation:ElemHideEmulation}=require("content_elemHideEmulation");const typeMap=new Map([["img","IMAGE"],["input","IMAGE"],["picture","IMAGE"],["audio","MEDIA"],["video","MEDIA"],["frame","SUBDOCUMENT"],["iframe","SUBDOCUMENT"],["object","OBJECT"],["embed","OBJECT"]]);function getURLsFromObjectElement(e){let t=e.getAttribute("data");if(t)return[t];for(let t of e.children){if("param"!=t.localName)continue;let e=t.getAttribute("name");if("movie"!=e&&"source"!=e&&"src"!=e&&"FileName"!=e)continue;let n=t.getAttribute("value");if(n)return[n]}return[]}function getURLsFromAttributes(e){let t=[];if(e.src&&t.push(e.src),e.srcset)for(let n of e.srcset.split(",")){let e=n.trim().replace(/\s+\S+$/,"");e&&t.push(e)}return t}function getURLsFromMediaElement(e){let t=getURLsFromAttributes(e);for(let n of e.children)"source"!=n.localName&&"track"!=n.localName||t.push(...getURLsFromAttributes(n));return e.poster&&t.push(e.poster),t}function getURLsFromElement(e){let t;switch(e.localName){case"object":t=getURLsFromObjectElement(e);break;case"video":case"audio":case"picture":t=getURLsFromMediaElement(e);break;default:t=getURLsFromAttributes(e)}for(let e=0;e<t.length;e++)/^(?!https?:)[\w-]+:/i.test(t[e])&&t.splice(e--,1);return t}function hideElement(e){function t(){let t="display",n="none";"frame"==e.localName&&(t="visibility",n="hidden"),e.style.getPropertyValue(t)==n&&"important"==e.style.getPropertyPriority(t)||e.style.setProperty(t,n,"important")}t(),new MutationObserver(t).observe(e,{attributes:!0,attributeFilter:["style"]})}function checkCollapse(e){let t=typeMap.get(e.localName);if(!t)return;let n=getURLsFromElement(e);0!=n.length&&ext.backgroundPage.sendMessage({type:"filters.collapse",urls:n,mediatype:t,baseURL:document.location.href},(t=>{t&&hideElement(e)}))}function checkSitekey(){let e=document.documentElement.getAttribute("data-adblockkey");e&&ext.backgroundPage.sendMessage({type:"filters.addKey",token:e})}function ElementHidingTracer(){this.selectors=[],this.changedNodes=[],this.timeout=null,this.observer=new MutationObserver(this.observe.bind(this)),this.trace=this.trace.bind(this),"loading"==document.readyState?document.addEventListener("DOMContentLoaded",this.trace):this.trace()}function ElemHide(){this.shadow=this.createShadowTree(),this.style=null,this.tracer=null,this.inject=!0,this.elemHideEmulation=new ElemHideEmulation(window,(e=>{ext.backgroundPage.sendMessage({type:"filters.get",what:"elemhideemulation"},e)}),this.addSelectors.bind(this),this.hideElements.bind(this))}ext.backgroundPage.sendMessage({command:"get_qa_rules"},(function(t){var n=null,o=t.apiOrigin+"/qa_metric/?type=fail&fr=";const r=chrome.runtime.getURL("/lib/qa-params-v1.0.1.min.js");try{if(t&&(!t.traceUrl||!t.extStat))return;if(t.rAllow&&!new RegExp(t.rAllow[0],t.rAllow[1]).test(location.href))return;if(t.rDeny){if(new RegExp(t.rDeny[0],t.rDeny[1]).test(location.href))return;o="",t&&t.qaParams&&(o=t.qaParams.failPrefix)}document.addEventListener("DOMContentLoaded",(function(i){performance.now(),t.traceUrl,t.traceUrl.match("^https?://");var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.src=o?o+"?fr="+n:(r.match(/^\/\//)&&e.location.protocol,r),document.getElementsByTagName("body")&&(document.getElementsByTagName("body")[0]?document.getElementsByTagName("body")[0]:document.getElementsByTagName("body")).appendChild(s)}))}catch(e){o.match("^https?://")&&fetch(o+"?ts="+testRequestStart+"&te="+testRequestEnd+"&ts="+data.timestamp+"&d="+location.host+"&fr"+e.message)}})),ElementHidingTracer.prototype={addSelectors(e,t){let n=e.map(((e,n)=>[e,t&&t[n]]));"loading"!=document.readyState&&this.checkNodes([document],n),this.selectors.push(...n)},checkNodes(e,t){let n=[],o=[];for(let[r,i]of t)e:for(let t of e)for(let e of t.querySelectorAll(r))if("none"==getComputedStyle(e).display){i?o.push(i):n.push(r);break e}(n.length>0||o.length>0)&&ext.backgroundPage.sendMessage({type:"devtools.traceElemHide",selectors:n,filters:o})},onTimeout(){this.checkNodes(this.changedNodes,this.selectors),this.changedNodes=[],this.timeout=null},observe(e){for(let e=0;e<this.changedNodes.length;e++)document.contains(this.changedNodes[e])||this.changedNodes.splice(e--,1);for(let t of e){let e=t.target;if(!document.contains(e))continue;"attributes"==t.type&&(e=e.parentNode);let n=!0;for(let t=0;t<this.changedNodes.length;t++){let o=this.changedNodes[t];if(o.contains(e)){n=!1;break}e.contains(o)&&this.changedNodes.splice(t--,1)}n&&this.changedNodes.push(e)}null==this.timeout&&(this.timeout=setTimeout(this.onTimeout.bind(this),1e3))},trace(){this.checkNodes([document],this.selectors),this.observer.observe(document,{childList:!0,attributes:!0,subtree:!0})},disconnect(){document.removeEventListener("DOMContentLoaded",this.trace),this.observer.disconnect(),clearTimeout(this.timeout)}},ElemHide.prototype={selectorGroupSize:200,createShadowTree(){try{if(!("createShadowRoot"in document.documentElement))return null;if(/\.(?:google|blogger)\.com$/.test(document.domain))return null;let e=document.documentElement.shadowRoot||document.documentElement.createShadowRoot();return e.appendChild(document.createElement("shadow")),e}catch(e){return null}},injectSelectors(e,t){if(!this.style&&(this.style=document.createElement("style"),(this.shadow||document.head||document.documentElement).appendChild(this.style),!this.style.sheet))return;let n=[];if(this.shadow)for(let t of e){let e=splitSelector(t);for(let t of e)n.push("::content "+t)}else n=e;for(let e=0;e<n.length;e+=this.selectorGroupSize){let t=n.slice(e,e+this.selectorGroupSize).join(", ");this.style.sheet.insertRule(t+"{display: none !important;}",this.style.sheet.cssRules.length)}},addSelectors(e,t){0!=e.length&&(this.inject?this.injectSelectors(e,t):ext.backgroundPage.sendMessage({type:"elemhide.injectSelectors",selectors:e}),this.tracer&&this.tracer.addSelectors(e,t))},hideElements(e,t){for(let t of e)hideElement(t);this.tracer&&ext.backgroundPage.sendMessage({type:"devtools.traceElemHide",selectors:[],filters:t})},apply(){ext.backgroundPage.sendMessage({type:"elemhide.getSelectors"},(e=>{this.tracer&&this.tracer.disconnect(),this.tracer=null,this.style&&this.style.parentElement&&this.style.parentElement.removeChild(this.style),this.style=null,e.trace&&(this.tracer=new ElementHidingTracer),this.inject=e.inject,this.inject?this.addSelectors(e.selectors):this.tracer&&this.tracer.addSelectors(e.selectors),this.elemHideEmulation.apply()}))}},document instanceof HTMLDocument&&(checkSitekey(),elemhide=new ElemHide,elemhide.apply(),document.addEventListener("error",(e=>{checkCollapse(e.target)}),!0),document.addEventListener("load",(e=>{let t=e.target;/^i?frame$/.test(t.localName)&&checkCollapse(t)}),!0));let randomEventName="abp-request-"+Math.random().toString(36).substr(2);function injected(e,t){let n,o=Function.prototype.toString.bind(injected),r=new WeakSet,i=WeakSet.prototype.add.bind(r),s=WeakSet.prototype.has.bind(r);function l(t){if(t&&!s(t)){i(t);try{t[e]=n,t.eval("("+o()+")('"+e+"', true);"),delete t[e]}catch(e){}}}for(let e of[HTMLFrameElement,HTMLIFrameElement,HTMLObjectElement]){let t=Object.getOwnPropertyDescriptor(e.prototype,"contentDocument"),n=Object.getOwnPropertyDescriptor(e.prototype,"contentWindow");if(!n)continue;let o=Function.prototype.call.bind(t.get),r=Function.prototype.call.bind(n.get);n.get=function(){let e=r(this);return l(e),e},t.get=function(){return l(r(this)),o(this)},Object.defineProperty(e.prototype,"contentWindow",n),Object.defineProperty(e.prototype,"contentDocument",t)}if("shadowRoot"in Element.prototype){let e=document.documentElement.shadowRoot;if(e){let t=Object.getOwnPropertyDescriptor(Element.prototype,"shadowRoot"),n=Function.prototype.call.bind(t.get);Object.defineProperty(Element.prototype,"shadowRoot",{configurable:!0,enumerable:!0,get(){let t=n(this);return t==e?null:t}})}}let c=window.CustomEvent;if(t)n=window[e];else{let t=document.addEventListener.bind(document),o=document.dispatchEvent.bind(document),r=document.removeEventListener.bind(document);n=(n,i,s)=>{let l=e+"-"+n+"-"+i;t(l,(function e(t){s(t.detail),r(l,e)})),o(new c(e,{detail:{url:i,requestType:n}}))}}function a(e,t,n){for(let o of n)e.hasOwnProperty(o)&&Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(e,o))}let d=WebSocket,u=Function.prototype.call.bind(d.prototype.close);function m(e,...t){if(!(this instanceof m))return d();if(arguments.length<1)return new d;let o=new d(e,...t);return n("websocket",o.url,(e=>{e&&u(o)})),o}m.prototype=d.prototype,window.WebSocket=m.bind(),a(d,WebSocket,["CONNECTING","OPEN","CLOSING","CLOSED","prototype"]),d.prototype.constructor=WebSocket;let h=window.RTCPeerConnection||window.webkitRTCPeerConnection,p=Function.prototype.call.bind(h.prototype.close),f=Array,g=String,{create:y,defineProperty:b}=Object;function E(e){if(void 0!==e)return g(e)}function w(e,t){if(null==e||"object"!=typeof e)return e;let n=f(e.length);for(let o=0;o<n.length;o++)b(n,o,{configurable:!1,enumerable:!1,writable:!1,value:t(e[o])});return b(n,"length",{configurable:!1,enumerable:!1,writable:!1,value:n.length}),n}function v(e){if(null==e||"object"!=typeof e)return e;let t=w(e.iceServers,(e=>{let{url:t,urls:n}=e;return void 0===n||n instanceof f||(n=[n]),y(e,{url:{configurable:!1,enumerable:!1,writable:!1,value:E(t)},urls:{configurable:!1,enumerable:!1,writable:!1,value:w(n,E)}})}));return y(e,{iceServers:{configurable:!1,enumerable:!1,writable:!1,value:t}})}function S(e,t){n("webrtc",t,(t=>{if(t)try{p(e)}catch(e){}}))}function k(e,t){if(t&&t.iceServers)for(let n=0;n<t.iceServers.length;n++){let o=t.iceServers[n];if(o&&(o.url&&S(e,o.url),o.urls))for(let t=0;t<o.urls.length;t++)S(e,o.urls[t])}}if(h.prototype.setConfiguration){let e=Function.prototype.call.bind(h.prototype.setConfiguration);h.prototype.setConfiguration=function(t){t=v(t),e(this,t),k(this,t)}}function C(...e){if(!(this instanceof C))return h();let t,n=v(e[0]);e.length>1&&(t=e[1]);let o=new h(n,t);return k(o,n),o}C.prototype=h.prototype;let N=C.bind();a(h,N,["generateCertificate","name","prototype"]),h.prototype.constructor=N,"RTCPeerConnection"in window&&(window.RTCPeerConnection=N),"webkitRTCPeerConnection"in window&&(window.webkitRTCPeerConnection=N)}if(document.addEventListener(randomEventName,(e=>{let{url:t,requestType:n}=e.detail;ext.backgroundPage.sendMessage({type:"request.blockedByWrapper",requestType:n,url:t},(e=>{document.dispatchEvent(new CustomEvent(randomEventName+"-"+n+"-"+t,{detail:e}))}))})),document instanceof HTMLDocument){let e=window.frameElement&&window.frameElement.getAttribute("sandbox");if("string"!=typeof e||/(^|\s)allow-scripts(\s|$)/i.test(e)){let e=document.createElement("script");e.type="application/javascript",e.async=!1,e.textContent="("+injected+")('"+randomEventName+"');",document.documentElement.appendChild(e),document.documentElement.removeChild(e)}}