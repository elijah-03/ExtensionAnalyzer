var wtpContent;(()=>{"use strict";var e={};function t(){return-1!=navigator.userAgent.indexOf("Firefox")}function n(){return t()?browser:chrome}function r(){n().storage.local.get("debug",e=>{e.debug&&console&&console.log&&console.log.apply(this,arguments)})}function i(){console&&console.error&&console.error.apply(this,arguments)}(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);const a={isFirefox:t,getBrowser:n,logInfo:r,logError:i,getCurrentLocale:function e(){void 0===e.locale_map&&TMExt_$.ajax({url:getURL("settings.json"),async:!1,dataType:"json",success:function(t){r(t),e.locale_map=t.supportLanguage,e.default_lang=t.defaultLanguage,e.l10n_map=t.l10nFolderMap}});let t=navigator.language,n=!1,i=e.locale_map,a="";for(var o=0;o<i.length;++o)if(i[o].includes(t)){a=i[o],n=!0;break}n||(a=e.default_lang);let s=a;return void 0!==e.l10n_map[a]&&(s=e.l10n_map[a]),s},tbc_sendRequest:function(e,t,r){var i={action:e,params:t};n().runtime.sendMessage(i,r)},getBankingList:async function(){let e=[];try{const t=await fetch(n().runtime.getURL("PbBankingList.txt"));e=(await t.text()).split("\n")}catch(e){i("getBankingList: e = "+e)}return r("getBankingList: size of banking list = "+e.length),e},binarySearch:function e(t,n,r,i){if(i<r)return-1;if(i-r<=1)return n===t[r]?r:n===t[i]?i:-1;let a=Math.floor((r+i)/2);return t[a]===n?a:t[a]<n?e(t,n,a,i):t[a]>n?e(t,n,r,a):-1},sendMessageToActiveTab:function(e){return new Promise((t,r)=>{const i=n();i.tabs.query({active:!0,currentWindow:!0},n=>{n.length<=0?t(!1):i.tabs.sendMessage(n[0].id,e,()=>{i.runtime.lastError&&r(i.runtime.lastError.message)})})})},sha256:async function(e){let t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(n)].map(e=>e.toString(16).padStart(2,"0")).join("")},Lock:class{constructor(){this._locked=!1,this._waiting=[]}async acquire(){for(;this._locked;)await new Promise(e=>this._waiting.push(e));this._locked=!0}release(){this._locked=!1,this._waiting.length>0&&this._waiting.shift()()}}};let o="Toolbar",s="tbb_ratingURLS",l=n();const g=function(e){return new Promise(t=>{l.storage.local.get(e,e=>{t(e)})})},u="tmtoolbar_page_rating_injected",c="tmtoolbar_manual_rating_injected",p="images/tooltip/";function d(){let e,t,n;for(e="",n=0;n<32;n++)8!=n&&12!=n&&16!=n&&20!=n||(e+="-"),t=Math.floor(16*Math.random()).toString(16).toUpperCase(),e+=t;return e}let h=a.getBrowser(),f=d(),_=d();function m(e){return!!new RegExp("biglobe\\.ne\\.jp","i").test(e)}function w(e){if(null==e)return[];let t=[];return e.Engine.ParserRule&&t.push("js/wtp/CRPattern/"+e.Engine.ParserRule),e.Engine.SupportShareToFriend&&1==e.Engine.SupportShareToFriend&&t.push("js/wtp/CREngine/TISProAlertFriendLib.js"),e.Engine.EnableFeedbackSnsUnsafeUrl&&1==e.Engine.EnableFeedbackSnsUnsafeUrl&&(t.push("js/wtp/CREngine/TISProToolbarSendMailLib.js"),t.push("js/wtp/CREngine/TISProFeedbackSnsUnsafeUrlLib.js")),t}function b(e){return!!document.getElementById(e)}function S(e){let t=document.getElementById(e);return t||(t=document.createElement("div"),t.id=e,t.innerHTML="init",t.style.display="None",document.documentElement.appendChild(t)),t}class T{constructor(e){this.crpattern=e,this.mouseOver=!0,this.highlight=!0,this.tooltipTimeout=300,this.resultIDs=[],this.parseLock=new a.Lock}init(){2===this.crpattern.Engine.Categary&&this.crpattern.Engine.GeneralSearch&&this.RenderRatingSettingPopup();try{if(null===this.crpattern||void 0===this.crpattern)return void a.logError("PageRatingHandler.init: pattern is invalid");if(a.logInfo("PageRatingHandler.init: Check injected node"),b(u))return void a.logInfo("PageRatingHandler.init: node has been injected");if(this.crpattern.Engine.ImageFilter&&(!TSRIsImageSafeSearchEnabled||!TSRIsImageSafeSearchEnabled()))return void a.logInfo("PageRatingHandler.init: safe image search is not enabled");if(!S(u))return void a.logError("PageRatingHandler.init: node not found, may need to inject again");h.runtime.onMessage.addListener(e=>{if(!e.hasOwnProperty("action")||"tbc_insertRatingResult"!==e.action)return;let t=e.params,n=t.docID;n&&(n===f?("undefined"==typeof TSRGetRatingFlowID?a.logInfo("TSRGetRatingFlowID is not defined"):t.flowID!=TSRGetRatingFlowID()&&a.logInfo("flowID is invalid, params.flowID = "+t.flowID,", TSRGetRatingFlowID = "+TSRGetRatingFlowID()),TSRInsertResultICON&&(a.logInfo("insert rating result, url = "+t.url+", ID = "+t.resultID+", level = "+t.ratingLevel+", bPhishing = "+t.bPhishing),this.resultIDs.push(t.resultID),TSRInsertResultICON(t.resultID,t.ratingLevel,t.bPhishing,this.crpattern.Engine.Categary))):n===_&&(a.logInfo("get rating result for analysis, url = "+t.url+", level = "+t.ratingLevel),this.feedbackSiteForAnalysis(t.url,t.ratingLevel)))});let e=null;const t=()=>{e&&(e=null),this.parse()},n=new MutationObserver(()=>{e||(e=setTimeout(t,1e3))}),r={childList:!0,attributes:!0,subtree:!0};n.observe(document.documentElement,r)}catch(e){a.logError("PageRatingHandler.init: e = "+e)}}RenderRatingSettingPopup(){h.storage.local.get({wtp_status:!0,wtp_pagerating_status:!1,wtp_pagerating_highlight_status:!0,wtp_pagerating_set_popup_is_set:!1,wtp_pagerating_set_popup_is_seen:!1,urls:[],browser:"",locale:"en",os:"",plid:"",titanium:{},cros:"",mode:""},e=>{let t=!(e.mode===o&&e.titanium.hasOwnProperty("toolbar_enable")&&!e.titanium.toolbar_enable);if(!e.wtp_status||!e.wtp_pagerating_status||!t||e.wtp_pagerating_set_popup_is_set||!e.wtp_pagerating_set_popup_is_set&&e.wtp_pagerating_set_popup_is_seen)return;let n=!!e.titanium.hasOwnProperty("plid")&&e.titanium.plid,r=n&&n.includes("-NWN-"),i={logo:!0,ja:!0,mac:"mac"===e.os,chromebook:"cros"===e.os,nttwest:r},a="ja"===e.locale?i:{logo:!0},s=productNameLogic(a),l="";void 0!==e.urls.Explain_How_Toolbar_Works&&(l=e.urls.Explain_How_Toolbar_Works),this.highlight=!!e.wtp_pagerating_highlight_status;var g=this;ratingSettingPopup(s,this.highlight,e.browser,l,function(e){h.storage.local.set({wtp_pagerating_highlight_status:e}),g.resultIDs.forEach(t=>{TSRHightlightById(t,e)})},function(e,t=!1){h.storage.local.set({wtp_pagerating_set_popup_is_seen:e,wtp_pagerating_set_popup_is_set:t})})})}parse(){"undefined"!=typeof TSRParse&&"undefined"!=typeof TSRInitToolTip?h.storage.local.get({framework_status:!1,wtp_status:!1,wtp_pagerating_status:!1,wtp_pagerating_highlight_status:!0,urls:[],browser:""},async e=>{if(!e.framework_status||!e.wtp_status||!e.wtp_pagerating_status)return;await this.parseLock.acquire();let t="";void 0!==e.urls.pagerating_How_Turn_Off_highlight_link&&(t=e.urls.pagerating_How_Turn_Off_highlight_link),this.highlight=e.wtp_pagerating_highlight_status;let n=null;try{TSRInitToolTip(getURL(p),this.mouseOver,this.highlight,this.tooltipTimeout,500,t,e.browser),n=TSRParse()}catch(e){a.logError(e)}n&&0!=n.length?(this.RatingURLs(n,this.crpattern),this.parseSitesForAnalysis(),this.parseLock.release()):this.parseLock.release()}):a.logError("PageRatingHandler.parse: lib functions are not available")}parseSitesForAnalysis(){try{if("undefined"==typeof TSRParseForAnalysis)return;let e=TSRParseForAnalysis(),t=new Array;for(let n=0;n<e.length;n++){let r=e[n];r&&!r.sent&&(r.sent=!0,t.push(r.link))}if(0===t.length)return void a.logInfo("parseSitesForAnalysis: no url need to analysis");let n=new URL(document.location.href);h.runtime.sendMessage({action:s,params:{windowguid:_,flowid:0,urls:t,category:this.crpattern.Engine.Categary,host:n.hostname}})}catch(e){a.logError("parseSitesForAnalysis: e = "+e)}}async feedbackSiteForAnalysis(e,t){await this.parseLock.acquire();try{if("undefined"!=typeof GetTSRObjectsForAnalysis){let n=!0,r=!1,i={},o=GetTSRObjectsForAnalysis();for(let a=0;a<o.length;a++){let s=o[a];s&&s.link&&(r||s.link!==e||(s.ratingLevel=t,r=!0),void 0===s.ratingLevel&&(n=!1),i[s.ratingLevel]||(i[s.ratingLevel]=0),i[s.ratingLevel]++)}if(a.logInfo("feedbackSiteForAnalysis: ratingDone = "+n+", findNode = "+r),n){let e=new URL(document.location.href);h.runtime.sendMessage({action:"feedbackUBM",params:{event:"CARBON_Rating_URLs_Site_For_Analysis_S1",value:JSON.stringify({host:e.hostname,count:i})}})}}}catch(e){a.logError("feedbackSiteForAnalysis: e = "+e)}this.parseLock.release()}RatingURLs(e,t){let n=new Array;for(let t=1;t<e.length;t++){let r=e[t];r&&!r.sended&&(r.sended=!0,n[t]=r.link)}if(0!==n.length)try{let r=new URL(document.location.href);h.runtime.sendMessage({action:s,params:{windowguid:f,flowid:e.FlowID,urls:n,category:t.Engine.Categary,host:r.hostname}})}catch(e){a.logError("RatingURLs e = "+e)}}}class R{constructor(){this.mouseOver=!0,this.highlight=!0,this.tooltipTimeout=300}initToolTip(){try{"undefined"!=typeof TSRInitToolTip&&TSRInitToolTip(getURL(p),this.mouseOver,this.highlight,this.tooltipTimeout,500)}catch(e){a.logError("initToolTip: e = "+e)}}handleData(e){try{h.storage.local.get({framework_status:!1,wtp_status:!1,wtp_manualrating_status:!1},t=>{if(!t.framework_status||!t.wtp_status||!t.wtp_manualrating_status)return;let n=new URL(document.location.href);h.runtime.sendMessage({action:"tbb_ratingSingleURL",params:{windowguid:f,url:e,category:5,host:n.hostname}})})}catch(e){a.logError("handleData: e = "+e)}}init(){try{if(a.logInfo("ManualRatingHandler.init: Check injected node"),b(c))return void a.logInfo("ManualRatingHandler.init: node has been injected");if(!S(c))return void a.logError("ManualRatingHandler.init: node not found, may need to inject again");S(Communicator.UMS_EVENT_ID).addEventListener(Communicator.UMS_SEND_DATA_EVENT,e=>{let t=e.target.getAttribute("data");this.handleData(t)}),h.runtime.onMessage.addListener(e=>{if(!e.hasOwnProperty("action")||"tbc_insertSingleRatingResult"!==e.action)return;a.logInfo("ManualRatingHandler.onMessage: message = "+JSON.stringify(e));let t=e.params,n=t.docID;n&&n===f&&(this.initToolTip(),g_manual_rating&&g_manual_rating.callbackFromDoc(t.ratingLevel,t.url))}),this.initToolTip()}catch(e){a.logError("ManualRatingHandler.init: e = "+e)}}}class y{constructor(){this.urlSet=new Set,this.guid=d()}init(){new MutationObserver(()=>{this.parse()}).observe(document,{childList:!0,attributes:!0,subtree:!0})}parse(){h.storage.local.get({framework_status:!1,wtp_status:!1,wtp_rate_subframe:!0,wtp_rate_outer_script:!0},e=>{if(e.framework_status&&e.wtp_status)try{let t=[];if(e.wtp_rate_subframe&&document.querySelectorAll("iframe").forEach(e=>{e.src&&"about:blank"!==e.src&&!this.urlSet.has(e.src)&&(this.urlSet.add(e.src),t.push(e.src))}),e.wtp_rate_outer_script&&document.querySelectorAll("script").forEach(e=>{e.src&&"about:blank"!==e.src&&!this.urlSet.has(e.src)&&(this.urlSet.add(e.src),t.push(e.src))}),a.logInfo("OuterSourceRatingHandler.init: length of newUrls = "+t.length),0===t.length)return;let n=new URL(document.location.href);h.runtime.sendMessage({action:"tbb_ratingOuterSourceURLs",params:{windowguid:this.guid,flowid:0,urls:t,category:0,host:n.hostname}})}catch(e){a.logError("OuterSourceRatingHandler.init: e = "+e)}})}}let I=a.getBrowser();const E="[WTP][Content]",v=async()=>{let e=await g({framework_status:!1});if(!e.framework_status)return void setTimeout(()=>{v()},500);e=await g({l10n_strings:{},browser:"",os:"",mode:"",locale:"en",titanium_name:"",wtp_imagesafesearch_status:!1,serverConfig:{}}),a.logInfo(E,"storageData = "+JSON.stringify(e));let t=e.wtp_imagesafesearch_status,n="";e.mode===o?n=e.titanium_name?e.titanium_name:"":e.l10n_strings&&(n="msedge"===e.browser?e.l10n_strings.product_name:"cros"===e.os?e.l10n_strings.product_name_chromebook:e.l10n_strings.product_name_chrome),a.logInfo(E,"productName = "+n),I.runtime.sendMessage({action:"tbb_pre_load",url:{href:document.location.href}},r=>{if(a.logInfo(E,"message = "+JSON.stringify(r)),!r)return void setTimeout(v,500);let i=["_locales/"+e.locale+"/TISProToolbarLocalization.js","js/wtp/CREngine/TISProToolbarDefine.js","js/wtp/CREngine/TISProToolbarLib.js","js/wtp/CREngine/TISProUrlManualScannerLib.js"],o=r.crPattern;do{if(!o){a.logInfo(E,"content: no pattern information");break}if(4===o.Engine.EngineType&&m(document.referrer)){a.logInfo(E,"skip inject content script");break}let e=w(o);a.logInfo(E,"pageRatingScripts = "+JSON.stringify(e));for(let t in e)i.push(e[t])}while(0);a.logInfo(E,"injectedScripts = "+JSON.stringify(i));var s={scripts:i,csses:["css/common/TISProToolbar.css","js/wtp/trend_notification.css"],all_frames:!1};const l=()=>{I.runtime.sendMessage({action:"tbb_inject_resources",parameters:s},()=>{a.logInfo(E,"script injected and got response"),(()=>{if("undefined"==typeof D_TSRToolTipTitleString)return console.log("inject resource again"),void setTimeout(l,500);D_TSRToolTipTitleString=n,r.featureConfig&&"undefined"!=typeof TSRUpdateFeatureConfig&&(a.logInfo(E,"set WTP feature config = "+JSON.stringify(r.featureConfig)),TSRUpdateFeatureConfig(r.featureConfig)),"undefined"!=typeof TSREnableImageSafeSearch&&TSREnableImageSafeSearch(t);let e=function(e){if(null===e)return null;var t=null;switch(e.Engine.Categary){case 4:case 2:case 3:t=new T(e);break;default:a.logError("No possible")}return t}(o);e&&e.init();let i=new R;i&&i.init();let s=new y;s&&s.init()})()})};l()}),new PerformanceObserver(t=>{t.getEntries().forEach(t=>{const n=Math.round(t.duration);if(n<=0)return;const r=new URL(t.name).hostname;a.logInfo(E,`hostname: ${r}, load duration: ${n} ms`),e.serverConfig.hasOwnProperty("FeedbackPerformanceSites")?-1!=e.serverConfig.FeedbackPerformanceSites.indexOf(r)?I.runtime.sendMessage({action:"tbc_feedback_navigation_duration",parameters:{host:r,duration:n}}):a.logInfo(E,`hostname: ${r} is not in FeedbackPerformanceSites`):a.logInfo(E,"FeedbackPerformanceSites is not exist")})}).observe({type:"navigation",buffered:!0})};v(),wtpContent=e})();