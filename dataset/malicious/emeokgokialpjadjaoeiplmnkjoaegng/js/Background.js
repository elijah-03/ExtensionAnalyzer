var global="undefined"!=typeof chrome?chrome:"undefined"!=typeof browser?browser:void 0;NP={config:{},uid:"",version:chrome.runtime.getManifest().version,IsShortCutsShow:!0,IsAppsShow:!0,init:function(){global.tabs.onUpdated.addListener((function(e,t,o){o.url||o.pendingUrl})),global.browserAction.onClicked.addListener(this.inject),global.runtime.onMessage.addListener((function(e,t,o){if("take_screen_shot"===e.method)NP.screenShot(o);else if("get_pixel_color"===e.method){var n=e.point;NP.getPixelColor(n,o)}else"save_data"===e.method?NP.saveData(e.config):"get_data"===e.method?NP.getData(o):"open_options"===e.method&&chrome.runtime.openOptionsPage();return!0})),NP.initStorage()},getPixelColor:function(e,t){global.tabs.captureVisibleTab(null,null,(function(o){var n=document.createElement("canvas"),a=n.getContext("2d"),i=new Image;document.documentElement.appendChild(n),i.src=o,i.onload=function(){n.width=i.naturalWidth,n.height=i.naturalHeight,a.drawImage(i,0,0);var o=a.getImageData(0,0,n.width,n.height),r=4*(e.y*o.width+e.x),s=o.data;if("function"==typeof t){var c={r:s[r],g:s[r+1],b:s[r+2],a:s[r+3]};document.documentElement.removeChild(n),t(c)}}}))},saveData:function(e){try{localStorage.setItem("config",JSON.stringify(e))}catch(e){}},getData:function(e){var t=localStorage.getItem("config"),o=null;try{o=JSON.parse(t)}catch(e){}e(o)},inject:function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){global.tabs.insertCSS(null,{file:"/css/main.min.css"},(function(){if(global.extension.lastError){global.extension.lastError.message;try{alert("We are sorry, but the page you are viewing is not supported. Please try another page.")}catch(e){}}global.tabs.executeScript(null,{file:"/js/inject.js"})}))}))},screenShot:function(e){global.tabs.captureVisibleTab((function(t){var o=global.extension.getURL("screen.html");global.tabs.query({},(function(n){var a;if(n&&n.length)for(var i=n.length-1;0<=i;i--)if(n[i].url===o){a=n[i];break}a?global.tabs.update(a.id,{active:!0},Function.prototype.bind.call(NP.updateScreenshot,NP,t,e,0)):global.tabs.create({url:o},(o=>{chrome.tabs.onUpdated.addListener((function n(a,i){a==o.id&&"complete"==i.status&&(chrome.tabs.onUpdated.removeListener(n),NP.updateScreenshot(t,e,0,o))}))}))}))}))},updateScreenshot:function(e,t){var o=arguments[2];null==o&&(o=0),10<o||global.runtime.sendMessage({method:"update_url",url:e},(function(n){n&&n.success||window.setTimeout(Function.prototype.bind.call(NP.updateScreenshot,NP,e,t,++o),300)}))},initStorage:function(){chrome.storage.local.get((e=>{e&&e.config&&(NP.config=e.config),NP.config.uid?NP.uid=NP.config.uid:(NP.uid=NP.config.uid=NP.generateUID(),this.saveConfig()),e.IsShortCutsShow||chrome.storage.local.set({IsShortCutsShow:!0}),e.IsAppsShow||chrome.storage.local.set({IsAppsShow:!0})}))},saveConfig(){chrome.storage.local.set({config:NP.config})},generateUID:()=>"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},NP.init();