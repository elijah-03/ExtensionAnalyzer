import{aN as b,aU as E,aV as Oe,A as G,aW as d,M as s,P as ne,H as L,aO as K,aA as Ee,Z as Te,aX as ge,aY as Ce,E as A,aZ as Ge,a_ as Pe,a$ as we,g as p,S as _,q as y,R as de,b0 as me,b1 as Q,b2 as z,b3 as Re,b4 as v,a as be,b5 as se,s as S,b6 as fe,b7 as Se,b8 as Ue,b9 as Me,ba as ve,aj as ie,T as F,bb as ye,bc as oe,bd as q,be as ce,bf as X,au as xe,bg as De,aQ as ke,bh as Ie,bi as $,bj as ue,bk as Fe,ag as He,a5 as $e,aR as le,aE as _e,bl as Ve,bm as We}from"./academia-BTetjztC.js";import{t as Be}from"./translations-DP6Nrkut.js";let U=b,I=chrome.i18n.getUILanguage(),D=U.targetLanguage;function C(e,r){const t=K(e),a=Ee(t.value),i=r.split(".");let o=a;for(const n of i)o&&typeof o=="object"&&n in o&&(o=o[n]);return o}function W(){const e=K(I),t=Ee(e.value).language||{},a=Te(D);return a?t[a.value]||a.label:t.en}async function Ye(e){U=e,D=U.targetLanguage;const r=["page","frame","selection","editable","video","audio"],t=["image"];try{chrome.contextMenus.create({id:E.TRANSLATE_PAGE,title:C(I,"contextMenu.translate").replace("{0}",W()),contexts:r,visible:!0,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({id:E.SHOW_ORIGIN,title:C(I,"contextMenu.showOriginal"),contexts:r,visible:!1,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({id:E.DISABLE_TRANSLATE,title:C(I,"contextMenu.disableSelect"),contexts:r,visible:U.inTextTranslation.enable,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({id:E.SELECT_TRANSLATE,title:C(I,"contextMenu.enableSelect"),contexts:r,visible:!U.inTextTranslation.enable,documentUrlPatterns:["http://*/*","https://*/*"]}),chrome.contextMenus.create({id:E.TRANSLATE_IMAGE,title:`${C(I,"contextMenu.translateAndRestoreImage")}`,contexts:t,visible:!0,documentUrlPatterns:["http://*/*","https://*/*"]})}catch{}}function V(e){try{U.inTextTranslation.enable!==e.inTextTranslation.enable&&(chrome.contextMenus.update(E.DISABLE_TRANSLATE,{visible:e.inTextTranslation.enable}),chrome.contextMenus.update(E.SELECT_TRANSLATE,{visible:!e.inTextTranslation.enable})),U.targetLanguage!==e.targetLanguage&&(D=e.targetLanguage,chrome.contextMenus.update(E.TRANSLATE_PAGE,{title:C(I,"contextMenu.translate").replace("{0}",W())})),U=e}catch{}}function qe(e){try{if(D===e)return;D=e,chrome.contextMenus.update(E.TRANSLATE_PAGE,{title:C(I,"contextMenu.translate").replace("{0}",W())})}catch{}}function Z(e){try{chrome.contextMenus.update(E.TRANSLATE_PAGE,{visible:!e}),chrome.contextMenus.update(E.SHOW_ORIGIN,{visible:e})}catch{}}function Ae(){try{I=chrome.i18n.getUILanguage(),chrome.contextMenus.update(E.TRANSLATE_PAGE,{title:C(I,"contextMenu.translate").replace("{0}",W())}),chrome.contextMenus.update(E.SHOW_ORIGIN,{title:C(I,"contextMenu.showOriginal")}),chrome.contextMenus.update(E.DISABLE_TRANSLATE,{title:C(I,"contextMenu.disableSelect")}),chrome.contextMenus.update(E.SELECT_TRANSLATE,{title:C(I,"contextMenu.enableSelect")})}catch{}}function Xe(e){var r;return(r=e==null?void 0:e.url)==null?void 0:r.startsWith("chrome-extension://mhjfbmdgcfjbbpaeojofohoefgiehjai/")}chrome.contextMenus.onClicked.addListener(async(e,r)=>{var t;if(Xe(r)&&e.menuItemId===E.TRANSLATE_PAGE){let a="";const i="plugin_rightclickmenu_translate_academia";await Oe(e.frameUrl||"")?a=`${G.fileTranslateRedirectPage}?plugin=anydoc&academia_url=${encodeURIComponent(e.frameUrl||"")}&position=${i}`:a=`${G.fileTranslateRedirectPage}?plugin=anydoc&pdf_url=${encodeURIComponent(e.frameUrl||"")}&position=${i}`,chrome.tabs.create({url:a});return}if(!(!r||!r.id||!((t=r.url)!=null&&t.startsWith("http"))))try{e.menuItemId===E.TRANSLATE_PAGE?(d(r.id,s.TRANSLATE_PAGE,{scene:ne.CONTEXT_MENU}),L.info("context menu translate page click")):e.menuItemId===E.SHOW_ORIGIN?d(r.id,s.SHOW_ORIGIN,{scene:ne.CONTEXT_MENU}):e.menuItemId===E.DISABLE_TRANSLATE?d(r.id,s.CONTEXT_MENU_TOGGLE_SELECT_TRANSLATE,!1):e.menuItemId===E.SELECT_TRANSLATE?d(r.id,s.CONTEXT_MENU_TOGGLE_SELECT_TRANSLATE,!0):e.menuItemId===E.TRANSLATE_IMAGE&&d(r.id,s.TRANSLATE_IMAGE,{scene:"contextMenu"})}catch{}});chrome.tabs.onActivated.addListener(async e=>{const r=await chrome.tabs.get(e.tabId);if(r.url&&r.url.startsWith("http")&&r.id)try{D=await d(r.id,s.GET_PAGE_TRANSLATE_TARGET_LANGUAGE),Ae();const t=await d(r.id,s.CHECK_PAGE_TRANSLATED);Z(t.isTranslated)}catch{}});chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&t.url&&t.url.startsWith("http")&&t.id&&(Ae(),Z(!1))});const Ne=3e4,je=1e3;async function j(e,r,t){const a=await p(_.INITIAL_SERVICE),i={...r,...e,initial_service:a,feature:"plugin_translate_image",image_count_sum:1,status:"processing"};y.fireEvent(de.OVERSEA_TRANSLATE_STATUS,i,t)}async function O(e,r,t){const a=await p(_.INITIAL_SERVICE),i={...r,...e,initial_service:a,feature:"plugin_translate_image",image_count_sum:1};y.fireEvent(de.OVERSEA_TRANSLATE_STATUS,i,t)}async function Ke(e){try{const r=await fetch(e,{method:"GET"});if(!r.ok)return{success:!1,error:`HTTP ${r.status}: ${r.statusText}`};const t=await r.blob();if(t.size===0)return{success:!1,error:"Empty image data"};const a=new FileReader,i=new Promise((n,l)=>{a.onload=function(){const u=a.result;n(u)},a.onerror=function(){l(a.error)}});return a.readAsDataURL(t),{success:!0,base64Data:await i,mimeType:t.type||"image/png"}}catch(r){return{success:!1,error:(r==null?void 0:r.message)||"Failed to fetch image"}}}async function Qe(e){const r=new Promise((n,l)=>{setTimeout(()=>{l(new Error("timeout"))},Ne)});let t="image_pre_upload",a={};const i=Date.now(),o=(async()=>{var ee,te,re,ae;const n=await ge(),u=await(await fetch(e.imageUrl)).blob();let c=e.filename.split(".").pop()||"png";c==="webp"&&(c="jpg");const g=Date.now(),f={request_id:e.requestId,format:c,source_language_target_language:`auto_dect||${e.to}`},N={...f,stage:t};a=N,j(N,e.reportParams,e.userProperties);const M=await Ce({...e,fileSize:u.size,ext:c,deviceId:n}),w=M.status,m=M.result;if(w===201)return O({...N,status:"success_pre_upload",duration:Date.now()-g},e.reportParams,e.userProperties),{code:A.SUCCESS,msg:"success",data:{fileUuid:(ee=m.data)==null?void 0:ee.file_uuid}};const k=(te=m.data)==null?void 0:te.upload_url,T=(re=m.data)==null?void 0:re.file_uuid,h=((ae=m.data)==null?void 0:ae.header)||{},P=Object.fromEntries(Object.entries(h).map(([pe,Le])=>[pe,Le[0]]));if(m.code!==A.SUCCESS||!k||!T)return O({...N,status:`failed_${m.msg}`,duration:Date.now()-g},e.reportParams,e.userProperties),L.error("图片翻译任务预上传失败:",m.code,m.msg),{code:m.code,msg:m.msg};O({...N,status:"success_pre_upload",duration:Date.now()-g},e.reportParams,e.userProperties),t="image_upload";const J=Date.now(),H={...f,stage:t,file_id:T};a=H,j(H,e.reportParams,e.userProperties);const Y=await Ge(k,P,e.requestId,u);return Y.success?(O({...H,status:"success",duration:Date.now()-J},e.reportParams,e.userProperties),{code:A.SUCCESS,msg:"success",data:{fileUuid:T}}):(O({...H,status:`failed_${Y.msg}`,duration:Date.now()-J},e.reportParams,e.userProperties),{code:500,msg:Y.msg})})();try{return await Promise.race([o,r])}catch(n){const l=n&&n.message?n.message:"network_error";return O({...a,stage:t,status:`failed_${l}`,duration:Date.now()-i},e.reportParams,e.userProperties),(n==null?void 0:n.message)==="timeout"?{code:A.REQUEST_TIMEOUT,msg:"timeout"}:{code:500,msg:l}}}async function ze(e){var i;const r=Date.now(),a={...{request_id:e.requestId,format:e.filename.split(".").pop()||"png",source_language_target_language:`auto_dect||${e.to}`,file_id:e.fileUuid,translate_engine:e.translateEngine,engine_code:e.engineName},stage:"translate"};j(a,e.reportParams,e.userProperties);try{const o=await Pe({trans_engine:e.translateEngine,engine_code:e.engineName,file_uuid:e.fileUuid,file_md5:e.md5,to_lang:e.to,requestId:e.requestId},e.isVip,e.region),n=(i=o==null?void 0:o.data)==null?void 0:i.task_id;return o.code!==A.SUCCESS||!n?(L.error("图片翻译任务提交失败:",o.code,o.msg),O({...a,status:`failed_${o.msg}`,duration:Date.now()-r},e.reportParams,e.userProperties),{code:o.code,msg:o.msg}):new Promise(l=>{let u=null,c=null,g=!1;const f=(w,m)=>{g||(g=!0,c&&clearTimeout(c),u&&clearTimeout(u),O({...a,status:`${m}`,duration:Date.now()-r},e.reportParams,e.userProperties),l({code:w,msg:m}))},N=w=>{g||(g=!0,c&&clearTimeout(c),u&&clearTimeout(u),O({...a,status:"success",duration:Date.now()-r},e.reportParams,e.userProperties),l({code:A.SUCCESS,msg:"success",data:w}))};c=setTimeout(()=>{g||(L.error("图片翻译任务超时"),O({...a,status:"failed_timeout",duration:Date.now()-r},e.reportParams,e.userProperties),f(A.REQUEST_TIMEOUT,"timeout"))},Ne);const M=async()=>{var w,m,k;try{const T=await we({task_id:n,requestId:e.requestId},e.isVip,e.region),h=(w=T==null?void 0:T.data)==null?void 0:w.status;if(T.code!==0||h===void 0)return L.error("图片翻译任务查询失败:",T.code,T.msg),f(T.code,T.msg||"failed_query_job");if(h===200)return L.error("用户取消翻译"),f(h,"failed_user_cancelled");if(h>200){const P=`failed_${((m=T==null?void 0:T.data)==null?void 0:m.fail_msg)||"unknown_error"}`;return L.error("图片翻译任务失败:",h,P),f(h,P)}if(h===100){const P=(k=T.data)==null?void 0:k.result;return P?N({resultFileUrl:P.result_file_url,originalText:P.origin_text,translatedText:P.trans_text}):f(500,"failed_no_result")}g||(u=setTimeout(M,je))}catch(T){const h=`failed_${(T==null?void 0:T.message)||"unknown_error"}`;return L.error("图片翻译任务查询异常:",h),f(500,h)}};M()})}catch(o){const n=o&&o.message?o.message:"network_error";return O({...a,status:`failed_${n}`,duration:Date.now()-r},e.reportParams,e.userProperties),{code:500,msg:n}}}const R=new Map,B=(e,r,t)=>{let i=!1,o=[];return(...n)=>(l,u=!0)=>{if(o.push(l),i)return!0;if(R.has(e.name)&&u){L.info(`${e.name} from cache: `,R.get(e.name)),l(R.get(e.name));return}return i=!0,e(...n).then(c=>{L.success(`${e.name} from server: `,c),R.set(e.name,r(c))}).catch(c=>{L.error(`${e.name} server error: `,c),R.set(e.name,t())}).finally(()=>{o.forEach(c=>c(R.get(e.name))),o=[],i=!1,setTimeout(()=>{R.delete(e.name)},5e3)}),!0}},Ze=B(z,e=>{if(e.code===A.SUCCESS)return V(e.data.setting),{code:e.code,data:e.data.setting};if(e.code===A.NO_SETTING)return{code:e.code}},()=>{}),Je=B(Q,e=>{if(e.result==="ok")return e},()=>{}),et=B(me,e=>{var r,t;return e.code===A.SUCCESS?{isVip:!!((t=(r=e.data)==null?void 0:r.func_list)==null?void 0:t.some(i=>i.includes(G.permitTag)))}:{isVip:!1}},()=>({isVip:!1})),tt=B(Re,e=>e,()=>{}),rt=e=>{R.delete(e)};async function at(){if(await p(_.TEMP_CONFIGS))try{const r=await Q();let t;const a=i=>{v(s.NOTIFY_CONTENT_SETTING_CHANGE,i),V(i),be(_.TEMP_CONFIGS)};if(r.result==="ok"){const i=await z();i.code===A.SUCCESS&&(t=await se(i.data.setting),await S(`${r.userid}-${_.CONFIGS}`,t,fe),await Se(t),a(t))}else{const i=await p(_.CONFIGS,b);t=await se(i),await S(_.CONFIGS,t),a(t)}}catch{}}const nt=1e4,st=100;async function it(e){const t=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map(n=>n.toString(16).padStart(2,"0")).join("")}async function he(){const e=await Ue();if(!(!e||e.protocol!=="https:"))return it(`${e.host}${e.pathname}`)}async function ot(e,r){const t=await p(_.SITE_SOURCE_LANGUAGE,{}),a=await he();if(a){if(t[a])r?delete t[a]:t[a]=e;else{const i=Object.keys(t);i.length>=nt&&i.splice(0,st).forEach(o=>{delete t[o]}),t[a]=e}await S(_.SITE_SOURCE_LANGUAGE,t)}}async function ct(){const e=await p(_.SITE_SOURCE_LANGUAGE,{}),r=await he();return r&&e[r]||""}const x=new Map,ut={[s.SCREEN_SHOT]:(e,r,t)=>{var i;const a=(i=r.tab)==null?void 0:i.windowId;if(a)return chrome.tabs.captureVisibleTab(a,{format:"png"},o=>{const n=performance.now();if(chrome.runtime.lastError){t({result:le.FAIL,data:`${chrome.runtime.lastError}`,time:n});return}t({result:le.SUCCESS,data:o,time:n})}),!0},[s.GET_USER_SETTINGS]:(e,r,t)=>(Ze()(t,!$(r.url)),!0),[s.CHANGE_USER_SETTINGS]:(e,r,t)=>(Se(e).then(a=>{a.code===A.SUCCESS?t(!0):t(!1)}).catch(()=>{t(!1)}).finally(()=>{rt("getUserConfig")}),!0),[s.NOTIFY_EXTENSION_SETTING_CHANGE]:(e,r)=>{var a;V(e);const t=(a=r.tab)!=null&&a.id?[r.tab.id]:[];v(s.NOTIFY_CONTENT_SETTING_CHANGE,e,t)},[s.NOTIFY_IFRAME_SETTING_CHANGE]:(e,r)=>{var a;const t=(a=r.tab)==null?void 0:a.id;t&&d(t,s.NOTIFY_IFRAME_SETTING_CHANGE,e)},[s.SET_OTHER_TABS_TRANSLATE_PAGE_STYLE]:(e,r)=>{var a;const t=(a=r.tab)!=null&&a.id?[r.tab.id]:[];v(s.SET_TRANSLATE_PAGE_STYLE,e,t)},[s.NOTIFY_NO_LOGIN_LOCALE_CHANGE]:(e,r)=>{var a;const t=(a=r.tab)!=null&&a.id?[r.tab.id]:[];v(s.NOTIFY_NO_LOGIN_LOCALE_CHANGE,e,t)},[s.STORE_WEB_SOURCE_LANGUAGE]:e=>{ot(e.language,e.isAuto)},[s.GET_WEB_SOURCE_LANGUAGE]:(e,r,t)=>(ct().then(a=>{t(a)}),!0),[s.GET_USER_INFO]:(e,r,t)=>(Je()(t,!$(r.url)),!0),[s.GET_USER_PERMIT_INFO]:(e,r,t)=>(et(e)(t,!$(r.url)),!0),[s.DETECT_PAGE_LANGUAGE]:(e,r,t)=>(ce().then(a=>{const i=$e.find(o=>o.value===a);t(i?a:G.defaultSourceLanguage)}).catch(()=>{t(G.defaultSourceLanguage)}),!0),[s.DETECT_TEXT_LANGUAGE]:(e,r,t)=>(He(e).then(a=>{const i=Te(a);t(i?i.value:G.defaultSourceLanguage)}).catch(()=>{t(G.defaultSourceLanguage)}),!0),[s.OPEN_POPUP]:()=>{chrome.action.openPopup()},[s.NOTIFY_EXTENSION_LOGIN_STATE]:(e,r)=>{var a;const t=(a=r.tab)!=null&&a.id?[r.tab.id]:void 0;v(s.NOTIFY_CONTENT_LOGIN_STATE,e,t)},[s.TRANSLATE_TEXT]:(e,r,t)=>(Be(e).then(a=>{t(a)}).catch(a=>{t({code:500,msg:a&&a.message?a.message:"network_error"})}),!0),[s.CHAT_COMPLETIONS]:(e,r)=>{var a;const t=(a=r.tab)==null?void 0:a.id;if(t){let i=ue[F.EXPLAIN];e.translateType===F.IMPROVE_WRITE&&(i=ue[F.IMPROVE_WRITE]),Fe(e.input,e.engineCode,e.targetLanguage,async(o,n)=>{const l=e.translateType,u=e.requestId;if(o)if(n&&typeof n=="object")try{await d(t,s.CHAT_COMPLETIONS_RESPONSE,{done:o,response:n,requestId:u,translateType:l,reportParams:e.reportParams})}catch{}else await d(t,s.CHAT_COMPLETIONS_RESPONSE,{done:o,requestId:u,translateType:l,reportParams:e.reportParams});else{let c="";typeof n=="string"&&(c=n);try{await d(t,s.CHAT_COMPLETIONS_RESPONSE,{done:o,result:c,requestId:u,translateType:l,reportParams:e.reportParams})}catch{}return}},e.scene,e.component,i,e.requestId)}},[s.CHANGE_CONTEXT_MENU_BY_SETTING]:e=>{V(e)},[s.CHANGE_CONTEXT_MENU_BY_TRANSLATE_STATUS]:e=>{Z(e)},[s.GET_POPUP_PERFORMANCE_NOW]:(e,r,t)=>{t(performance.now())},[s.GET_ONLINE_PARAMS]:(e,r,t)=>(tt()(t,!$(r.url)),!0),[s.CLOSE_HOVER_BALL_ONBOARDING]:(e,r)=>{var a;const t=(a=r.tab)!=null&&a.id?[r.tab.id]:void 0;v(s.CLOSE_HOVER_BALL_ONBOARDING,void 0,t)},[s.GET_DEVICE_ID]:(e,r,t)=>(ge().then(a=>{t(a)}),!0),[s.FIRE_EVENT]:e=>{y.fireEvent(e.eventName,e.params,e.userProperties)},[s.GET_COOKIE_LANGUAGE]:(e,r,t)=>(Ie().then(a=>{t(a)}),!0),[s.GET_TAB_INFO]:(e,r,t)=>(chrome.windows.getCurrent(a=>{var o;const i=(o=r.tab)==null?void 0:o.windowId;t({windowId:i,isWindowActive:i===a.id})}),!0),[s.UPDATE_CONTEXT_MENU_BY_TARGET_LANGUAGE]:e=>{qe(e)},[s.DETECT_SYSTEM_LANGUAGE]:(e,r,t)=>{t(chrome.i18n.getUILanguage())},[s.OPEN_NEW_PAGE]:(e,r,t)=>(chrome.tabs.create({url:e.url},()=>{chrome.runtime.lastError?t(!1):t(!0)}),!0),[s.GET_PDF_FILE_CONTENT]:(e,r)=>{var a;const t=(a=r.tab)==null?void 0:a.id;t&&fetch(e.url).then(async i=>{const o=await i.arrayBuffer(),n=Math.ceil(o.byteLength/X);if(o.byteLength>xe){await d(t,s.PDF_FILE_GET_ERROR,{errorType:"overSize",fileName:e.url});return}for(let u=0;u<n;u++){if(!await De(t))return;const g=u*X,f=Math.min(g+X,o.byteLength),N=o.slice(g,f),M=new Uint8Array(N);await d(t,s.PDF_FILE_CHUNK,{data:Array.from(M),chunkIndex:u,totalChunks:n,fileName:e.url}),await ke(10)}await d(t,s.PDF_FILE_CHUNK_DONE,{fileName:e.url})}).catch(i=>{d(t,s.PDF_FILE_GET_ERROR,{errorType:"unknown",fileName:e.url})})},[s.GET_LOGIN_URL]:(e,r,t)=>{const a=`${s.GET_LOGIN_URL}`,i="com.wps.anydocextension",o={action:"get_redirect_url",params:{url:"https://www.wps.com/"}};if(!x.get(a))return x.set(a,!0),oe(i,o).then(n=>{var l,u,c;((l=n==null?void 0:n.response)==null?void 0:l.code)===200?t({code:200,url:q(n.response.redirect_url)}):t({code:(u=n==null?void 0:n.response)==null?void 0:u.code,errorMsg:q((c=n==null?void 0:n.response)==null?void 0:c.error_msg)})}).catch(n=>{t({code:-100,errorMsg:(n==null?void 0:n.message)||"unknown"})}).finally(()=>{x.delete(a)}),!0},[s.GET_PAGE_LANGUAGE]:(e,r,t)=>(ce().then(a=>{t(a)}).catch(()=>{t(void 0)}),!0),[s.CONTENT_SCRIPT_TRANSLATE_PAGE]:(e,r)=>{var a;const t=(a=r.tab)==null?void 0:a.id;t&&(e.translate?d(t,s.TRANSLATE_PAGE,{scene:e.scene}):d(t,s.SHOW_ORIGIN,{scene:e.scene}))},[s.SET_IFRAME_TRANSLATE_PAGE_STYLE]:(e,r)=>{var a;const t=(a=r.tab)==null?void 0:a.id;t&&d(t,s.SET_TRANSLATE_PAGE_STYLE,e)},[s.GET_WPS_CLIENT_INFO]:(e,r,t)=>{const a=`${s.GET_WPS_CLIENT_INFO}`,i="com.wps.anydocextension",o={action:"get_info",params:{from:e.from}};if(!x.get(a))return x.set(a,!0),oe(i,o).then(n=>{var l,u,c,g,f,N;((l=n==null?void 0:n.response)==null?void 0:l.code)===200?t({code:200,data:{deviceId:(u=n==null?void 0:n.response)==null?void 0:u.device_id,exe_version:(c=n==null?void 0:n.response)==null?void 0:c.exe_version,host_version:(g=n==null?void 0:n.response)==null?void 0:g.host_version}}):t({code:(f=n==null?void 0:n.response)==null?void 0:f.code,errorMsg:q(((N=n==null?void 0:n.response)==null?void 0:N.error_msg)||"")})}).catch(n=>{t({code:-100,errorMsg:(n==null?void 0:n.message)||"unknown"})}).finally(()=>{x.delete(a)}),!0},[s.GET_IMAGE_TRANSLATE_COUNT]:(e,r,t)=>(e.isVip?ve().then(a=>{var n;const o=(((n=a.data)==null?void 0:n.summary)||[]).find(l=>l.component===ie[F.IMAGE]);t(o==null?void 0:o.available_count)}).catch(()=>{t(void 0)}):ye().then(a=>{var n;const o=(((n=a.data)==null?void 0:n.benefits)||{})[ie[F.IMAGE]];t(o==null?void 0:o.count)}).catch(()=>{t(void 0)}),!0),[s.TRANSLATE_IMAGE_REQUEST]:(e,r,t)=>(ze(e).then(a=>{t(a)}).catch(a=>{t({code:500,msg:a&&a.message?a.message:"network_error"})}),!0),[s.UPLOAD_IMAGE_REQUEST]:(e,r,t)=>(Qe(e).then(a=>{t(a)}).catch(a=>{t({code:500,msg:a&&a.message?a.message:"network_error"})}),!0),[s.GET_WEB_IMAGE_CONTENT]:(e,r,t)=>(Ke(e.imageUrl).then(a=>{t(a)}),!0),[s.GET_GEO_INFO]:(e,r,t)=>(p(_.GEO_INFO).then(a=>{a?t(a):Me().then(i=>{i?(S(_.GEO_INFO,i),t(i)):t({})})}).catch(()=>{t({})}),!0)};function lt(e){e.onDisconnect.addListener(()=>{at()})}function _t(e){e.onDisconnect.addListener(()=>{})}function Et(){chrome.runtime.onConnect.addListener(e=>{switch(e.name){case _e.POP_UP:lt(e);break;case _e.INJECTION:_t(e);break}}),chrome.runtime.onMessage.addListener((e,r,t)=>{const a=ut[e.type];if(a)return a(e.data,r,t)}),chrome.runtime.onMessageExternal.addListener((e,r,t)=>{e.action==="ping"&&t({pong:!0})}),chrome.windows.onFocusChanged.addListener(e=>{v(s.CURRENT_ACTIVE_WINDOW,e)})}function Tt(){return(chrome.runtime.getManifest().content_scripts||[]).flatMap(a=>a.js)}function gt(){Ve().then(e=>{e.forEach(r=>{var t;if(!(!r||!r.id||!((t=r.url)!=null&&t.startsWith("http"))))try{chrome.scripting.executeScript({target:{tabId:r.id},files:Tt(),injectImmediately:!0})}catch{}})})}async function dt(){const e=await p(_.ON_BOARDING_TIME),r=await p(_.INSTALL_SOURCE),t=await We(G.mainPage);e||(chrome.tabs.create({url:`${t}?utm_source=${r}&source=web_plugin_activate_guide`}),S(_.ON_BOARDING_TIME,Date.now()))}async function mt(){var r,t,a,i;const e={};try{const o=await Q(),n=await Ie();if(n&&(b.interfaceLanguage=K(n).value),o.result==="ok"){const u=(t=(r=(await me({uid:o.userid})).data)==null?void 0:r.func_list)==null?void 0:t.some(g=>g.includes(G.permitTag));o.isVip=u,e.userInfo=o,S(_.USER_INFO,e.userInfo);const c=await z();c.code===A.SUCCESS?(e.userConfig=c.data.setting,S(`${(a=e.userInfo)==null?void 0:a.userid}-${_.CONFIGS}`,e.userConfig,fe)):e.userConfig=await p(`${(i=e.userInfo)==null?void 0:i.userid}-${_.CONFIGS}`,b)}else e.userInfo=void 0,e.userConfig=await p(_.CONFIGS,b),e.userConfig.interfaceLanguage=b.interfaceLanguage}catch{e.userInfo=void 0,e.userConfig=await p(_.CONFIGS,b)}return e}async function ft(){try{const e=await chrome.cookies.get({url:`https://${G.webHost}`,name:"downloadPluginSource"});return(e==null?void 0:e.value)||""}catch(e){return y.fireErrorEvent({type:"getInstallSourceError",message:e instanceof Error?e.message:String(e)}),""}}async function St(e){const r=await ft();if(r){await S(_.INSTALL_SOURCE,r);return}switch(e.reason){case"install":await S(_.INSTALL_SOURCE,"plugin_install");break;case"update":await S(_.INSTALL_SOURCE,"plugin_update");break;case"chrome_update":await S(_.INSTALL_SOURCE,"plugin_chrome_update");break;default:await S(_.INSTALL_SOURCE,"plugin_other")}}async function It(e){var r,t,a,i;y.setReportUserProperties({is_member:(r=e.userInfo)!=null&&r.isVip?1:0,is_login:e.userInfo?1:0,userid:String(((t=e.userInfo)==null?void 0:t.userid)||"0"),account_type:(i=(a=e.userInfo)==null?void 0:a.email)!=null&&i.endsWith("@gmail.com")?"google":"email"}),y.fireEvent("oversea_plugin_installed",{interface_language:e.userConfig.interfaceLanguage})}async function At(){chrome.runtime.onInstalled.addListener(async e=>{gt();let r=b;try{await St(e),await y.init();const t=await mt();It(t),r=t.userConfig,await S(_.INTERFACE_LOCALE,r.interfaceLanguage)}catch{}finally{dt(),Ye(r)}}),Et(),chrome.runtime.setUninstallURL(G.uninstallPage)}At();
