const SearchEngine=class{constructor(a,b){this.defaultTimeout=3e3,this.originalQuery=a,this.query=a,this.q=encodeURIComponent(this.query),this.cb=b,this.items=[],this.config=[],this.datMusicCalled=0,this.isLastChanceGiven=!1,chrome.storage.sync.get(a=>(this.config=a.config||{},this.config.providers?void(this.providers=this.config.providers.sort((a,b)=>"datmusic"===b.name?-1:0),this.runProvider(0)):this.cb(this.items)))}runProvider(a=0){grafy("PROV_RUN",1);const b=this.providers[a];if(b){if(!b.enabled)return this.runProvider(a+1);if("undefined"==typeof this[b.name])return this.runProvider(a+1);this[b.name](b,()=>(grafy("PROV_FAILED_"+b.name.toUpperCase(),1),this.runProvider(a+1)))}else return grafy("PROV_FAILED_ALL",1),this.items.length?(this.cb(this.items),!1):this.items.length||this.isLastChanceGiven?(this.cb(this.items),!1):this.giveMeLastChance()}giveMeLastChance(){return this.isLastChanceGiven=!0,this.query=this.query.replace(/\(.+\)/g,"").trim(),this.items=[],this.q=encodeURIComponent(this.query),this.runProvider()}datmusic(a,b){this.datMusicCalled++;const c=a.pattern.replace("{KEYWORD}",this.q);let d=new XMLHttpRequest;d.timeout=2*this.defaultTimeout,d.open("GET",c,!0),d.ontimeout=()=>{b()},d.onerror=()=>b(),d.onload=()=>{try{if(200!==d.status&&!this.items.length)return 2>this.datMusicCalled?this.datmusic(a,b):b();const c=JSON.parse(d.responseText);if("ok"!==c.status)return void b();const e=c.data.map(a=>({url:a.download,name:a.artist+" - "+a.title}));this.items=this.items.concat(e);const f=this.checkResult(e);f?this.cb([f]):b()}catch(a){b()}},d.send()}freemp3(a,b){const c=a.pattern;let d=new XMLHttpRequest;d.open("POST",c,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.timeout=this.defaultTimeout,d.onerror=()=>b(),d.onload=()=>{try{if(200!==d.status)return void b();const a=JSON.parse(d.responseText.replace(/^[^\(]+\((.*)\);$/i,"$1"));if(1>a.response.length)return void b();const c=a.response.filter(a=>a.url).map(a=>({url:a.url,name:a.artist+" - "+a.title,vkDecode:!!(-1<a.url.indexOf("extra="))}));this.items=this.items.concat(c);const e=this.checkResult(c);e?this.cb([e]):b()}catch(a){b()}},d.ontimeout=()=>{b()},d.send("q="+this.query)}cooldj(a,b){const c=a.pattern.replace("{KEYWORD}",this.q);var d=new XMLHttpRequest;d.open("GET",c,!0),d.timeout=this.defaultTimeout,d.onerror=()=>b(),d.onload=()=>{if(200!==d.status)return void b();try{const a=[],c=d.responseText.match(/<ul class="playlist">([\s\S]+?)<\/ul>/g)[0],e=c.match(/<li class="track"[\s\S]+?>([\s\S]+?)<\/li>/g);e.forEach(b=>{const c=b.match(/<a href="([^"]+)" class="playlist-btn-down no-ajaxy cu-exclude" title="[^"]+" target="_blank">/i),d=b.match(/<em><a href="[\s\S]+?">([\s\S]+?)<\/a><\/em>/i);c&&d&&a.push({url:c[1],name:d[1]})}),this.items=this.items.concat(a);const f=this.checkResult(a);f?this.cb([f]):b()}catch(a){b()}},d.ontimeout=()=>{b()},d.send()}zkfm(a,b){const c=a.pattern.replace("{KEYWORD}",this.q);var d=new XMLHttpRequest;d.open("GET",c,!0),d.timeout=this.defaultTimeout,d.onerror=()=>b(),d.onload=()=>{if(200!==d.status)return void b();const a=d.responseText.match(/<ul class="song-menu">[\s\S]+?<\/ul>/g);if(!a)return void b();const c=a.filter(a=>a.includes("btn4")),e=[];c.forEach(a=>{try{const b=a.match(/data-sid="(\d+?)"/)[1],c=a.match(/data-title="(.+?)"/)[1];e.push({url:"http://z1.fm/download/"+b,name:c})}catch(a){console.error("failed parse zk.fm res",a)}}),this.items=this.items.concat(e);const f=this.checkResult(e);f?this.cb([f]):b()},d.ontimeout=()=>{b()},d.send()}mp3cc(a,b){const c=`http://mp3cc.com/search/f/${this.q}/`;var d=new XMLHttpRequest;d.open("GET",c,!0),d.onerror=()=>b(),d.onload=()=>{if(200!==d.status)return void b();const a=d.responseText.match(/<li class="track"[\s\S]+?<\/li>/g);if(!a)return void this.cb(null);const c=[];a.forEach(a=>{try{const b=a.match(/data-mp3="(.+?)"/)[1],d=a.match(/<b><.+?>(.+?)<\/a>/)[1],e=a.match(/<em><.+?>(.+?)<\/a>/)[1];c.push({url:"http://mp3cc.com/"+b,name:d+" - "+e})}catch(a){console.error("failed parse mp3cc.com res",a)}}),this.items=this.items.concat(c);const e=this.checkResult(c);e?this.cb([e]):b()},d.send()}checkResult(a){return a.find(a=>this.compareNames(a.name,this.originalQuery))}decodeHtmlEntities(a){return a.replace(/&amp;/g,"&").replace(/&quot;/g,"\"").replace(/&apos;/g,"'").replace(/&#(\d+);/g,function(a,b){return String.fromCharCode(b)})}compareNames(a,b){const c=a=>this.decodeHtmlEntities(a).toLowerCase().replace(/[^\w\u0430-\u044f]+/ig,"").replace("feat",""),d=c(a),e=c(b);return d===e}};