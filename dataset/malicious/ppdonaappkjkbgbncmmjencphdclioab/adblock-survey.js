SURVEY=function(){var i="",o=function(i){if(SAFARI){var o=safari||{};o=(o=o.application||{}).activeBrowserWindow||{},i(o.activeTab)}else chrome.tabs.query({active:!0,currentWindow:!0},(function(o){i(o[0])}))},e=function(i){return!(!SAFARI&&(i.incognito||"complete"!==i.status))&&/^http:/.test(i.url)},t=function(n){var c=function(){setTimeout((function(){t(n)}),3e5)};chrome&&chrome.notifications&&chrome.notifications.getPermissionLevel&&chrome.notifications.getPermissionLevel((function(t){if("granted"===t){if(isNaN(n.block_count_limit))return void log("invalid block_count_limit",n.block_count_limit);n.block_count_limit=Number(n.block_count_limit),chrome.idle.queryState(60,(function(t){var a;"active"===t?(a=function(t){t>=n.block_count_limit?o((function(o){o&&e(o)?r(n,(function(o){if(i=Math.floor(3e3*Math.random()).toString(),o){if(newSurveyData=s(JSON.stringify(o)),newSurveyData.survey_id!==n.survey_id)return void recordGeneralMessage("survey_ids_do_not_match",void 0,{original_sid:n.survey_id,updated_sid:newSurveyData.survey_id});n=newSurveyData}if(n.notification_options&&n.notification_options.type&&n.notification_options.message&&n.notification_options.icon_url&&!isNaN(n.notification_options.priority)){var e={title:n.notification_options.title,iconUrl:n.notification_options.icon_url,type:n.notification_options.type,priority:n.notification_options.priority,message:n.notification_options.message};n.notification_options.context_message&&(e.contextMessage=n.notification_options.context_message),n.notification_options.require_interaction&&(e.requireInteraction=n.notification_options.require_interaction),n.notification_options.is_clickable&&(e.isClickable=n.notification_options.is_clickable);var t=function(o){chrome.notifications.onClicked.removeListener(t),chrome.notifications.onButtonClicked.removeListener(r),chrome.notifications.onClosed.removeListener(c),o===i&&n.notification_options.clicked_url?recordGeneralMessage("notification_clicked",void 0,{sid:n.survey_id}):recordGeneralMessage("notification_clicked_no_URL_to_open",void 0,{sid:n.survey_id})},r=function(o,e){chrome.notifications.onClicked.removeListener(t),chrome.notifications.onButtonClicked.removeListener(r),chrome.notifications.onClosed.removeListener(c),n.notification_options.buttons&&(o===i&&0===e&&recordGeneralMessage("button_0_clicked",void 0,{sid:n.survey_id}),o===i&&1===e&&recordGeneralMessage("button_1_clicked",void 0,{sid:n.survey_id}))},c=function(i,o){chrome.notifications.onButtonClicked.removeListener(r),chrome.notifications.onClicked.removeListener(t),chrome.notifications.onClosed.removeListener(c),recordGeneralMessage("notification_closed",void 0,{sid:n.survey_id,bu:o})};if(chrome.notifications.onClicked.removeListener(t),chrome.notifications.onClicked.addListener(t),n.notification_options.buttons){var a=[];n.notification_options.buttons[0]&&a.push({title:n.notification_options.buttons[0].title,iconUrl:n.notification_options.buttons[0].icon_url}),n.notification_options.buttons[1]&&a.push({title:n.notification_options.buttons[1].title,iconUrl:n.notification_options.buttons[1].icon_url}),e.buttons=a}chrome.notifications.onButtonClicked.removeListener(r),chrome.notifications.onButtonClicked.addListener(r),chrome.notifications.onClosed.addListener(c),chrome.notifications.create(i,e,(function(i){if(chrome.runtime.lastError)return recordGeneralMessage("error_survey_not_shown",void 0,{sid:n.survey_id}),chrome.notifications.onButtonClicked.removeListener(r),chrome.notifications.onClicked.removeListener(t),void chrome.notifications.onClosed.removeListener(c);recordGeneralMessage("survey_shown",void 0,{sid:n.survey_id})}))}else recordGeneralMessage("invalid_survey_data",void 0,{sid:n.survey_id})})):c()})):c()},ext.pages.query({active:!0,lastFocusedWindow:!0},(function(i){if(0!==i.length){page=i[0];var o=require("stats").getBlockedPerPage(page);a(o)}}))):c()}))}}))},n=function(i){o((function(o){o&&e(o)?function(o){r(i,(function(){var e={command:"showoverlay",overlayURL:i.open_this_url,tabURL:o.url},t=function(i){chrome.runtime.lastError?chrome.runtime.lastError.message?recordErrorMessage("overlay_message_error ",void 0,{errorMessage:chrome.runtime.lastError.message}):recordErrorMessage("overlay_message_error ",void 0,{error:JSON.stringify(chrome.runtime.lastError)}):i&&i.ack===e.command||recordErrorMessage("invalid_response_from_notification_overlay_script",void 0,{response:i})};SAFARI?chrome.extension.sendRequest(e,t):chrome.tabs.sendRequest(o.id,e,t)}))}(o):setTimeout((function(){n(i)}),3e5)}))},r=function(i,o){var e={cmd:"survey",u:STATS.userId(),sid:i.survey_id};"E"===STATS.flavor&&Prefs.blocked_total&&(e.b=Prefs.blocked_total)},s=function(i){if(0===i.length||0===i.trim().length)return null;try{var o=JSON.parse(i);if(!o)return}catch(i){return null}return o};return{maybeSurvey:function(i){if(!1!==getSettings().show_survey){var o=s(i);o&&("overlay"===o.type?n(o):"tab"===o.type?function(i){var o=function(){setTimeout((function(){r(i,(function(i){}))}),1e4)},e=function(){chrome.tabs.onCreated.removeListener(e),o()};chrome.idle.queryState(60,(function(i){"active"===i?o():(chrome.tabs.onCreated.removeListener(e),chrome.tabs.onCreated.addListener(e))}))}(o):"notification"===o.type&&t(o))}},types:function(i){chrome&&chrome.notifications&&chrome.notifications.getPermissionLevel?chrome.notifications.getPermissionLevel((function(o){i("granted"===o?"OTN":"OT")})):i("OT")}}}();