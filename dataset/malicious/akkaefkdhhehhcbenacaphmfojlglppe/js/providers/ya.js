const YAProvider=class{constructor(a){this.c=a,this.code="ya",this.urlInfo=this.getUrlInfo(location.href),this.domain=location.host.split(".").pop(),this.options={headers:{"X-Retpath-Y":encodeURIComponent("https://music.yandex.ru/")},redirect:"error",credentials:"include"},this.setSongsCount(),chrome.runtime.onMessage.addListener(a=>{"pageUpdated"===a.action&&(chrome.runtime.sendMessage({action:"setBadge",value:0}),this.getPageData().then(a=>{const b=this.makeItems(a);chrome.runtime.sendMessage({action:"setBadge",value:b.length})}).catch(a=>console.log(a)))})}getUrlInfo(a){const b={isMusic:!1,isRadio:!1,isPlaylist:!1,isTrack:!1,isAlbum:!1,isArtist:!1,isLabel:!1,isUserFavoriteMusic:!1};if(!a)return b;const c=new URL(a),d=c.pathname.split("/"),e=c.hostname.match(/^music\.yandex\.(ru|by|kz|ua)$/),f=c.hostname.match(/^radio\.yandex\.(ru|by|kz|ua)$/);return(e?b.isMusic=!0:f&&(b.isRadio=!0),!b.isMusic)?b:(b.isPlaylist=5===d.length&&"users"===d[1]&&"playlists"===d[3],b.isTrack=5===d.length&&"album"===d[1]&&"track"===d[3],b.isAlbum=3===d.length&&"album"===d[1],b.isArtist=2<d.length&&"artist"===d[1],b.isLabel=2<d.length&&"label"===d[1],b.isUserFavoriteMusic=4===d.length&&"users"===d[1]&&["tracks","playlists","artists","albums"].includes(d[3]),b.isPlaylist?(b.username=d[2],b.playlistId=d[4]):b.isTrack?(b.trackId=d[4],b.albumId=d[2]):b.isAlbum?b.albumId=d[2]:b.isArtist?b.artistId=d[2]:b.isLabel?b.labelId=d[2]:b.isUserFavoriteMusic&&(b.userName=d[2],b.mode=d[3]),b)}getItems(a){chrome.runtime.sendMessage({action:"setBadge",value:0}),this.getPageData().then(b=>{const c=this.makeItems(b);chrome.runtime.sendMessage({action:"setBadge",value:c.length}),a(c)}).catch(()=>a([]))}async getPageData(){this.urlInfo=this.getUrlInfo(location.href);let a=[];if(this.urlInfo.isPlaylist){let b=await this.getPlaylist(this.urlInfo.username,this.urlInfo.playlistId);a=[b.tracks]}else if(this.urlInfo.isTrack){let b=await this.getTrack(this.urlInfo.trackId,this.urlInfo.albumId);a=[b.track]}else if(this.urlInfo.isAlbum){let b=await this.getAlbum(this.urlInfo.albumId),c=b.volumes;for(let c=0;c<b.volumes.length;c++)a=a.concat(b.volumes[c])}else if(this.urlInfo.isArtist){let b=await this.getArtist(this.urlInfo.artistId);a=b.tracks}else if(this.urlInfo.isLabel){let b=await this.getLabel(this.urlInfo.labelId,this.urlInfo.page);a=b.tracks}else if(this.urlInfo.isUserFavoriteMusic){let b=await this.getUserFavoriteMusic(this.urlInfo.userName,this.urlInfo.mode);a=b}return a}makeItems(a=[]){return this.urlInfo.isPlaylist&&(a=a[0]),a.map(a=>{const b=a.artists.map(b=>b.name).join(",");return{id:a.id,name:b?`${b} - ${a.title}`:a.title,pr:this.code}})}setSongsCount(){this.getItems(a=>{const b=a.length;chrome.runtime.sendMessage({action:"setBadge",value:b})})}get baseUrl(){return`https://music.yandex.${this.domain}`}async getUserFavoriteMusic(a,b){if("tracks"===b){const b=`${this.baseUrl}/handlers/library.jsx?owner=${a}&filter=tracks&likeFilter=favorite&sort=&dir=&lang=uk&external-domain=/music.yandex.${this.domain}&overembed=false`,c=await fetch(b,this.options).then(this.parseJsonResponse);return c.tracks}if("playlists"===b){const b=`${this.baseUrl}/handlers/library.jsx?owner=${a}&filter=playlists&likeFilter=favorite&sort=&dir=&lang=uk&external-domain=/music.yandex.${this.domain}&overembed=false`,c=await fetch(b,this.options).then(this.parseJsonResponse),d=await Promise.all(c.playlists.map(a=>this.getPlaylist(a.owner.login,a.kind)));return d.reduce((a,{tracks:b})=>[...a,...b],[])}if("artists"===b){const b=`${this.baseUrl}/handlers/library.jsx?owner=${a}&filter=artists&likeFilter=favorite&sort=&dir=&lang=uk&external-domain=/music.yandex.${this.domain}&overembed=false`,c=await fetch(b,this.options).then(this.parseJsonResponse),d=await Promise.all(c.artists.map(a=>this.getArtist(a.id)));return d.reduce((a,{tracks:b})=>[...a,...b],[])}if("albums"===b){const b=`${this.baseUrl}/handlers/library.jsx?owner=${a}&filter=albums&likeFilter=favorite&sort=&dir=&lang=uk&external-domain=/music.yandex.${this.domain}&overembed=false`,c=await fetch(b,this.options).then(this.parseJsonResponse),d=c.albums,e=await Promise.all(d.map(a=>this.getAlbum(a.id).then(a=>a.volumes[0])));return e.reduce((a,b)=>[...a,...b],[])}return[]}getTrack(a,b){const c=`${this.baseUrl}/handlers/track.jsx?track=${a}%3A${b}`;return fetch(c,this.options).then(this.parseJsonResponse)}getArtist(a){const b=`${this.baseUrl}/handlers/artist.jsx?artist=${a}&what=tracks&external-domain=music.yandex.${this.domain}&overembed=false`;return fetch(b,this.options).then(a=>this.parseJsonResponse(a)).then(a=>{const b=[...a.albums,...(a.alsoAlbums||[])];return Promise.all(b.map(a=>this.getAlbum(a.id).then(a=>a.volumes[0])))}).then(a=>a.reduce((a,b)=>[...a,...b],[])).then(a=>uniqueBy(a,({id:a})=>a)).then(a=>({tracks:a}))}getAlbum(a){const b=`${this.baseUrl}/handlers/album.jsx?album=${a}&external-domain=/music.yandex.${this.domain}&overembed=false`;return fetch(b,this.options).then(this.parseJsonResponse)}getPlaylist(a,b){const c=`${this.baseUrl}/handlers/playlist.jsx?owner=${a}&kinds=${b}&external-domain=/music.yandex.${this.domain}&overembed=false`;return fetch(c,this.options).then(this.parseJsonResponse).then(a=>a.playlist)}getLabel(a,b){let c=`${this.baseUrl}/handlers/label.jsx?sort=year&id=${a}&external-domain=/music.yandex.${this.domain}&overembed=false`;return void 0!==b&&(c+=`&page=${b}`),fetch(c,this.options).then(this.parseJsonResponse)}parseJsonResponse(a){if(!a.ok)throw new Error(`${a.status} (${a.statusText})`);return a.json()}async getYAAudioSrc(a){const b=`${this.baseUrl}/api/v2.1/handlers/track/${a}/track/download/m?hq=1`,c=await this.parseJsonResponse(await fetch(b,this.options)),d=await this.parseJsonResponse(await fetch(`${c.src}&format=json`)),e=md5("XGRlBW9FXlekgbPrRHuSiA"+d.path.substr(1)+d.s);return`https://${d.host}/get-mp3/${e}/${d.ts+d.path}`}};function uniqueBy(a=[],b){const c=new Set;return a.filter(d=>{const e=b(d,a);return!c.has(e)&&(c.add(e),!0)})}