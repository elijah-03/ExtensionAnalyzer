DataCollectionV2=function(){"use strict";const{extractHostFromFrame:t}=require("url"),{RegExpFilter:e,WhitelistFilter:r,ElemHideFilter:i}=require("filterClasses");var s="timeLastPush",o={filters:{},domains:{}},n=function(t,e,r){if(chrome.runtime.lastError)return;if(!r||!r.url)return;let i=parseUri(r.url);"http:"!==i.protocol&&"https:"!==i.protocol||getSettings().data_collection_v2&&!adblockIsPaused()&&"loading"===e.status&&chrome.tabs.executeScript(t,{file:"adblock-datacollection-contentscript.js",allFrames:!0,runAt:"document_idle"},(function(){chrome.runtime.lastError}))},a=function(){port.on("datacollection.elementHide",((e,r)=>{if(getSettings().data_collection_v2&&!adblockIsPaused()){var s=e.selectors,o=e.filters,n=t(r.frame);for(let t of FilterStorage.subscriptions)if(!t.disabled)for(let e of t.filters){(e instanceof i&&s.includes(e.selector)&&e.isActiveOnDomain(n)||o.includes(e.text))&&f(e,r.page)}}}))},l=function(t){if(t.url&&"main_frame"===t.type&&!adblockIsPaused()){var e=parseUri(t.url).host;o.domains[e]||(o.domains[e]={},o.domains[e].pages=0),o.domains[e].pages++}},f=function(t,e){if(t&&t.text&&"string"==typeof t.text&&e&&e.url){var r=parseUri(e.url).host;if(!r)return;var i=t.text;i in o.filters||(o.filters[i]={},o.filters[i].firstParty={},o.filters[i].thirdParty={},o.filters[i].subscriptions=[]),t.thirdParty?(o.filters[i].thirdParty[r]||(o.filters[i].thirdParty[r]={},o.filters[i].thirdParty[r].hits=0),o.filters[i].thirdParty[r].hits++):(o.filters[i].firstParty[r]||(o.filters[i].firstParty[r]={},o.filters[i].firstParty[r].hits=0),o.filters[i].firstParty[r].hits++),t.subscriptions&&t.subscriptions.length>0&&t.subscriptions.forEach((function(t){t.url&&-1===o.filters[i].subscriptions.indexOf(t.url)&&o.filters[i].subscriptions.push(t.url)}))}},u=function(t,e,r,i){getSettings().data_collection_v2&&!adblockIsPaused()?f(t,i):FilterNotifier.removeListener(u)};_settings.onload().then((function(){getSettings().data_collection_v2&&(window.setInterval((function(){idleHandler.scheduleItemOnce((function(){if(getSettings().data_collection_v2&&Object.keys(o.filters).length>0){var t=[],e=getAllSubscriptionsMinusText();for(var r in e)e[r].subscribed&&t.push(e[r].url);getUserFilters()&&t.push("customlist");var i={version:"4",addonName:require("info").addonName,addonVersion:require("info").addonVersion,application:require("info").application,applicationVersion:require("info").applicationVersion,platform:require("info").platform,platformVersion:require("info").platformVersion,appLocale:Utils.appLocale,filterListSubscriptions:t,domains:o.domains,filters:o.filters};ext.storage.get(s,(function(t){var e="n/a";if(t.timeLastPush){var r=new Date(t.timeLastPush),n=r.getUTCFullYear()+"",a=r.getUTCMonth()+1+"",l=r.getUTCDate()+"",f=r.getUTCHours()+"",u=10*Math.floor(r.getUTCMinutes()/10)+"";1===a.length&&(a="0"+a),1===l.length&&(l="0"+l),1===f.length&&(f="0"+f),1===u.length&&(u="0"+u),"60"===u&&(u="00"),e=n+"-"+a+"-"+l+" "+f+":"+u+":00"}i.timeOfLastPush=e,postFilterStatsToLogServer(i,(function(t,e,r){var i=(new Date).toGMTString();if(r&&"function"==typeof r.getResponseHeader)try{r.getResponseHeader("Date")&&(i=r.getResponseHeader("Date"))}catch(t){i=(new Date).toGMTString()}ext.storage.set(s,i),(o={}).filters={},o.domains={}}))}))}}))}),36e5),FilterNotifier.on("filter.hitCount",u),chrome.webRequest.onBeforeRequest.addListener(l,{urls:["http://*/*","https://*/*"],types:["main_frame"]}),chrome.tabs.onUpdated.addListener(n),a())}));var c={start:function(){o.filters={},o.domains={},FilterNotifier.on("filter.hitCount",u),chrome.webRequest.onBeforeRequest.addListener(l,{urls:["http://*/*","https://*/*"],types:["main_frame"]}),chrome.tabs.onUpdated.addListener(n),a()},end:function(){o={},FilterNotifier.off("filter.hitCount",u),chrome.webRequest.onBeforeRequest.removeListener(l),ext.storage.remove(s),chrome.tabs.onUpdated.removeListener(n)},getCache:function(){return o}};return c}();