import{b as se}from"./chunk-G3WW6RJZ.js";import{g as V,i as ne}from"./chunk-HH5UG254.js";import{d as F}from"./chunk-XH6MVEJG.js";import{a as ie}from"./chunk-6JGDJAZ5.js";import{a as ae}from"./chunk-CQXN2NRJ.js";import{a as H}from"./chunk-IPZXBZPC.js";import{c as M,d as W,e as q}from"./chunk-E2GNLB6L.js";import{a as ce}from"./chunk-6ILBPYHJ.js";import{a as te,b as oe,c as L}from"./chunk-XZWN3GGK.js";import{a as A,b as y,e as K}from"./chunk-DPMK7ZVG.js";import{f as E,n as re}from"./chunk-KJBXKQ52.js";import{c as Be,h as p,i as $,k as ee,n as R,o as z,v}from"./chunk-4XUWKJYA.js";import{F as N,z as G}from"./chunk-K2PA57PF.js";import{c as I}from"./chunk-AYDLOBCW.js";import{a as Z,c as Ce}from"./chunk-JENJKWHP.js";import{e as k}from"./chunk-3GYLW4KZ.js";var Q=k(I());var le=e=>v("getPostCheckoutDeals",e);var me=e=>v("getPostCheckoutFeedsForTypes",e);var fe=e=>v("getReferralsOfferData",e);async function _e(e,t){return await le({context:F(),contentProps:{type:e,fillWithFallback:R("ext_post_checkout_fallback_deals"),domain:t}})}async function Ye(e,t){return await me({context:F(),contentProps:{types:e,fillWithFallback:R("ext_post_checkout_fallback_deals"),domain:t}})}async function ue(e,t={},m={},i){let n=p.get("siteAPIData"),d=n?.tld,c=await _e(m.type??"deals",d),a=c.items.length>0?c.items[0]:void 0,g={};if(e==="post-checkout-multi-ad-offer"){let f=await fe({experience:"multiOfferPCM",campaign:"",variant:0,source:"desktop",description:"multiOfferPCM"});g={multiAdVersion:1,hasReferral:!!f&&(f?.senderBonus??0)>0,senderBonus:i((f?.senderBonus||0)*100,{truncateIntegers:!0}),maxReferralValue:i((f?.maxReferralValue||0)*100,{truncateIntegers:!0}),referralLink:f?.code?`${E}/account-settings/invite-friends?referralCode=${f?.code}`:null}}let S=oe(e),B=await L(S),D={rootEl:"div",logLevel:null},l=Q.default.reduce(c.items,(f,o)=>{let r=Q.default.get(o,["stats","cashback"],"0%").replace("up to ","");return r>f?r:f},"0%"),u={offers:c,deals:c?.items,currentDeal:a,threshold:a?.stats?.rewardTiers?.[0]?.displaySpendCents??"",threshold_reward:a?.stats?.rewardTiers?.[0]?.reward?.displayValue??"",currentDealCashback:a?.stats?.cashback,dealRewardType:a?.stats?.rewardType??"percentage",notification_text:JSON.stringify({offerCount:c?.items?.length,highestRate:l}),canShowRetargeting:c.canShowRetargeting,...g,...t},s={threshold:u.threshold,threshold_reward:u.threshold_reward,currentDealCashback:u.currentDealCashback,dealRewardType:u.dealRewardType,offerCount:c.items?.length,currentDeal:a,highestRate:l,df:Ee(c.df??[],m.type??"deals"),dnf:Pe(c)??[]},P=await q();return{config:D,content:B,data:u,meta:s,...P}}var Se=new Set(["df","dnf","canShowRetargeting"]);function De(e,t){return!Se.has(e)&&Array.isArray(t)}function Pe(e){let t=[];for(let[m,i]of Object.entries(e))De(m,i)&&t.push(...i.map(n=>({tld:n.tld,index:n.index,type:n.type}))??[]);return t}function Ee(e,t){return e.filter(m=>m.type===t)}var _=k(G()),C=k(I()),ge=k(Be());var w=k(G());function X(e,t,m=!0){let i=(0,w.useRef)(),n=(0,w.useRef)(),d=()=>{n.current&&(window.clearTimeout(n.current),n.current=void 0)};return(0,w.useEffect)(()=>{i.current=e},[e]),(0,w.useEffect)(()=>{function c(){i.current?.()}if(m)return n.current=window.setTimeout(c,t),()=>window.clearTimeout(n.current)},[t,m]),{clearTimeout:d}}var T=e=>v("activateOfferInNewTab",e);function de(){return ee("ext_post_checkout_auto_dismiss_delay_",5)*1e3}var J=k(N());function we({eventName:e="postCheckoutRetargeting",onUnload:t,onRenderComplete:m,blocksParams:i,providedData:n={},blocksSlug:d,contentProps:c={}}){let[a,g]=(0,_.useState)(i),[S,B]=(0,_.useState)(void 0),{formatCurrency:D}=(0,_.useContext)(re);function l(o,r,h,x={}){V(e,o,r,h,x)}let{clearTimeout:u}=X(()=>{l("auto_dismiss","dismiss","secondary"),t?.(!1)},de(),R("ext_post_checkout_auto_dismiss")),s=o=>{let r=C.default.get(a?.data,"deals");if(r&&r[o]){let h=r[o],x=(0,ge.v4)(),j={redirect:!0,cashback:!!h.stats.cashback,meta:JSON.stringify({index:o,view:d,cashback:h.stats.cashback,merchantName:h.merchantName,redirectId:x,dealsLength:r.length})};l("","cta","primary",j);let Y=h.href.replace("__WBCLICKID__",x).replace("subExperience=best_on_web","subExperience=post_checkout");T({link:Y})}t&&t()},P=()=>{let o=C.default.get(a?.data,"deals");if(o){let r={redirect:!0,meta:JSON.stringify({dealsLength:o.length})};l("See all Offers","cta","secondary",r),T({link:E})}t&&t()},f=o=>{if(o.type===y.Custom&&u(),M(o,t),o.type===y.RenderComplete&&o.data&&m?.(o.data.isEmpty),o.type===y.NotificationDismiss&&l("x","dismiss","primary"),o.type===y.Custom&&o.data){let r=o.data.propsData;if(r?.view==="non_product_retargeting"&&r?.link)T({link:r.link}),t&&t();else if(o.eventName==="dealClick"&&C.default.isNumber(r?.index))s(r.index);else if(o.eventName==="allDealsClickToApp"||o.eventName==="allDealsClick")P();else if(o.eventName==="singleOfferClick")s(0);else if(o.eventName==="referralClick"){let h=C.default.get(a,["data","referralLink"]);h&&window.open(h,"_blank","noopener noreferrer"),t&&t()}}};return(0,_.useEffect)(()=>{i&&!C.default.isEqual(i,a)&&g(i)},[i,a]),(0,_.useEffect)(()=>{async function o(){try{let r=await ue(d,n,c,D);g(r);let h=C.default.get(r,["data","deals"]);if(!C.default.get(r,["data","canShowRetargeting"],!1))return;if(!h?.length)z("page",e,{view:"no_offers_available",meta:JSON.stringify({blocksSlug:d,contentProps:c})});else{let j=C.default.get(r,"meta",{}),Y=JSON.stringify({contentProps:c,...j});z("page",e,{view:d,meta:Y})}}catch(r){r instanceof Error&&B(r),console.error(r)}}o()},[]),S?null:a?(0,J.jsx)(K,{client:A.DESKTOP_WEB,config:a.config,content:a.content,host:a.host,user:a.user,data:a.data,onEvent:f,onRequest:W}):(0,J.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,J.jsx)(H,{})})}var O=k(G()),ve=k(I());var b=k(I());Ce();var ke=e=>v("getTopDeals",e);async function Te(){let[e,t,m,i]=await Promise.all([ce(),ae(),ne(),ie()]);e&&(p.set("pageViewId",window.__wb_page_view_id),p.set("session",b.default.get(e,"session")),p.set("events",b.default.get(e,"settings.events")),p.set("settings",b.default.get(e,"settings")),p.set("tabId",b.default.get(e,"tabId")),p.set("lexiFetchResponse",b.default.get(e,"lexiFetchResponse"))),p.merge({siteAPIData:t}),p.merge({cashback:m}),p.set("lifetimeSavings",i)}async function be(){try{return(await chrome.storage.local.get("lastCouponSavings"))?.lastCouponSavings??0}catch(e){return Z("Error fetching lastCouponSavings, defaulting to 0",e),0}}async function he(e,t,m={},i=!1){let n=$("top_deals_post_checkout"),d=i&&(n||"post-checkout-deals-non-vm"===t),[c,a,g]=await Promise.all([await Te(),await be(),d?ke({context:F(),loadPage:null}):Promise.resolve({})]),S=p.get("siteAPIData"),B=S?.siteData?.cashback?.reward||{},D=p.get("cashback"),l=te(t),u=$("should_use_blocks_service")&&l?await L(l):void 0,s=u||await se(e),P={rootEl:"div",logLevel:null},f={...g,$savings:{couponSavings:a??0,cashbackActivated:!!D?.user?.activated,couponsActivated:a>0},topRewardsTypes:g,siteReward:B,couponSavings:a??0,...m},o=await q();return{config:P,content:s,data:f,...o}}var U=k(N());function ye({contentSlug:e,onUnload:t,onRenderComplete:m,onPageView:i,blocksParams:n,isPreloadingBlocks:d=!1,providedData:c={},includeTopDeals:a=!1,blocksSlug:g,children:S}){function B(s,P,f,o={}){V("postCheckoutRetargeting",s,P,f,o)}let D=s=>{M(s,t),s.type===y.NotificationDismiss&&g==="post-checkout-deals-non-vm"&&B("x","dismiss","primary"),s.type===y.RenderComplete&&s.data?m?.(s.data.isEmpty):s.type===y.Custom&&s.data?s.eventName==="exploreDeals"&&g==="post-checkout-deals-non-vm"&&(B("View Savings","cta","primary"),T({link:E}),t&&t()):s.type===y.PageView&&i?.(s)},[l,u]=(0,O.useState)(n);return(0,O.useEffect)(()=>{n&&!ve.default.isEqual(n,l)&&u(n)},[n,l]),(0,O.useEffect)(()=>{!d&&!n&&he(e,g,c,a).then(s=>u(s)).catch(console.error)},[]),l?(0,U.jsx)(K,{client:A.DESKTOP_WEB,config:l.config,content:l.content,host:l.host,user:l.user,data:l.data,onEvent:D,onRequest:W,children:S}):(0,U.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,U.jsx)(H,{})})}export{fe as a,_e as b,Ye as c,De as d,Pe as e,he as f,X as g,we as h,ye as i};
