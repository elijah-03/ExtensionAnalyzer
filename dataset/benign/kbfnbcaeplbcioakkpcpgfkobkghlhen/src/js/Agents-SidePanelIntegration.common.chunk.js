(self.webpackChunk=self.webpackChunk||[]).push([[5320],{3058:(e,t,s)=>{s.d(t,{N:()=>n});var i=s(8867);function n(e){return new i.y((t=>{const s=new DisposableStack,i=s.use(e());return s.adopt(i.subscribe((e=>t.next(e))),(e=>e.unsubscribe())),()=>s.dispose()}))}},25151:(e,t,s)=>{s.d(t,{D8:()=>n.D,N4:()=>o.N,TJ:()=>n.T,kX:()=>i.k});var i=s(60817),n=s(42200),o=s(3058)},94198:(e,t,s)=>{s.r(t),s.d(t,{AgentsSidePanelIntegration:()=>ot});var i=s(92379),n=s(54784),o=s(69088);var r=s(90572),a=s(25151),l=s(13391),c=s(94857),u=s(39963),d=s(78767),h=s(40594),p=s(53446),m=s(1651),b=s(50204);const f={events:{documentSessionDisposed:(0,m.d)()},state:{activeTabId:(0,b.x)(),"activeDocument/:tabId":(0,b.x)(),lastActivePanelAgentId:(0,b.x)(),activePanelAgentId:(0,b.x)()}};var v,g,k,w=s(74822),y=s(21070),I=s(79256),_=s(18519),S=s(71051),P=e=>{throw TypeError(e)},A=(e,t,s)=>t.has(e)||P("Cannot "+s),C=(e,t,s)=>(A(e,t,"read from private field"),s?s.call(e):t.get(e)),D=(e,t,s)=>t.has(e)?P("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),M=(e,t,s,i)=>(A(e,t,"write to private field"),t.set(e,s),s);class x{constructor(e){D(this,v,new DisposableStack),D(this,g,new Map),D(this,k),M(this,k,e)}send(e){C(this,k).send(e)}subscribe(e){const t=new DisposableStack;t.defer((()=>{const t=C(this,g).get(e);null==t||t[Symbol.dispose](),C(this,g).delete(e)}));const s=new DisposableStack;return C(this,g).set(e,s),null!==C(this,k)&&s.use(C(this,k).subscribe(e)),t}connectToServerPort(e){M(this,k,e);for(const[e,t]of C(this,g)){t[Symbol.dispose]();const s=C(this,k).subscribe(e);C(this,g).set(e,s)}}[Symbol.dispose](){C(this,v).dispose()}}v=new WeakMap,g=new WeakMap,k=new WeakMap;var B=s(49486),W=s(76352),O=s(76890);function $(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,s)=>$(e,t[s])));if(Array.isArray(e)!==Array.isArray(t))return!1;const s=Object.keys(e),i=new Set(Object.keys(t));if(s.length!==i.size)return!1;for(const n of s)if(!i.has(n)||!$(e[n],t[n]))return!1;return!0}var T,j,N,E,R,F,V,q,G,X,z,K,Y,H,J,L,U,Q,Z,ee,te,se,ie,ne,oe,re,ae,le,ce,ue,de,he,pe,me,be,fe,ve=s(94311),ge=Object.defineProperty,ke=Object.defineProperties,we=Object.getOwnPropertyDescriptors,ye=Object.getOwnPropertySymbols,Ie=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,Se=e=>{throw TypeError(e)},Pe=(e,t,s)=>t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Ae=(e,t)=>{for(var s in t||(t={}))Ie.call(t,s)&&Pe(e,s,t[s]);if(ye)for(var s of ye(t))_e.call(t,s)&&Pe(e,s,t[s]);return e},Ce=(e,t,s)=>t.has(e)||Se("Cannot "+s),De=(e,t,s)=>(Ce(e,t,"read from private field"),s?s.call(e):t.get(e)),Me=(e,t,s)=>t.has(e)?Se("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),xe=(e,t,s,i)=>(Ce(e,t,"write to private field"),t.set(e,s),s),Be=(e,t,s)=>(Ce(e,t,"access private method"),s);class We{constructor(e){var t,s;Me(this,K),Me(this,T,new DisposableStack),Me(this,j),Me(this,N),Me(this,E),Me(this,R),Me(this,F,!1),Me(this,V,null),Me(this,q,De(this,T).adopt(new Map,(e=>e.clear()))),Me(this,G,De(this,T).adopt(new Map,(e=>e.clear()))),Me(this,X,De(this,T).adopt(new Map,(e=>e.clear()))),Me(this,z,De(this,T).adopt(new Map,(e=>e.clear()))),xe(this,j,e.serverPort),xe(this,N,null!=(t=e.tracingOptions)?t:{enabled:!1}),xe(this,E,e.retainedValueStorage),xe(this,R,`${(0,ve.v)()}${void 0!==e.name?`(${e.name})`:""}`),De(this,T).use(null==(s=De(this,j))?void 0:s.subscribe((e=>Be(this,K,H).call(this,e)))),De(this,T).defer((()=>{var t;return null==(t=e.retainedValueStorage)?void 0:t.clear()})),void 0!==De(this,j)&&this.connect()}isConnected(){return!De(this,F)}waitConnected(){var e,t;return null!=(t=null==(e=De(this,V))?void 0:e.promise)?t:Promise.resolve()}connect(){return((e,t,s)=>new Promise(((i,n)=>{var o=e=>{try{a(s.next(e))}catch(e){n(e)}},r=e=>{try{a(s.throw(e))}catch(e){n(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,r);a((s=s.apply(e,t)).next())})))(this,null,(function*(){var e;if(!De(this,j))return Promise.resolve();null==(e=De(this,V))||e.reject(new Error("Connection attempt superseded by a newer one")),xe(this,F,!0),De(this,z).forEach((e=>e.setBufferingEnabled(!0)));const t=`${De(this,R)}|${(0,ve.v)()}`,s=(0,O.B)();return xe(this,V,{attempId:t,resolve:()=>{var e;(null==(e=De(this,V))?void 0:e.attempId)===t&&(xe(this,F,!1),xe(this,V,null),De(this,z).forEach((e=>e.setBufferingEnabled(!1))),s.resolve())},reject:e=>{var i;(null==(i=De(this,V))?void 0:i.attempId)===t&&(xe(this,F,!1),xe(this,V,null),s.reject(e))},promise:s.promise}),De(this,j).send({kind:"handshake",id:t,subscriptions:[...De(this,q).values()].map((e=>({key:e.key,clientId:e.clientId,subscriptionId:e.portId,timestamp:e.timestamp}))),retainedValues:[...De(this,X).entries()].map((([e,t])=>({key:e,value:t.value,clientId:t.lastWriterClientId,timestamp:t.modifiedTimestamp})))}),s.promise}))}createPort(e){const t=null==e?void 0:e.name,s=`${De(this,R)}|${(0,ve.v)()}${void 0!==t?`(${t})`:""}`,i=De(this,T).use(new Oe({send:e=>Be(this,K,U).call(this,s,e),notifyDispose:()=>Be(this,K,Y).call(this,s),shouldBufferMessages:De(this,F),tracingOptions:void 0!==(null==e?void 0:e.tracingOptions)?e.tracingOptions:De(this,N),portId:s}));return De(this,z).set(s,i),i}[Symbol.dispose](){De(this,T).dispose()}}T=new WeakMap,j=new WeakMap,N=new WeakMap,E=new WeakMap,R=new WeakMap,F=new WeakMap,V=new WeakMap,q=new WeakMap,G=new WeakMap,X=new WeakMap,z=new WeakMap,K=new WeakSet,Y=function(e){const t=De(this,z).get(e);if(void 0!==t){for(const[t,s]of De(this,q).entries())s.portId===e&&Be(this,K,ie).call(this,e,{kind:"unsubscribe",subscriptionId:t});t[Symbol.dispose](),De(this,z).delete(e)}},H=function(e){switch(e.kind){case"publish":Be(this,K,L).call(this,e);break;case"handshake-ack":Be(this,K,J).call(this,e)}},J=function(e){var t;(null==(t=De(this,V))?void 0:t.attempId)===e.id&&De(this,V).resolve()},L=function(e){var t,s;const i=De(this,X).get(e.key);if(void 0!==i){if(e.timestamp<i.modifiedTimestamp)return;De(this,X).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=De(this,E))||t.set(e.key,e.value)}if(null==(s=e.route)||!s.includes(De(this,R)))return void 0!==e.toSubscriptionId?Be(this,K,ne).call(this,e):void 0!==e.toClientId?Be(this,K,oe).call(this,e):Be(this,K,re).call(this,e)},U=function(e,t){switch(t.kind){case"publish":Be(this,K,Q).call(this,t);break;case"subscribe":Be(this,K,ee).call(this,e,t);break;case"unsubscribe":Be(this,K,ie).call(this,e,t);break;case"handshake":Be(this,K,Z).call(this,e,t)}},Q=function(e){var t,s,i;const n=De(this,X).get(e.key);void 0!==n&&e.timestamp>=n.modifiedTimestamp&&(De(this,X).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=De(this,E))||t.set(e.key,e.value));const o=((e,t)=>ke(e,we(t)))(Ae({},e),{route:[...null!=(s=e.route)?s:[],De(this,R)]});void 0!==e.toClientId?Be(this,K,oe).call(this,o):Be(this,K,re).call(this,o),null==(i=De(this,j))||i.send(o)},Z=function(e,t){var s,i;const n=De(this,z).get(e);if(void 0!==n){for(const s of t.subscriptions)Be(this,K,te).call(this,{key:s.key,portId:e,timestamp:s.timestamp,clientId:s.clientId,subscriptionId:s.subscriptionId});for(const e of t.retainedValues)De(this,X).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(s=De(this,E))||s.set(e.key,e.value);n.outbound({kind:"handshake-ack",id:t.id}),null==(i=De(this,j))||i.send(t)}else(0,B.P)("No port for handshake message",e)},ee=function(e,t){var s;De(this,q).has(t.subscriptionId)?(0,B.P)("Subscription with this id already exists",t.subscriptionId):(Be(this,K,te).call(this,Ae({portId:e},t)),void 0!==t.retain&&Be(this,K,se).call(this,t,t.retain.value,e),null==(s=De(this,j))||s.send(t))},te=function(e){const t={key:e.key,portId:e.portId,timestamp:e.timestamp,clientId:e.clientId};De(this,q).set(e.subscriptionId,t);let s=De(this,G).get(e.key);void 0===s&&(s=new Set,De(this,G).set(e.key,s)),s.add(e.subscriptionId)},se=function(e,t,s){var i,n,o,r,a;if("write"===(null==(i=e.retain)?void 0:i.kind)&&e.timestamp>=(null!=(o=null==(n=De(this,X).get(e.key))?void 0:n.modifiedTimestamp)?o:Number.MIN_SAFE_INTEGER)&&!$(t,null==(r=De(this,X).get(e.key))?void 0:r.value))De(this,X).set(e.key,{value:t,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(a=De(this,E))||a.set(e.key,t),void 0!==De(this,z).get(s)&&Be(this,K,re).call(this,{kind:"publish",key:e.key,value:t,timestamp:e.timestamp,clientId:e.clientId,route:[De(this,R)],excludeSubscriptionId:e.subscriptionId});else{const i=De(this,X).get(e.key);if(void 0===i)return;void 0!==De(this,z).get(s)&&!$(t,i.value)&&Be(this,K,ne).call(this,{kind:"publish",key:e.key,value:i.value,timestamp:i.modifiedTimestamp,clientId:i.lastWriterClientId,route:[De(this,R)],toSubscriptionId:e.subscriptionId})}},ie=function(e,t){var s,i;const n=De(this,q).get(t.subscriptionId);if(void 0===n)return void(0,B.P)("No subscription with this id",t.subscriptionId);if(n.portId!==e)return void(0,B.P)("Subscription does not belong to this port",t.subscriptionId,e);De(this,q).delete(t.subscriptionId);const o=De(this,G).get(n.key);void 0!==o&&(o.delete(t.subscriptionId),0===o.size&&(De(this,G).delete(n.key),De(this,X).delete(n.key),null==(s=De(this,E))||s.delete(n.key))),null==(i=De(this,j))||i.send(t)},ne=function(e){const t=De(this,q).get(e.toSubscriptionId);if(void 0===t)return void(0,B.P)("No subscription with this id",e.toSubscriptionId);const s=De(this,z).get(t.portId);void 0!==s?s.outbound(e):(0,B.P)("No port for subscription with this id",e.toSubscriptionId)},oe=function(e){const t=Be(this,K,ae).call(this,e.key,e.toClientId,void 0);for(const s of t)s.outbound(e)},re=function(e){const t=Be(this,K,ae).call(this,e.key,void 0,e.excludeSubscriptionId);for(const s of t)s.outbound(e)},ae=function(e,t,s){const i=new Set,n=De(this,G).get(e);for(const e of null!=n?n:[]){if(void 0!==s&&e===s)continue;const n=De(this,q).get(e);if(void 0===n||void 0!==t&&t!==n.clientId)continue;const o=De(this,z).get(n.portId);void 0!==o&&i.add(o)}return i};class Oe{constructor(e){var t;Me(this,me),Me(this,le,new DisposableStack),Me(this,ce),Me(this,ue),Me(this,de,De(this,le).use(new W.x)),Me(this,he,[]),Me(this,pe),xe(this,ue,e.send),xe(this,pe,e.shouldBufferMessages),De(this,le).defer((()=>e.notifyDispose())),xe(this,ce,null!=(t=e.tracingOptions)?t:{enabled:!1}),this.portId=e.portId}send(e){Be(this,me,fe).call(this,"inbound",e),De(this,pe)&&"handshake"!==e.kind?De(this,he).push(e):(Be(this,me,be).call(this),De(this,ue).call(this,e))}subscribe(e){const t=new DisposableStack;return De(this,le).defer((()=>t.dispose())),t.use(De(this,de).subscribe({next:e,complete:()=>t.dispose()})),t}[Symbol.dispose](){De(this,le).dispose()}outbound(e){Be(this,me,fe).call(this,"outbound",e),De(this,de).next(e)}setBufferingEnabled(e){xe(this,pe,e),e||Be(this,me,be).call(this)}}le=new WeakMap,ce=new WeakMap,ue=new WeakMap,de=new WeakMap,he=new WeakMap,pe=new WeakMap,me=new WeakSet,be=function(){if(De(this,he).length>0){for(const e of De(this,he))De(this,ue).call(this,e);De(this,he).length=0}},fe=function(e,t){};class $e extends We{constructor(e){super(e)}}var Te=s(99161);function je(e,t){const s=new DisposableStack,i=e.createPortConnection(Te.Tt.messageBusPort),n=new w.x;return i.onDisconnect((()=>{s.disposed||t()})),i.onMessage((e=>{s.disposed||n.next(e)})),{send:e=>{s.disposed||i.postMessage(e)},subscribe:e=>{const t=s.use(new DisposableStack);return t.adopt(n.subscribe(e),(e=>e.unsubscribe())),t},[Symbol.dispose]:()=>s.dispose()}}class Ne{constructor(e){this._init=e,this._baseDisposables=new DisposableStack,this._reconnectSubject=new w.x,this._volatileMessageBusServerPort=this._baseDisposables.use(je(this._init.message,(()=>this._reconnectSubject.next()))),this._messageBusServerPort=this._baseDisposables.use(new x(this._volatileMessageBusServerPort)),this._messageBusContentScriptRouter=this._baseDisposables.use(new $e({tracingOptions:{enabled:!1,color:"green"},serverPort:this._messageBusServerPort,name:this._init.routerName})),this._baseDisposables.adopt(this._reconnectSubject.pipe((0,y.z)((()=>(0,I.P)((()=>(this._volatileMessageBusServerPort=this._baseDisposables.use(je(this._init.message,(()=>this._reconnectSubject.next()))),this._messageBusServerPort.connectToServerPort(this._volatileMessageBusServerPort),this._messageBusContentScriptRouter.connect()))).pipe((0,_.V)(1e3),(0,S.X)({count:5}))))).subscribe(),(e=>e.unsubscribe()))}createPort(...e){return this._messageBusContentScriptRouter.createPort(...e)}[Symbol.dispose](){this._baseDisposables.dispose()}}function Ee(e){return`agents/${e}`}function Re(e,...t){return Fe(e,...t)}function Fe(e,...t){return`agents/@impl/${e}${Xe(t)}`}function Ve(e,t,...s){return qe(e,t,...s)}function qe(e,t,...s){return`${Ee(e)}/${t}${Xe(s)}`}function Ge(e,...t){return`agents/${e}${Xe(t)}`}function Xe(e){const t=e.filter(Boolean).join("/");return t?`/${t}`:""}class ze{constructor(e){this._disposables=new DisposableStack,this._messageBusRouter=this._disposables.use(new Ne({message:e.message,routerName:Ge(e.script,e.tabId)})),this.platformBus=this._disposables.use((0,a.kX)({port:this._messageBusRouter.createPort({name:Re(e.script,e.tabId)}),clientId:Fe(e.script,e.tabId),keyPrefix:"agents/@impl",protocol:f}))}createPort(...e){return this._messageBusRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}}var Ke=s(80891);class Ye{constructor(e){this._experimentClient=e}isAssigned(e,...t){if(e instanceof Ke.Cc)return this._experimentClient.isGateEnabled(e);const s=this._experimentClient.getTreatment(e);return null!==s&&s!==Ke.q4&&t.includes(s)}getTreatment(e){const t=this._experimentClient.getTreatment(e);return t===Ke.q4?null:t}peekExperiment(e,...t){const s=this._experimentClient.peekTreatment(e);return null!==s&&s!==Ke.q4&&t.includes(s)}}var He=s(12518),Je=s(35218),Le=s(6219);const Ue=e=>{const t=new Set;return"edge"!==e.browser&&"msie"!==e.browser&&t.add(Le.L.Flag.supportsSVGDominantBaseline),{has:e=>t.has(e)}};class Qe{constructor(){this.openUrl=e=>(0,He.Y3)((()=>{document.location.href=e.toString()}),He.KC),this.openPopup=e=>(0,He.Y3)((()=>{const t=self.open(e.toString(),"_blank","noopener,noreferrer");t&&(t.opener=null)}),He.KC)}}var Ze=s(24196),et=s(24666),tt=s(20161),st=s(84714);var it=s(40795);function nt(e){return{[Symbol.asyncDispose]:async()=>{if(!e)return;const t=await e;t&&(!function(e){return Symbol.dispose in e}(t)?function(e){return Symbol.asyncDispose in e}(t)&&await t[Symbol.asyncDispose]():t[Symbol.dispose]())}}}class ot{constructor(e){this._initOptions=e,this._disposables=new AsyncDisposableStack,this._logger=h.Y.create("AgentsSidePanelIntegration"),this._experimentationService=new Ye(this._initOptions.experimentClient),this._agentDefinitions=(0,it.c)(this._initOptions.experimentClient),this._messageBusClient=this._disposables.use(new ze({message:(0,p.O)().browserApi.message,script:"side-panel"})),this._agentPlatformBus=this._messageBusClient.platformBus,this._activePanelAgentId=this._disposables.use(this._agentPlatformBus.state.lastActivePanelAgentId.create(null))}setActiveAgentId(e){this._activePanelAgentId.set(e)}loadAssistantAgents(){if(!(0,Ze.w4)(this._initOptions.experimentClient))return l.h.create([]);const e=this._runAssistantActivations(),t=l.h.create(new Map(e.map((e=>[e.agentId,null]))));for(const s of e){const{agentId:e,integrationResult:n}=s;n.then((s=>{s?t.modify((t=>{const n=i.memo((e=>s.renderIcon(e)));n.displayName=`Icon-${e}`;const o=i.memo((()=>s.renderPanel({onClosePanel:void 0})));return o.displayName=`Panel-${e}`,new Map(t).set(e,{id:e,title:s.title,renderPanel:()=>i.createElement(o),renderIcon:e=>i.createElement(n,e)})})):this._logger.debug(`Agent ${e} was not activated due to allowed features check`)})).catch((t=>{this._logger.error(`Failed to get assistant integration result for agent ${e}`,t),(0,u.Tb)().agents.sidePanel.error("Failed to get assistant integration result for agent",t,{agentId:e})}))}return t.view((e=>[...e.values()].filter(d.C_)))}async _getAllowedFeatures(){if(!this._initOptions.experimentClient.isGateEnabled(Ze.Nl.AgentsCAPIFiltering))return this._logger.debug("CAPI filtering gate is disabled, using all agents"),null;const e=this._initOptions.checkingServiceProvider.getCheckingService();if(!e)return this._logger.debug("No checking service available, skipping all agents"),[];try{const a=e=>"start"===e.action,l=(await(t=e.capiMessages.pipe((0,r.h)(a)),i="object"==typeof s,new Promise((function(e,r){var a=new o.Hp({next:function(t){e(t),a.unsubscribe()},error:r,complete:function(){i?e(s.defaultValue):r(new n.K)}});t.subscribe(a)})))).allowedFeatures||[];return this._logger.debug("Received allowed features from CAPI:",l),l}catch(e){return this._logger.error("Failed to get allowed features from CAPI:",e),[]}var t,s,i}_runAssistantActivations(){const e=c.W.detect(),t=function(e){return new Je.f(Ue(e),new Qe)}(e),s={activeDocument:this._disposables.use(function(e){const t=new DisposableStack,s=t.use(e.state.activeTabId.view(null)),i=l.h.create(null);return t.adopt(s.pipe((0,et.x)(),(0,tt.w)((t=>null===t?(0,st.of)(null):(0,a.N4)((()=>e.state.activeDocument.view(t,null)))))).subscribe((e=>i.set(e))),(e=>e.unsubscribe())),{activeDocument:i,[Symbol.dispose]:()=>t.dispose()}}(this._agentPlatformBus)).activeDocument,documentSessionDisposed:this._agentPlatformBus.events.documentSessionDisposed.view()},i={user:this._initOptions.user.view((e=>({id:e.id,firstName:e.firstName,email:e.email,free:!e.premium,anonymous:e.anonymous})))},n=this._getAllowedFeatures();return this._agentDefinitions.map((o=>{const r=n.then((async n=>{var r,l;if(null!==n){const e=it.i[o.id];if(e&&!n.includes(e))return this._logger.debug(`Agent ${o.id} requires feature ${e} which is not in allowed features, skipping activation`),null}this._logger.debug(`Running assistant activation for ${o.id}`);const c=new AsyncDisposableStack;this._disposables.defer((()=>c.disposeAsync()));const d=c.use(this._messageBusClient.createPort({name:Ve(o.id,"assistant")}));try{const n=null===(l=(r=o.integrations).assistantActivate)||void 0===l?void 0:l.call(r,{bus:c.use((0,a.kX)({port:d,clientId:qe(o.id,"assistant"),keyPrefix:Ee(o.id),protocol:o.protocol})),documents:s,navigation:{isPanelOpen:this._activePanelAgentId.view((e=>e===o.id))},experimentation:this._experimentationService,platformInfo:e,environment:t,userService:i});return n?(c.use(nt(n.catch((()=>null)))),n):(c.disposeAsync(),null)}catch(e){return c.disposeAsync(),this._logger.error(`Assistant activation error for agent ${o.id}`,e),(0,u.Tb)().agents.sidePanel.error("Assistant activation failed for agent",e,{agentId:o.id}),null}}));return{agentId:o.id,integrationResult:r}}))}dispose(){this._disposables.disposeAsync()}}}}]);