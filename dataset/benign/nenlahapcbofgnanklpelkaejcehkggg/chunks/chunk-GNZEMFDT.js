import{a as fe}from"./chunk-ECXCPAF6.js";import{j as de,k as pe}from"./chunk-53OM6ECF.js";import{c as O}from"./chunk-3GYLW4KZ.js";var F=O(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.decodePayload=void 0;function me(r){let e=r.split(".")[1],t=atob(e);return JSON.parse(t)}E.decodePayload=me});var V=O(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.RewardTokenMinMap=v.RewardTokenMaxMap=v.transformKeys=v.inflateRewardsToken=v.minifyRewardsToken=void 0;function ve(r){return C(r,v.RewardTokenMinMap)}v.minifyRewardsToken=ve;function ge(r){return C(r,v.RewardTokenMaxMap)}v.inflateRewardsToken=ge;function C(r,e){if(typeof r!="object"||r===null)return r;if(Array.isArray(r))return r.map(n=>C(n,e));let t={};for(let n in r)if(Object.prototype.hasOwnProperty.call(r,n)){let o=e.get(n)||n;t[o]=C(r[n],e)}return t}v.transformKeys=C;var ee={v:"version",i:"id",u:"userId",d:"domain",e:"expiration",w:"publisher",t:"type",a:"amount",b:"amountCurrency",p:"maxPayoutAmount",q:"maxPayoutAmountCurrency",c:"categories",k:"cookie",l:"tiers",n:"name",r:"reward",x:"value",s:"spendCents"};v.RewardTokenMaxMap=new Map(Object.entries(ee));v.RewardTokenMinMap=new Map(Object.entries(ee).map(r=>r.reverse()))});var re=O(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.parseTokenizedReward=k.decodeAndInflate=void 0;var ye=F(),he=V();function te(r){let e=(0,ye.decodePayload)(r);return(0,he.inflateRewardsToken)(e)}k.decodeAndInflate=te;function we(r){if(!r?.token)return;let e=te(r.token);switch(e.type){case"cut":{let t=_e(e);t&&(e.type=t.type,e.amount=t.amount);break}case"forced-percentage":{e.type="percentage";break}case"threshold":{e.threshold=be(e);break}}return Object.assign(Object.assign({},r.clientData),{reward:e,token:r.token})}k.parseTokenizedReward=we;function _e(r){var e;return(e=r.categories)===null||e===void 0?void 0:e[0]}function be(r){var e;return(e=r.tiers)===null||e===void 0?void 0:e[0].spendCents}});var ne=O(R=>{"use strict";var Oe=R&&R.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t);var o=Object.getOwnPropertyDescriptor(e,t);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,o)}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),L=R&&R.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Oe(e,r,t)};Object.defineProperty(R,"__esModule",{value:!0});L(F(),R);L(V(),R);L(re(),R)});var z=O(q=>{"use strict";var S=q&&q.__awaiter||function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(u){u(a)})}return new(t||(t=Promise))(function(a,u){function i(s){try{l(n.next(s))}catch(c){u(c)}}function d(s){try{l(n.throw(s))}catch(c){u(c)}}function l(s){s.done?a(s.value):o(s.value).then(i,d)}l((n=n.apply(r,e||[])).next())})};Object.defineProperty(q,"__esModule",{value:!0});var Pe=new Set(["and","or","not","regex","listContains","equals","elementExists"]),Re=new Set(["url","protocol","domain","path","search","cookie","userCountry","domContent"]),K=class{constructor({url:e,protocol:t,domain:n,pathname:o,search:a,country:u,getCookie:i}){Object.assign(this,{url:e,protocol:t,domain:n,pathname:o,search:a,country:u,getCookie:i}),this.testElementExistAttemptCount=0,this.elementExistsTimeoutMs=2e3}getContextValueForOperation(e){return S(this,void 0,void 0,function*(){let{context:t}=e;if(!Re.has(t))throw new Error(`Unsupported context [${t}]`);if(t==="url")return this.url;if(t==="protocol")return this.protocol;if(t==="domain")return this.domain;if(t==="path")return this.pathname;if(t==="search")return this.search;if(t==="cookie")return this.getCookie(e.name);if(t==="userCountry")return this.country})}test(e,t=!1){return S(this,void 0,void 0,function*(){if(!Pe.has(e.operator))return console.error(`[programs] Unsupported operator [${e.operator}]`),!1;if(e.operator==="and"){if(!Array.isArray(e.value))throw new Error("The value of operator `and` must be an array");let n=!0;for(let o of e.value)if(!(yield this.test(o,t))){n=!1;break}return n}if(e.operator==="not"){if(Array.isArray(e.value))throw new Error("The value of operator `not` must be a single condition");return(yield this.test(e.value,t))===!1}if(e.operator==="or"){if(!Array.isArray(e.value))throw new Error("The value of operator `or` must be an array");let n=!1;for(let o of e.value)if(yield this.test(o,t)){n=!0;break}return n}if(e.operator==="regex"){let n=yield this.getContextValueForOperation(e);if(typeof n!="string")return!1;let o=e.value||e.pattern;return o&&!!n.match(new RegExp(o,e.flags||""))}if(e.operator==="listContains"){let n=yield this.getContextValueForOperation(e);return Array.isArray(e.value)&&e.value.includes(n)}if(e.operator==="equals"){let n=yield this.getContextValueForOperation(e);return e.value===n}if(e.operator==="elementExists"){if(!t)return!1;try{return yield this.testElementExists(e.value)}catch(n){return console.error("[programs] program rules error",n),null}}return!1})}hasDomContentRule(e){let t=!1,n=o=>{if(Array.isArray(o.value))for(let a of o.value)n(a);o.context==="domContent"&&(t=!0)};return n(e),t}testClientRules(e,t){return S(this,void 0,void 0,function*(){return t&&(this.elementExistsTimeoutMs=t),{matched:yield this.test(e,!0),elementExistTestCount:this.testElementExistAttemptCount}})}testElementExists(e){return S(this,void 0,void 0,function*(){let n=this.elementExistsTimeoutMs/100;return new Promise((o,a)=>{if(document.querySelectorAll(e).length>0)return o(!0);try{let i=0,d=setInterval(()=>{i++;let l=document.querySelectorAll(e);if(this.testElementExistAttemptCount++,l.length>0)return clearInterval(d),o(!0);if(i>=n)return clearInterval(d),o(!1)},100)}catch(i){return a(i)}})})}};q.default=K});var oe=O(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});function Te(r=[]){let e=r.find(t=>t.indexOf("c_ranker_")===0);if(e)return e.split("c_ranker_")[1]}Q.default=Te});var J=O(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});var W=pe(),Ae=["1password.com","pantheonsite.io"];function xe(r){let e=W.getDomain(r);if(!e){let a=W.getPublicSuffix(r);if(Ae.includes(a))return a}let t=W.getSubdomain(r),n=t&&t.startsWith("www.")?t.substr(4):t,o=`${n}.${e}`;return n&&n!=="www"?o:e}H.default=xe});var G=O(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.BonusOfferType=void 0;var ie;(function(r){r.newUserActivationBonus="nuab",r.firstTimeEmailActivationBonus="fteab",r.firstTimeEmailActivationBonusMobile="fteabm",r.desktopToMobileAppBonus="dtmab"})(ie||(U.BonusOfferType=ie={}))});var le=O(h=>{"use strict";var M=h&&h.__awaiter||function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(u){u(a)})}return new(t||(t=Promise))(function(a,u){function i(s){try{l(n.next(s))}catch(c){u(c)}}function d(s){try{l(n.throw(s))}catch(c){u(c)}}function l(s){s.done?a(s.value):o(s.value).then(i,d)}l((n=n.apply(r,e||[])).next())})};Object.defineProperty(h,"__esModule",{value:!0});h.getProgramDataById=h.applyClientRules=h.fetchReward=void 0;var je=de(),$=fe(),ke=ne(),Y=z(),Me=oe(),ae=J(),X=G(),se=globalThis.URL?globalThis.URL:je.URL;function Z({fetchOptions:r,ignoreCache:e,omitCredentials:t,session:n}){let o=n?.sessionToken?{"x-wb-session":decodeURIComponent(n.sessionToken)}:void 0,a=e?{"cache-control":"no-cache"}:void 0,u=Object.assign(Object.assign({},o),a);return Object.assign(Object.assign({headers:u},{credentials:t?"omit":void 0}),r)}function Ce(r,{apiBase:e,session:t,ignoreCache:n,experience:o,omitCredentials:a,onFetchError:u,fetchOptions:i}){var d;return M(this,void 0,void 0,function*(){let l=Z({fetchOptions:i,ignoreCache:n,omitCredentials:a,session:t}),c=yield(yield(0,$.memoizedFetch)(`${e}/v1/programs/${r}${o?`?experience=${o}`:""}`,l,u)).json();return(d=c?.programs)===null||d===void 0?void 0:d.rules})}function ue(r,{apiBase:e,extensionName:t,ignoreCache:n,omitCredentials:o,onFetchError:a,fetchOptions:u,session:i,subExperience:d,url:l}){var s;return M(this,void 0,void 0,function*(){let c=Z({fetchOptions:u,ignoreCache:n,omitCredentials:o,session:i}),P=(0,Me.default)(i?.features),A=`?${t?`extension=${t}`:""}${P?`&ranker=${P}`:""}`,g=(s=i?.features)===null||s===void 0?void 0:s.includes("rewards_engine_enabled"),w=(0,$.memoizedFetch)(`${e}/v1/program/${r}/coupons${A}`,c,a).then(j=>j.json()),T=ce(r,{apiBase:e,fetchOptions:u,ignoreCache:n,omitCredentials:o,onFetchError:a,session:i,subExperience:d,url:l}),p=(0,$.memoizedFetch)(`${e}/v1/program/${r}`,c,a).then(j=>j.json()),[y,f,_]=yield Promise.all([w,T,p]);_.meta=qe(_?.meta,y?.meta);let x=g&&(0,ke.parseTokenizedReward)(f?.rewards)||f?.rewards,b=Object.assign(Object.assign({},_.siteData),{coupons:y?.coupons,cashback:x});return g&&f?.redirectUrl&&(b.cashback=Object.assign(Object.assign({},b.cashback),{redirectUrl:f.redirectUrl})),f?.cs&&(b.cashback=Object.assign(Object.assign({},b.cashback),{cs:f.cs})),Object.assign(Object.assign({},_),{siteData:b})})}function ce(r,{apiBase:e,bonusOfferType:t,fetchOptions:n,ignoreCache:o,omitCredentials:a,onFetchError:u,session:i,subExperience:d,url:l}){var s,c,P;return M(this,void 0,void 0,function*(){let A=(s=i?.features)===null||s===void 0?void 0:s.includes("rewards_engine_enabled"),g="";if(A){let p=new URLSearchParams;p.append("re","t"),t&&(p.append("b","t"),t===X.BonusOfferType.newUserActivationBonus?p.append("sxp","ext"):t===X.BonusOfferType.desktopToMobileAppBonus?p.append("sxp","mobile"):t===X.BonusOfferType.firstTimeEmailActivationBonusMobile&&p.append("sxp","mobile_email")),l&&(!((c=i?.features)===null||c===void 0)&&c.includes("use_redirect_link_service"))&&(!((P=i?.features)===null||P===void 0)&&P.includes("use_redirect_v_3"))&&p.append("destUrl",l),d&&p.append("sxp",d),g=`?${p}`}let w=Z({fetchOptions:n,ignoreCache:o,omitCredentials:a,session:i});return(0,$.memoizedFetch)(`${e}/v1/program/${r}/rewards${g}`,w,u).then(p=>p.json())})}h.fetchReward=ce;function qe(r={},e={}){return Object.assign(Object.assign({},r),e)}function De({url:r,session:e,getCookie:t,apiBase:n,extensionName:o,ignoreCache:a,experience:u,subExperience:i,platformDomain:d,omitCredentials:l,onFetchError:s,fetchOptions:c}){return M(this,void 0,void 0,function*(){let P=d||(0,ae.default)(r),{pathname:A,hostname:g,protocol:w,search:T}=new se(r),p=e.country;n=n||"https://capitaloneshopping.com/api";let y=yield Ce(P,{apiBase:n,ignoreCache:a,session:e,extensionName:o,experience:u,omitCredentials:l,onFetchError:s,fetchOptions:c}),f=y.filter(I=>{let{rulesTree:B}=I;return!new Y.default({url:r,domain:g,pathname:A,protocol:w,search:T,country:p,getCookie:t}).hasDomContentRule(B)}),_=f.length<y.length,x;for(let I of f){let{programId:B,rulesTree:N}=I;if(yield new Y.default({url:r,domain:g,pathname:A,protocol:w,search:T,country:p,getCookie:t}).test(N)){x=B;break}}if(!x&&!y.length)return;let b;return x&&(b=yield ue(x,{apiBase:n,ignoreCache:a,session:e,extensionName:o,url:r,omitCredentials:l,fetchOptions:c,subExperience:i})),{program:b,deferredProgramSelection:_?y:null}})}h.default=De;function Ee(r,e,t,n,o){return M(this,void 0,void 0,function*(){let a=(0,ae.default)(e),{pathname:u,protocol:i,search:d}=new se(e),l=(g,w)=>(g+=w.duration,g),s=[],c=0;for(let g of r){c++;let w=performance.now(),{programId:T,rulesTree:p}=g,y=new Y.default({url:e,protocol:i,domain:a,pathname:u,search:d,country:t,getCookie:n}),{matched:f,elementExistTestCount:_}=yield y.testClientRules(p,o?.programAttemptTimeoutMs),b=performance.now()-w;if(s.push({program:T,duration:b,attempts:_}),f){let j=s.reduce(l,0);return{programId:T,metrics:{totalDuration:j,programsTestedCount:c,attempts:s}}}}return{metrics:{totalDuration:s.reduce(l,0),programsTestedCount:c,attempts:s}}})}h.applyClientRules=Ee;function Se(r,{url:e,session:t,apiBase:n,extensionName:o,ignoreCache:a,omitCredentials:u,fetchOptions:i,subExperience:d}){return M(this,void 0,void 0,function*(){return n=n||"https://capitaloneshopping.com/api",yield ue(r,{apiBase:n,ignoreCache:a,session:t,extensionName:o,url:e,omitCredentials:u,fetchOptions:i,subExperience:d})})}h.getProgramDataById=Se});var Be=O(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.ProgramRules=m.getSiteDomainFromUrl=m.getProgramDataById=m.getProgram=m.fetchReward=m.applyClientRules=m.BonusOfferType=void 0;var D=le();m.getProgram=D.default;Object.defineProperty(m,"applyClientRules",{enumerable:!0,get:function(){return D.applyClientRules}});Object.defineProperty(m,"fetchReward",{enumerable:!0,get:function(){return D.fetchReward}});Object.defineProperty(m,"getProgramDataById",{enumerable:!0,get:function(){return D.getProgramDataById}});var Ue=z();m.ProgramRules=Ue.default;var $e=J();m.getSiteDomainFromUrl=$e.default;var Ie=G();Object.defineProperty(m,"BonusOfferType",{enumerable:!0,get:function(){return Ie.BonusOfferType}});m.default=D.default});export{ne as a,Be as b};
