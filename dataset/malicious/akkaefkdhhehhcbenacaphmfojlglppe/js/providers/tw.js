const TWProvider=class extends AbstractProvider{constructor(a){super(),this.oauth2_access_token=null,this.getAccessToken(a),this.modalCalss="div[aria-modal=\"true\"]"}getAccessToken(a){const b=this;$.ajax({type:"POST",url:"https://api.twitter.com/oauth2/token",headers:{Authorization:"Basic "+a,"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:{grant_type:"client_credentials"},dataType:"json",xhrFields:{withCredentials:!1},success:a=>{b.oauth2_access_token=a.access_token}})}search(){"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener({videos:this.videos});const a=$("video").not("#vlc-video").not("."+INIT_CLASS);a.each((a,b)=>{const c=$(b),d=c.closest("[data-item-id]").attr("data-item-id");this.addVideo(b),c.addClass(INIT_CLASS)})}getVideoData(a,b){$.ajax({type:"GET",url:`https://api.twitter.com/1.1/statuses/show.json?id=${a}&include_profile_interstitial_type=1&include_blocking=1&include_blocked_by=1&include_followed_by=1&include_want_retweets=1&skip_status=1&cards_platform=Web-12&include_cards=1&include_ext_alt_text=true&include_reply_count=1&tweet_mode=extended&trim_user=false&include_ext_media_color=true`,dataType:"json",headers:{Authorization:"Bearer "+this.oauth2_access_token},success:c=>{const d=c.full_text,e=[];c.extended_entities.media[0].video_info.variants.filter(a=>"video/mp4"===a.content_type).forEach(b=>{const c=b.url,f=c.match(/vid\/(.+)\//),g=f&&f[1]?f[1]:"";e.push({title:d,url:c,vid:a,provider:"tw",quality:g})}),"function"==typeof this.mediaUpdateListener&&this.mediaUpdateListener({videos:e}),b(e)}})}addVideo(a){const b=a.closest("article"),c=this.getTweetId(b,"article");if(a.src.includes("blob"))!c||this.processBlobVideo(c,this.readerableFilename(b,"article",5));else if(a.src.includes("ext_tw_video")){const c={};c.url=a.src,c.title=this.readerableFilename(b,"article"),c.quality="mp4",this.videos.push(c),this.setBadge()}else return}getTweetId(a,b){return this.getTweetData(a,b,/(?:https:\/\/[A-z.]*\/\w*\/status\/)(\d*)(?:\/?\w*)/g)}getTweetData(a,b,c){if(".tweet"===b)return a.data("tweet-id");if("article"===b){const b=a.querySelectorAll("a");for(let a=0;a<b.length;a++){const d=c.exec(b[a].href);if(d)return d[1]}}else if(b===modalCalss){const a=c.exec(window.location.href);if(a)return a[1]}}readerableFilename(a,b){return`${this.getTweetOwner(a,b)}-${this.getTweetId(a,b)}`}getTweetOwner(a,b){return this.getTweetData(a,b,/(?:https:\/\/[A-z.]*\/(\w*)\/status\/)(?:\d*)(?:\/?\w*)/g)}async processBlobVideo(a,b){const c=await this.getMp4Url("https://api.twitter.com/1.1/statuses/show.json?include_profile_interstitial_type=1&include_blocking=1&include_blocked_by=1&include_followed_by=1&include_want_retweets=1&include_mute_edge=1&include_can_dm=1&skip_status=1&cards_platform=Web-12&include_cards=1&include_ext_alt_text=true&include_reply_count=1&tweet_mode=extended&trim_user=false&include_ext_media_color=true&id="+a);c&&(this.videos.push({url:c,title:b,quality:"mp4"}),this.setBadge())}getMp4Url(a){return new Promise(b=>{var c={origin:"https://mobile.twitter.com",headers:{Accept:"*/*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Gecko/20100101 Firefox/62.0",authorization:"Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA","x-csrf-token":this.getCookie("ct0")},credentials:"include",referrer:"https://mobile.twitter.com"};chrome.runtime.sendMessage({action:"doFetch",method:"GET",init:c,url:a,json:!0},a=>{if(!a||!a.extended_entities||!a.extended_entities.media||!Array.isArray(a.extended_entities.media))return b("");let c=a.extended_entities.media[0].video_info.variants.filter(a=>"video/mp4"===a.content_type);c=c.sort((c,a)=>a.bitrate-c.bitrate);let d="";return c.length&&(d=c[0].url),b(d)})})}getCookie(a){for(var b,d=a+"=",e=decodeURIComponent(document.cookie),f=e.split(";"),g=0;g<f.length;g++){for(b=f[g];" "==b.charAt(0);)b=b.substring(1);if(0==b.indexOf(d))return b.substring(d.length,b.length)}return""}registerMediaUpdateListener(a){this.mediaUpdateListener=a}itinializeMessageListeners(){chrome.runtime.onMessage.addListener(a=>{"pageUpdated"===a.action&&($(`.${INIT_CLASS}`).removeClass(INIT_CLASS),this.videos=[],this.setBadge(),this.ids={},this.passMediaBack({videos:this.videos}))})}};