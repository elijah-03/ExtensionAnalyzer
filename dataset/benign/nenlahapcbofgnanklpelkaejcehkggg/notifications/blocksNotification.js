import{a as ae,c as se,d as ne,e as ie,h as _,i as ue}from"../chunks/chunk-Y42W4ZQD.js";import{b as ce}from"../chunks/chunk-G3WW6RJZ.js";import{a as me,b as de}from"../chunks/chunk-RVO3M5CT.js";import"../chunks/chunk-PFBRUDBV.js";import"../chunks/chunk-BDOU7XT6.js";import"../chunks/chunk-57TRHH3E.js";import{i as j,q as re}from"../chunks/chunk-HH5UG254.js";import{b as C}from"../chunks/chunk-EA7CGSTM.js";import{a as ee}from"../chunks/chunk-AGWLSUX4.js";import"../chunks/chunk-MFH6BM6M.js";import"../chunks/chunk-NT3RH36Y.js";import"../chunks/chunk-XH6MVEJG.js";import"../chunks/chunk-6JGDJAZ5.js";import{a as Z}from"../chunks/chunk-CQXN2NRJ.js";import"../chunks/chunk-IPZXBZPC.js";import{a as te,b as B,c as oe,d as I,e as F}from"../chunks/chunk-E2GNLB6L.js";import{a as le}from"../chunks/chunk-6ILBPYHJ.js";import"../chunks/chunk-GNZEMFDT.js";import"../chunks/chunk-J7QHBV67.js";import{b as V,d as b,e as q,g as m,h as d,i as Y}from"../chunks/chunk-VGEMM5MB.js";import"../chunks/chunk-JDV5FZKX.js";import"../chunks/chunk-WJZEHHRO.js";import"../chunks/chunk-HPSGHK7L.js";import"../chunks/chunk-GXPO46BF.js";import"../chunks/chunk-IYAFYZRF.js";import"../chunks/chunk-F2BE3OL5.js";import{a as z,b as J,c as N}from"../chunks/chunk-XZWN3GGK.js";import"../chunks/chunk-2Q63MOXU.js";import{a as U,b as R,e as x}from"../chunks/chunk-DPMK7ZVG.js";import"../chunks/chunk-D3B67B3M.js";import"../chunks/chunk-H6FSK4DZ.js";import"../chunks/chunk-TYA5STFG.js";import"../chunks/chunk-2GAAOKGQ.js";import{e as $,q as Q}from"../chunks/chunk-KJBXKQ52.js";import{h as r,j as D,k as A,n as i,o as h,t as X,v as y}from"../chunks/chunk-4XUWKJYA.js";import"../chunks/chunk-W7K6NY26.js";import"../chunks/chunk-QWQLNDJC.js";import"../chunks/chunk-WXGZPSEB.js";import{F as E,z as W}from"../chunks/chunk-K2PA57PF.js";import"../chunks/chunk-ECXCPAF6.js";import"../chunks/chunk-CBPLEXH3.js";import{c as G}from"../chunks/chunk-AYDLOBCW.js";import{a as H,c as De}from"../chunks/chunk-JENJKWHP.js";import"../chunks/chunk-53OM6ECF.js";import"../chunks/chunk-KUOYBGP4.js";import"../chunks/chunk-PDIOZR2P.js";import"../chunks/chunk-WO6N5TBT.js";import"../chunks/chunk-BTBTC4NL.js";import{e as f}from"../chunks/chunk-3GYLW4KZ.js";V();var k=f(W());Y();var pe=f(E()),Re=async()=>{let t=J("postcheckout-email-create-account-block-notification"),e=await N(t),a={rootEl:"div",logLevel:null},o=await F(),s={merchantName:o.host.merchant??""};return{config:a,content:e,data:s,...o}},_e=({onUnload:t})=>{let[e,a]=(0,k.useState)(),o=(0,k.useCallback)(async s=>{switch(s.type){case R.Destroy:t?.(),r.set(d.treeVisible,!1);break;case R.NotificationShow:h("track",d.metric,{action:"seen"});break;case R.NotificationDismiss:await C({message:b.dismiss}),h("track",d.metric,{action:"dismissed"}),r.set(d.treeVisible,!1);break;case R.Custom:s.eventName==="onCreateAccountClick"?(await C({message:b.clickedCreateAccount}),h("track",d.metric,{action:"clicked"})):s.eventName==="onSignInClick"&&(await C({message:b.clickedSignIn}),h("track",d.metric,{action:"signIn"})),r.set(d.treeVisible,!1),t?.();break}},[t]);return(0,k.useEffect)(()=>{Re().then(s=>{a(s),r.set(d.treeVisible,!0)}).catch(console.error)},[]),e?(0,pe.jsx)(x,{client:U.DESKTOP_WEB,config:e.config,content:e.content,data:e.data,user:e.user,onEvent:o,onRequest:I}):null};var he=async()=>y("getElasticityUserData");var ge=()=>y("getPostCheckoutExcludedDomains");var K=f(W()),P=f(G());var Ee=f(E());async function ve(){let[t,e,a,o]=await Promise.all([le(),Z(),j(),ae()]);t&&(r.set("pageViewId",window.__wb_page_view_id),r.set("session",P.default.get(t,"session")),r.set("events",P.default.get(t,"settings.events")),r.set("settings",P.default.get(t,"settings")),r.set("tabId",P.default.get(t,"tabId")),r.set("lexiFetchResponse",P.default.get(t,"lexiFetchResponse"))),r.merge({siteAPIData:e}),r.merge({cashback:a}),r.set("referralsOffer",o)}async function we(){await ve();let t=r.get("siteAPIData"),e=t?.siteData?.cashback?.reward||{},a=await chrome.storage.local.get("lastCouponSavings"),o=a?.lastCouponSavings,s=r.get("cashback"),n=r.get("referralsOffer"),l=z("post-checkout-referrals"),u=i("should_use_blocks_service")&&l?await N(l):void 0,v=u||await ce("desktopextension-postcheckout-referrals"),w={rootEl:"div",logLevel:null},S={senderBonus:n.senderBonus||0,maxReferralValue:n.maxReferralValue||0,referralLink:n.code?`${$}/${n.code}`:null,$savings:{couponSavings:o??0,cashbackActivated:!!s?.user?.activated,couponsActivated:o!=null},siteReward:e,couponSavings:a?.lastCouponSavings||0,throttleKey:"postcheckout_modal_referrals"},g=await F();return{config:w,content:v,data:S,...g}}function L({onUnload:t}){let[e,a]=(0,K.useState)();return(0,K.useEffect)(()=>{we().then(o=>a(o)).catch(console.error)},[]),e?(0,Ee.jsx)(x,{client:U.DESKTOP_WEB,config:e.config,content:e.content,host:e.host,user:e.user,data:e.data,onEvent:o=>{o.type==="sp-blocks-custom"&&o.eventName==="clickCopyLink"&&navigator.permissions.query({name:"clipboard-write"}).then(s=>{(s.state==="granted"||s.state==="prompt")&&e.data&&!(e.data instanceof Map)&&navigator.clipboard.writeText(e.data.referralLink)}),oe(o,t)},onRequest:I}):null}var Ce=f(G());De();V();Y();async function Ae(){let t=await C({message:"getEvents"}),e=Ce.default.chain(t).pickBy(u=>new Date().valueOf()-new Date(u).valueOf()<2592e6).value(),a=m.clickedSignIn in e&&new Date().valueOf()-new Date(e[m.clickedSignIn]).valueOf()<864e5;if(m.clickedSignUp in e&&new Date().valueOf()-new Date(e[m.clickedSignUp]).valueOf()<864e5||a)return!0;let s=m.seenPostCheckoutCreateAccount1 in e&&m.seenPostCheckoutCreateAccount2 in e&&m.seenPostCheckoutCreateAccount3 in e,n=new Date(Math.max(new Date(e[m.seenPostCheckoutCreateAccount1]||0).valueOf(),new Date(e[m.seenPostCheckoutCreateAccount2]||0).valueOf(),new Date(e[m.seenPostCheckoutCreateAccount3]||0).valueOf())),l=n&&new Date().valueOf()-n.valueOf()<864e5;return!!(s||l)}async function ke(){H("*** postCheckoutCreateAccount: evaluating...");let t=r.get(d.treeVisible);return ee()||t||await Ae()?!1:D(q.enabled)}var c=f(E());window.__wb_timing.blocksNotifRequireAt=performance.now();var M;function T(){M?.()}function p(t=!0){t&&Me(),T()}var Ne="blocks_cross_device",Ue={throttleKey:Ne},xe=["postcheckout_modal_dtm_xd_switch_","postcheckout_modal_dtm_xd_retarget_switch_"];function Be(){return xe.some(D)}var Pe=new Map([["amazon.com","ext_pcm_amz_check"]]);function Ie(t){return Pe.has(t)?!i(Pe.get(t)):!0}function Fe(t,e){return!!e&&e?.merchants[t]?.disabled}function Ke({dismissedNotifPastDay:t,createAccountThrottled:e,referralsThrottled:a,xSellThrottled:o,retargetingThrottled:s,userElasticity:n,retargetingExclusions:l,canShowRetargetingOnDomain:u}){let v=r.get("siteAPIData"),w=v?.tld||"";if(!e)return(0,c.jsx)(_e,{onUnload:T});let S=u&&!s&&Ie(w)&&!Fe(w,l);if(S&&Te()&&(S=!!n&&n.rate<=Le()),S){let g=i("ext_post_checkout_fallback_deals");if(t&&i("ext_pcm_dismiss_throttle_same_day"))h("page","postCheckoutNotification",{view:"pcm_dismiss_throttle"});else{if(i("ext_post_checkout_multi_offer_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-multi-ad-offer",providedData:{throttleKey:"post-checkout-multi-ad-offer"},onUnload:p,contentProps:{type:"recommended"}});if(i("ext_pcm_thresh_test_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-single-recommended-offer",providedData:{throttleKey:"post-checkout-single-recommended-offer"},onUnload:p,contentProps:{type:"threshold"}});if(i("ext_pcm_retargeting_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-retargeting",providedData:{throttleKey:"post-checkout-retargeting"},onUnload:p,contentProps:{type:"deals",fillWithFallback:g}});if(i("ext_pcm_retargeting_product_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-retargeting-products",providedData:{throttleKey:"post-checkout-retargeting-products"},onUnload:p,contentProps:{type:"products",fillWithFallback:g}});if(i("ext_pcm_retargeting_multi_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-retargeting-multi",providedData:{throttleKey:"post-checkout-retargeting-multi"},onUnload:p,contentProps:{type:"multi",fillWithFallback:g}});if(i("ext_post_checkout_non_vm_feed_cta_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-retargeting-single_offer",providedData:{throttleKey:"post-checkout-retargeting-single_offer"},onUnload:p,contentProps:{type:"deals",fillWithFallback:g}});if(i("ext_post_checkout_recommended_offers_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-recommended-offers",providedData:{throttleKey:"post-checkout-recommended-offers"},onUnload:p,contentProps:{type:"recommended"}});if(i("ext_post_checkout_recommended_offers_single_cta_v_2"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-single-recommended-offer",providedData:{throttleKey:"post-checkout-single-recommended-offer"},onUnload:p,contentProps:{type:"recommended"}});if(i("ext_post_checkout_recommended_single_product_v_3"))return(0,c.jsx)(_,{blocksSlug:"post-checkout-single-recommended-product",providedData:{throttleKey:"post-checkout-single-recommended-product"},onUnload:p,contentProps:{type:"recommendedProducts"}})}}return!o&&Be()?(0,c.jsx)(ue,{contentSlug:"blocks-notification",blocksSlug:"blocks-notification",onUnload:T,providedData:Ue,includeTopDeals:!0}):i("desktopextension_postcheckout_referrals")&&D("postcheckout_modal_desktop_ref_switch_")&&!a?(0,c.jsx)(L,{onUnload:T}):null}function Te(){return i("ext_pcm_threshold_switch")}function Le(){return A("ext_pcm_threshold_rate_",10)}var Se="postcheckout_modal_retargeting";function Me(){te(Se)}function Ge(){return A("postcheckout_modal_dtm_xd_06242025_",30*24*60)*6e4}function He(){return A("desktop_ext_pcm_referrals_throttle_days_",7)*864e5}async function Ve(){T();let t=await qe();Ye(t);let e=await ke(),[a,o,s,n,l,u]=await Promise.all([re(),B(He(),"postcheckout_modal_referrals"),B(Ge(),"blocks_cross_device_throttle"),B(2*864e5,Se),Te()?he():void 0,ge()]);M=(await Q({appName:"blocksNotification",blankSlate:!0,app:(0,c.jsx)(Ke,{dismissedNotifPastDay:a,createAccountThrottled:!e,referralsThrottled:o,xSellThrottled:s,retargetingThrottled:n,userElasticity:l,retargetingExclusions:u,canShowRetargetingOnDomain:t.canShowRetargeting})})).unloadApp}async function qe(){let t=r.get("siteAPIData"),e=t?.tld;return await se(["products","deals","multi","recommended","threshold","recommendedProducts"],e)}function Ye(t){let e=!1,a=Object.keys(t).reduce((n,l)=>{if(!ne(l,t[l]))return n;let u=t[l]?.length||0;return e=e||u>0,n[`${l}Retargeting`]=u,n},{}),o=e?"offers_available":"no_offers_available",s=JSON.stringify({offers:a,df:t.df??[],dnf:ie(t),canShowRetargeting:t.canShowRetargeting});h("page","postCheckoutNotification",{view:o,meta:s})}async function Oe(){try{let t=i("ext_debug_blocks_notifs"),e=await X(),{pageType:a}=e||{},o=await me(e,["productPage"]);if(o){T();let n=await de(o);n&&(M=n.unloadApp);return}if(!(t||a==="confirmationPage"))return;await Ve()}catch(t){console.error(t)}}document.readyState!=="loading"?Oe():document.addEventListener("DOMContentLoaded",Oe);export{He as getPCMReferralsThrottleDuration};
