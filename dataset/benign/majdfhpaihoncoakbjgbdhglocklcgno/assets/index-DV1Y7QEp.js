import{o as m,_ as l,n as x,i as b,S,b as y,c as E,e as O,g as _,f as A,a as k,h as D,u as L}from"./index-scyfHB5A.js";import{S as C,b as g,m as B}from"./index-DA4uJ5Kf.js";var f=(s=>(s[s.not_active=0]="not_active",s[s.control=1]="control",s[s.test=2]="test",s))(f||{}),u=(s=>(s[s.not_active=0]="not_active",s[s.active=1]="active",s[s.complited=2]="complited",s))(u||{}),c=(s=>(s.promoBannerClose="abtest_promo_banner_close",s.onboardingExitOffer="abtest_exit_offer_on_onboarding_v2",s))(c||{});const I=m({group:x(),experiment_slug:l(c),status:l(u)}),W=m({experiments:b(I),updatedAt:x()}),F=m({config:W.optional().describe(S.persist),ongoingExperiments:b(l(c)).optional().describe(S.persist)}).default({}),j=new y(F),K="https://split-tool.com/api/application-experiment/bulk-group/",Y="e9efc93ef559ff3064712c2a3399aff66eb8",h="https://veepn.com/",d="https://fake-veepn.com/",p="veepn-ab-tests",$=1440*60*1e3;class o extends C{constructor(e,i,t,n,a){super(),this.bundleSettings=e,this.testStorage=i,this.globalStateService=t,this.fetchService=n,this.analyticsService=a}async boot(){if(await this.testStorage.sync(),(this.testStorage.state.config?.updatedAt??0)+$<Date.now()){const t=Object.values(this.bundleSettings).map(a=>a.experimentSlug),n=await this.fetchExperimentsConfigs(t);n.length>0?(await this.setExperimentsConfigs(n),await this.updateActiveExperiment()):await this.clearExperimentsData()}this.bootResolve(),await this.bootPromise}getExperimentStatus(e){const{config:i,ongoingExperiments:t}=this.testStorage.state;if(!i||!t)return{active:!1};const n=i.experiments.find(({experiment_slug:a})=>a===e);return n?n.group>=f.test&&n.status===u.active&&t.includes(e)?{active:!0,group:n.group}:n.group>=f.test&&n.status===u.complited?{active:!0,group:n.group}:{active:!1}:{active:!1}}async initExperiments(e){const i=Object.values(this.bundleSettings).map(r=>r.experimentSlug),t=await o.getOngoingExperimentsCookie(),n=Object.values(this.bundleSettings).filter(r=>r.initReasons.includes(e)).map(r=>r.experimentSlug),a=[...new Set([...n,...t])].filter(r=>i.includes(r));await this.setOngoingExperiments(a),await this.updateActiveExperiment()}async updateActiveExperiment(){const{config:e,ongoingExperiments:i}=this.testStorage.state;if(!e||!i){await this.removeActiveExperiment();return}const t=e.experiments.find(n=>n.status===u.active);t&&i.includes(t.experiment_slug)?await this.setActiveExperiment(t):await this.removeActiveExperiment()}async clearExperimentsData(){await this.removeOngoingExperiments(),await this.removeActiveExperiment(),await this.removeExperimentsConfigs()}async fetchExperimentsConfigs(e){if(e.length===0)return[];const i={bundle_id:Y,udid:this.globalStateService.udid.value,experiment_name:e.join(", "),language:"en"},t=await this.fetchService.request({url:K,method:"POST",body:i});return t.success?t.data:[]}async setExperimentsConfigs(e){await this.testStorage.setItems({config:{experiments:e,updatedAt:Date.now()}})}async removeExperimentsConfigs(){await this.testStorage.setItems({config:{experiments:[],updatedAt:Date.now()}})}async setActiveExperiment(e){await this.analyticsService.setExperiment({slug:e.experiment_slug,group:e.group});const i=await o.getActiveExperimentWebsiteCookie(e.experiment_slug);i&&i.group===e.group&&(await o.setActiveExperimentWebsiteCookie([{slug:e.experiment_slug,group:e.group}]),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:`${e.experiment_slug}_group_${e.group}`,data:{test_name:e.experiment_slug,user_group:e.group}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"exp_group",data:{event_properties__exp_id:e.experiment_slug,event_properties__exp_var:e.group.toString()}}))}async removeActiveExperiment(){await this.analyticsService.removeExperiment(),await o.removeActiveExperimentWebsiteCookie()}async setOngoingExperiments(e){await this.testStorage.setItems({ongoingExperiments:e}),await o.setOngoingExperimentsCookie(e)}async removeOngoingExperiments(){await this.testStorage.setItems({ongoingExperiments:[]}),await o.removeOngoingExperimentsCookie()}static async getActiveExperimentWebsiteCookie(e){const i=new URL(h),t=await g.cookies.get({name:p,url:i.href});if(t)try{return JSON.parse(t.value).find(r=>r.slug===e)}catch{return}}static async setActiveExperimentWebsiteCookie(e){const i=new URL(h),t=new Date;t.setFullYear(t.getFullYear()+1),await g.cookies.set({name:p,value:JSON.stringify(e),url:i.href,domain:`.${i.hostname}`,expirationDate:t.getTime()/1e3})}static async removeActiveExperimentWebsiteCookie(){const e=new URL(h);await g.cookies.remove({name:p,url:e.href})}static async getOngoingExperimentsCookie(){const e=new URL(d),i=await g.cookies.get({name:p,url:e.href});if(!i)return[];try{const t=JSON.parse(i.value);return Array.isArray(t)&&t.every(n=>typeof n=="string")?t:[]}catch{return[]}}static async setOngoingExperimentsCookie(e){const i=new URL(d),t=new Date;t.setFullYear(t.getFullYear()+1),await g.cookies.set({name:p,value:JSON.stringify(e),url:i.href,domain:`.${i.hostname}`,expirationDate:t.getTime()/1e3})}static async removeOngoingExperimentsCookie(){const e=new URL(d);await g.cookies.remove({name:p,url:e.href})}}const J=new E("test",j,O),V={[c.promoBannerClose]:{experimentSlug:c.promoBannerClose,initReasons:["install","update"]},[c.onboardingExitOffer]:{experimentSlug:c.onboardingExitOffer,initReasons:["install"]}},H=new o(V,J,_,A,k),w=4320*60*1e3,q=300*1e3;var v=(s=>(s.discount="discount",s.trial="trial",s))(v||{});const z=m({active:D(),startedAt:x(),type:l(v)}),Q=m({banner:z.optional().describe(S.session)}).default({}),U=new y(Q);class Z extends C{constructor(e,i,t,n,a){super(),this.introOfferStorage=e,this.globalStateService=i,this.messageService=t,this.userService=n,this.abTestsService=a}get introOfferType(){const e=this.abTestsService.getExperimentStatus(c.onboardingExitOffer);return e.active&&e.group===f.test?v.trial:v.discount}get active(){const e=this.userService.userType==="free",i=this.globalStateService.installedAt+w,t=Date.now()<i;return e&&t}get data(){return{active:this.active,endedAt:this.globalStateService.installedAt+w,type:this.introOfferType}}get banner(){const{banner:e}=this.introOfferStorage.state;return e?{...e,active:e.active&&this.active}:{active:!1,startedAt:Date.now(),type:this.introOfferType}}async boot(){await this.introOfferStorage.sync(),this.bootResolve(),await this.bootPromise}async activateBanner(){await this.introOfferStorage.setItems({banner:{startedAt:Date.now()+q,active:!0,type:this.introOfferType}}),this.messageService.notifyTab({type:"intro-offer-banner-state-change",success:!0,data:this.banner})}async deactivateBanner(){await this.introOfferStorage.removeItems("banner"),this.messageService.notifyTab({type:"intro-offer-banner-state-change",success:!0,data:this.banner})}}const R=new E("intro-offer",U,O),T=new Z(R,_,B,L,H);export{c as E,v as I,H as a,T as i};
