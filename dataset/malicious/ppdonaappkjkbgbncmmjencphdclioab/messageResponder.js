"use strict";!function(e){let t=e.ext||require("ext_background");const{port:i}=require("messaging"),{Prefs:r}=require("prefs"),{Utils:n}=require("utils"),{FilterStorage:o}=require("filterStorage"),{FilterNotifier:l}=require("filterNotifier"),{defaultMatcher:s}=require("matcher"),{ElemHideEmulation:a}=require("elemHideEmulation"),{Notification:u}=require("notification"),{Filter:f,BlockingFilter:p,RegExpFilter:c}=require("filterClasses"),{Synchronizer:d}=require("synchronizer"),g=require("info"),{Subscription:b,DownloadableSubscription:m,SpecialSubscription:h}=require("subscriptionClasses");function w(e,t){let i={};for(let r of e)r in t&&(i[r]=t[r]);return i}function x(e){let t=w(["disabled","downloadStatus","homepage","lastDownload","title","url"],e);return e instanceof h&&(t.filters=e.filters.map(y)),t.isDownloading=d.isExecuting(e.url),t}let y=w.bind(null,["text"]),q=new t.PageMap,S=Object.create(null),k=Object.create(null),D=new Map([["app","app.respond"],["filter","filters.respond"],["pref","prefs.respond"],["subscription","subscriptions.respond"]]);function F(e,t,...i){let r=q.keys();if(0==r.length)return;let n=[];for(let e of i)e instanceof b?n.push(x(e)):e instanceof f?n.push(y(e)):n.push(e);for(let i of r){let r=q.get(i)[e];r&&-1!=r.indexOf(t)&&i.sendMessage({type:D.get(e),action:t,args:n})}}function R(e,t){for(let i of t){let t;t="filter"==e&&"loaded"==i?"load":e+"."+i,t in k||(k[t]=null,l.on(t,((...t)=>{F(e,i,...t)})))}}function L(e){let t=q.get(e);return t||(t=Object.create(null),q.set(e,t)),t}i.on("app.get",((e,t)=>{if("issues"==e.what){let e=function(e){try{return require(e)}catch(e){return null}}("subscriptionInit");return{filterlistsReinitialized:!!e&&e.reinitialized}}if("doclink"==e.what)return n.getDocLink(e.link);if("localeInfo"==e.what){let e;if("chromeRegistry"in n){e=n.chromeRegistry.isLocaleRTL("adblockplus")?"rtl":"ltr"}else e=n.readingDirection;return{locale:n.appLocale,bidiDir:e}}return"features"==e.what?{devToolsPanel:"chromium"==g.platform}:g[e.what]})),i.on("app.listen",((e,t)=>{L(t.page).app=e.filter})),i.on("app.open",((e,i)=>{"options"==e.what&&t.showOptions((()=>{e.action&&F("app",e.action,...e.args)}))})),i.on("filters.add",((e,t)=>{let i=require("filterValidation").parseFilter(e.text),r=[];return i.error?r.push(i.error.toString()):i.filter&&o.addFilter(i.filter),r})),i.on("filters.blocked",((e,t)=>s.matchesAny(e.url,c.typeMap[e.requestType],e.docDomain,e.thirdParty)instanceof p)),i.on("filters.get",((e,t)=>{if("elemhideemulation"==e.what){let e=[];const{checkWhitelisted:i}=require("whitelisting");let n=i(t.page,t.frame,c.typeMap.DOCUMENT|c.typeMap.ELEMHIDE);if(r.enabled&&!n){let{hostname:i}=t.frame.url;e=a.getRulesForDomain(i),e=e.map((e=>({selector:e.selector,text:e.text})))}return e}let i=b.fromURL(e.subscriptionUrl);return i?i.filters.map(y):[]})),i.on("filters.importRaw",((e,t)=>{let i=require("filterValidation").parseFilters(e.text),r=[];for(let e of i.errors)"unexpected-filter-list-header"!=e.type&&r.push(e.toString());if(r.length>0)return r;let n=Object.create(null);for(let e of i.filters)o.addFilter(e),n[e.text]=null;if(!e.removeExisting)return r;for(let e of o.subscriptions)if(e instanceof h)for(let t=e.filters.length-1;t>=0;t--){let i=e.filters[t];/^@@\|\|([^/:]+)\^\$document$/.test(i.text)||(i.text in n||o.removeFilter(i))}return r})),i.on("filters.listen",((e,t)=>{L(t.page).filter=e.filter,R("filter",e.filter)})),i.on("filters.remove",((e,t)=>{let i=f.fromText(e.text),r=null;e.subscriptionUrl&&(r=b.fromURL(e.subscriptionUrl)),r?o.removeFilter(i,r,e.index):o.removeFilter(i)})),i.on("prefs.get",((e,t)=>r[e.key])),i.on("prefs.listen",((e,t)=>{L(t.page).pref=e.filter;for(let t of e.filter)t in S||(S[t]=null,r.on(t,(()=>{F("pref",t,r[t])})))})),i.on("prefs.toggle",((e,t)=>{"notifications_ignoredcategories"==e.key?u.toggleIgnoreCategory("*"):r[e.key]=!r[e.key]})),i.on("subscriptions.add",((e,i)=>{let r=b.fromURL(e.url);"title"in e&&(r.title=e.title),"homepage"in e&&(r.homepage=e.homepage),e.confirm?t.showOptions((()=>{F("app","addSubscription",r)})):(r.disabled=!1,o.addSubscription(r),r instanceof m&&!r.lastDownload&&d.execute(r))})),i.on("subscriptions.get",((e,t)=>o.subscriptions.filter((t=>(!e.ignoreDisabled||!t.disabled)&&(!!(t instanceof m&&e.downloadable)||!!(t instanceof h&&e.special)))).map(x))),i.on("subscriptions.listen",((e,t)=>{L(t.page).subscription=e.filter,R("subscription",e.filter)})),i.on("subscriptions.remove",((e,t)=>{let i=b.fromURL(e.url);i.url in o.knownSubscriptions&&o.removeSubscription(i)})),i.on("subscriptions.toggle",((e,t)=>{let i=b.fromURL(e.url);i.url in o.knownSubscriptions?i.disabled||e.keepInstalled?i.disabled=!i.disabled:o.removeSubscription(i):(i.disabled=!1,i.title=e.title,i.homepage=e.homepage,o.addSubscription(i),i.lastDownload||d.execute(i))})),i.on("subscriptions.update",((e,t)=>{let{subscriptions:i}=o;e.url&&(i=[b.fromURL(e.url)]);for(let e of i)e instanceof m&&d.execute(e,!0)}))}(this);