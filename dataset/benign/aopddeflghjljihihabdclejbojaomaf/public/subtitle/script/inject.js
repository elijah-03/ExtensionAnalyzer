const I=new Map([[/youtube\.com\/api\/timedtext/i,"youtube"],[/cf-timedtext\.aux\.pv-cdn\.net/i,"primevideo"],[/hls\.ted\.com\/project_masters\/.*?\/subtitles\/.*?\/full\.vtt/i,"ted"],[/coursera\.org\/api\/subtitleAssetProxy/i,"coursera"],[/khanacademy\.org\/api\/internal\/graphql\/GetSubtitles/i,"khanacademy"]]),H=new Map([[/youtube\.com\/youtubei\/v1\/player/i,"youtube"],[/atv-ps-eu\.amazon\.co\.uk\/cdp\/catalog\/GetPlaybackResources/i,"primevideo"]]);function g(t){for(const[e,s]of I)if(e.test(t))return s;return null}function y(t){for(const[e,s]of H)if(e.test(t))return s;return null}const d=XMLHttpRequest.prototype,v=d.open,R=d.send,w=d.setRequestHeader,E=window.fetch;function O(t){return{eventType:t.eventType,source:"inject",data:{...t}}}function f(t){try{const e=O(t);window.postMessage(e,window.location.origin)}catch{}}function T(){d.open=function(t,e,s,i,a){const n=this;return n._method=t,n._url=typeof e=="string"?e:e.toString(),n._requestHeaders={},n._startTime=new Date().toISOString(),v.call(this,t,e,s??!0,i,a)},d.setRequestHeader=function(t,e){const s=this;return s._requestHeaders||(s._requestHeaders={}),s._requestHeaders[t]=e,w.apply(this,[t,e])},d.send=function(t){const e=this;return this.addEventListener("load",function(){var h,l,u,c;const s=g(e._url||""),i=y(e._url||""),a={};try{const o=this.getAllResponseHeaders();o&&o.split(`\r
`).forEach(p=>{const r=p.split(": ");r.length===2&&(a[r[0].toLowerCase()]=r[1])})}catch(o){console.warn("获取响应头失败:",o)}let n=null;try{this.responseType===""||this.responseType==="text"?n=this.responseText:this.responseType==="json"?n=JSON.stringify(this.response):this.responseType==="document"&&(n=this.responseXML?this.responseXML.documentElement.outerHTML:null)}catch(o){console.warn("获取响应数据失败:",o);return}if(n)if(s){const o=((l=(h=e._url)==null?void 0:h.split("?")[1])==null?void 0:l.split("&"))||[],p=((u=o.find(r=>r.startsWith("tlang=")))==null?void 0:u.split("=")[1])||((c=o.find(r=>r.startsWith("lang=")))==null?void 0:c.split("=")[1]);if(s==="youtube"){const r=new URL(e._url||"").searchParams.get("v"),_=new URL(location.href).searchParams.get("v");(r===_||!_)&&f({eventType:"ANYDOC_SUBTITLE_DATA",site:s,videoId:_||void 0,data:n,url:e._url||"",method:e._method||"",language:p,requestHeaders:e._requestHeaders||{},responseHeaders:a})}else f({eventType:"ANYDOC_SUBTITLE_DATA",site:s,data:n,url:e._url||"",method:e._method||"",language:p,requestHeaders:e._requestHeaders||{},responseHeaders:a})}else i&&f({eventType:"ANYDOC_VIDEO_INFO",site:i,data:n,url:e._url||"",method:e._method||"",requestHeaders:e._requestHeaders||{},responseHeaders:a})}),R.apply(this,[t])}}function m(){window.fetch=async function(t,e){const s=typeof t=="string"?t:t.url,i=y(s),a={},n=await E(t,e);if(i&&n.ok){const l=await n.clone().text(),u={};if(n.headers.forEach((c,o)=>{u[o.toLowerCase()]=c}),i){const c=new URL(s).searchParams.get("v");f({eventType:"ANYDOC_VIDEO_INFO",site:i,videoId:c||void 0,data:l,url:s,method:(e==null?void 0:e.method)||t.method||"GET",language:"",requestHeaders:a,responseHeaders:u})}}return n}}(function(){T(),m()})();typeof window<"u"&&(T(),m());
