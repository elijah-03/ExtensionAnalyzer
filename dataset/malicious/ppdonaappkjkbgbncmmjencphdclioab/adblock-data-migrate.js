MigrateLegacyData=function(){require("filterNotifier").FilterNotifier;var t=require("prefs").Prefs,e="migrateLogMessageKey",i="Date migrated: "+new Date+" \n",n=function(){var t=Array.prototype.slice.call(arguments);i=i+t.join(" ")+"\n",ext.storage.set(e,i)},s=function(t,e){if("boolean"==typeof t)return t},o=function(t){var e=window.SAFARI?safari.extension.settings:localStorage;if(void 0!==e){var i=e.getItem(t);if(null!=i)try{return JSON.parse(i)}catch(i){return n("Deleting item, couldn't parse json for "+t),void e.removeItem(t)}}},r=function(t,e){var i=window.SAFARI?safari.extension.settings:localStorage;if(void 0!==e)try{i.setItem(t,JSON.stringify(e))}catch(t){n(t)}else i.removeItem(t)};!function(e){var i=o("filter_lists");if(!i||i.length<1)return SubscriptionInit.init(),void(e&&e());require("subscriptionInit").setSubscriptionsCallback((function(s){for(var o in t.suppress_first_run_page=!0,s=[],i){var a=i[o];a.subscribed&&a.url&&s.push(Subscription.fromURL(a.url))}return r("filter_lists",void 0),r("last_subscriptions_check",void 0),n("Done migrating subscriptions.  Migrated count: ",s.length),SubscriptionInit.init(),e&&e(),s}))}((function(){var t,e;!function(){var t=o("custom_filters");if(t){var e=t.split("\n");t=(e=e.filter((function(t){return""!==t}))).join("\n");var i=parseFilters(t);if(i&&i.filters){for(var s=0;s<i.filters.length;s++){var a=i.filters[s];a&&FilterStorage.addFilter(a)}n("Migrated custom filters, count: ",i.filters.length),r("custom_filters",void 0)}if(i&&i.errors&&i.errors.length>0){var l=[];for(l.push(translate("custom_filters_migration_error_message_part1")+i.errors.length),l.push(" "),l.push(translate("custom_filters_migration_error_message_part2")),l.push(" "),s=0;s<i.errors.length;s++){var u=i.errors[s];u.lineno&&l.push(translate("custom_filters_migration_error_message_part3")+e[u.lineno-1]),l.push(u.toString()),l.push(" ")}var c=l.join("\n");n(c),ext.storage.set("custom_filters_errors",c)}}}(),(e=o(t="custom_filter_count")||"")&&(ext.storage.set(t,e),n("Done migrating custom filters count cache."),r(t,void 0)),function(){var t="exclude_filters",e=o(t)||"";e&&(ext.storage.set(t,e),r(t,void 0),n("Done migrating exclude / disable filters."))}(),ext.storage.get("malware_list",(function(t){t&&t.malware_list&&(ext.storage.remove("malware_list"),!0===t.malware_list.subscribed&&(FilterStorage.addSubscription(malwareSub),malwareSub instanceof DownloadableSubscription&&Synchronizer.execute(malwareSub)))}))})),t.untilLoaded.then((function(){var e,i;(i=o(e="blockage_stats"))?(void 0!==i.start&&"number"==typeof i.start||(i.start=Date.now()),void 0!==i.version&&"number"==typeof i.version||(i.version=1),void 0!==i.total&&"number"==typeof i.total||(i.total=0),t.blocked_total=i.total,delete i.total,ext.storage.set(e,i),r(e,void 0),n("migrated Legacy Blockage Stats")):ext.storage.get(e,(function(t){t.blockage_stats||((i={}).start=Date.now(),i.version=1,ext.storage.set(e,i))})),function(){function e(){var t=o("settings");t?(this._data=$.extend({debug_logging:!1,youtube_channel_whitelist:!1,show_context_menu_items:!0,show_advanced_options:!1,display_stats:!0,display_menu_stats:!0,show_block_counts_help_link:!0,dropbox_sync:!1,show_survey:!0},t),this.needsMigration=!0):this.needsMigration=!1}e.prototype={set:function(t,e){this._data[t]=e;var i=o("settings")||{};i[t]=e,r("settings",i)},get_all:function(){return this._data}};var i=new e;if(t.hidePlaceholders=!0,i&&i.needsMigration){var a=i.get_all();t.shouldShowBlockElementMenu=s(a.show_context_menu_items),t.show_statsinicon=s(a.display_stats),t.show_statsinpopup=s(a.display_menu_stats),_settings.onload().then((function(){setSetting("debug_logging",s(a.debug_logging),(function(){setSetting("youtube_channel_whitelist",s(a.youtube_channel_whitelist),(function(){setSetting("show_advanced_options",s(a.show_advanced_options),(function(){setSetting("show_advanced_options",s(a.show_advanced_options),(function(){setSetting("show_block_counts_help_link",s(a.show_block_counts_help_link),(function(){setSetting("show_survey",s(a.show_survey),(function(){setSetting("data_collection",s(a.data_collection),(function(){r("settings",void 0),n("migrated Legacy Settings")}))}))}))}))}))}))}))}))}}()})),function(){for(var t=1,e=[STATS.userIDStorageKey,STATS.totalPingStorageKey,STATS.nextPingTimeStorageKey],i=["string","number","number"],s=0;s<e.length;s++){var a=e[s],l=o(a);l&&(typeof l===i[s]&&(ext.storage.set(a,l),n("migrated Legacy data, key: "+a+", value: "+l),t=2e3),r(a,void 0))}window.setTimeout((function(){STATS.startPinging(),uninstallInit()}),t)}()}();