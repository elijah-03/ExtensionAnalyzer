let e=null,r=new Array,a=new Map;const t=(e=0)=>{if(r.length<=e)return;const s=r[e];if(!s)return r.splice(e,1),t(e);const n=a.get(s.iframe.src);if(void 0===n||0===n)return t(e+1);if(2===n)return r.splice(e,1),s.reject(new Error("Iframe failed to load")),t(e);try{s.messageData.iframeSrc=s.iframe.src,s.iframe.contentWindow?.postMessage(s.messageData,s.iframe.src),s.resolve(s.messageData.id)}catch(e){console.error("Error posting message to iframe:",e),s.reject(e)}finally{r.splice(e,1),t(e)}};chrome.runtime.onConnect.addListener(s=>{"offscreen-communication"===s.name&&(s.onMessage.addListener(async n=>{e=s,await(async(e,s)=>{let n;try{if("CONTENTSCRIPT_TO_FEATURE"===e.direction&&e.iframeUrl){const{iframeID:s,iframeSrc:n}={iframeID:(i=e.iframeUrl).split("/")[1],iframeSrc:`chrome-extension://${chrome.runtime.id}/${i}`};let c=document.getElementById(s);c||(((e,r)=>{try{const t=document.createElement("iframe");t.src=r,t.id=e,t.style.width="100%",t.style.height="100%",t.onerror=()=>a.set(t.src,2),document.body.appendChild(t)}catch(e){console.error("Error adding iframe:",e)}})(s,n),c=document.getElementById(s)),await((e,a)=>new Promise((s,n)=>{r.push({messageData:a,iframe:e,resolve:s,reject:n}),t()}))(c,e)}else n=await(async e=>{switch(e.direction){case"CONTENTSCRIPT_TO_FEATURE":return{data:"Message coming from offscreen document"};case"CONTENTSCRIPT_TO_OFFSCREENDOCUMENT":return{data:"Message was intended for Offscreen Document"};case"FEATURE_TO_CONTENTSCRIPT":return{data:e};default:return null}})(e)}catch(e){console.error("Error handling incoming message:",e)}var i;n&&s.postMessage(n)})(n,s)}),s.onDisconnect.addListener(()=>{}))}),window.__iframeMessageListenerRegistered||(window.addEventListener("message",r=>{const{iframeSrc:s,direction:n,command:i}=r.data||{};if(s)switch(n){case"FEATURE_TO_CONTENTSCRIPT":e&&e.postMessage(r.data);break;case"FEATURE_TO_OFFSCREENDOCUMENT":"initialized"===i&&a.set(s,1),t()}}),window.__iframeMessageListenerRegistered=!0);
