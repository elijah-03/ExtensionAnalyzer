var backgroundPage=ext.backgroundPage.getWindow(),require=backgroundPage.require,Prefs=require("prefs").Prefs,subscriptionClasses=require("subscriptionClasses"),Subscription=subscriptionClasses.Subscription,FilterStorage=require("filterStorage").FilterStorage,FilterNotifier=require("filterNotifier").FilterNotifier,options=parseUri.parseSearch(document.location.search),tabId=options.tabId.replace(/[^0-9]/g,""),extensionsDisabled=[],subscriptionsNodes=[],unsubscribedDefaultFilters=[],contact="",updateFiltersClicked=!1,recordMessage=function(e){e&&backgroundPage.recordAdreportMessage(e)};function sendReport(){var e=$("#step_report_name"),t=$("#step_report_email"),s=$("#step_report_location"),n=$("#step_report_filter"),a=0;if($("#screen_capture_file_label").css("color","black"),t.removeClass("inputError"),e.removeClass("inputError"),$("#step_response_error").parent().fadeOut(),$("#step_response_success").parent().fadeOut(),$("#adreport_missing_info").hide(),$("#adreport_missing_screenshot").hide(),""===e.val()&&(a++,e.addClass("inputError"),$("#adreport_missing_info").show()),""!==t.val()&&-1!==t.val().search(/^.+@.+\..+$/)||(a++,t.addClass("inputError"),$("#adreport_missing_info").show()),0===$("#screen_capture_file")[0].files.length&&($("#adreport_missing_screenshot").show(),a++,$("#screen_capture_file_label").css("color","#f00")),a)$("html, body").animate({scrollTop:$("#adreport_missing_info").offset().top},2e3);else{var r={title:"Ad Report",name:e.val(),email:t.val(),location:s.val(),filter:n.val(),debug:debugInfo,url:""},i="";options.url&&(i=parseUri(options.url).hostname,r.title=r.title+": "+i,r.url=options.url);for(var o=[],l=$('span[class="answer"]'),c=$('div[class="section"]:visible'),p=Math.min(l.length,c.length),u=0;u<p;u++)o.push(u+1+"."+c[u].id+": "+l[u].getAttribute("chosen"));r.answers=o.join("\n");var d=function(){chrome&&chrome.permissions&&chrome.permissions.request?chrome.permissions.request({permissions:["management"]},(function(e){if(!e)return r.extensions="Permission not granted",void f();chrome.management.getAll((function(e){for(var t=[],s=0;s<e.length;s++)t.push("Number "+(s+1)),t.push("  name: "+e[s].name),t.push("  id: "+e[s].id),t.push("  version: "+e[s].version),t.push("  enabled: "+e[s].enabled),t.push("  type: "+e[s].type),t.push("");r.extensions=t.join("\n"),chrome.permissions.remove({permissions:["management"]},(function(e){})),f()}))})):(r.extensions="Extension information not avaiable",f())},f=function(){var e=new FormData;e.append("ad_report",JSON.stringify(r)),$("#screen_capture_file")[0].files.length>0&&e.append("screencapturefile",$("#screen_capture_file")[0].files[0]),$("#debug-info").val(createReadableReport(r))};if(chrome&&chrome.tabs&&chrome.tabs.detectLanguage){var h=-1;try{h=parseInt(tabId)}catch(e){return r.language="unknown",void d()}chrome.tabs.detectLanguage(h,(function(e){e&&(r.language=e),d()}))}else r.language="unknown",d()}}$((function(){localizePage(),recordMessage("open"),$(window).unload((function(){updateFiltersClicked||recordMessage("update_filters_not_clicked")}));var e=backgroundPage.getAllSubscriptionsMinusText();for(var t in e)e[t].subscribed||e[t].user_submitted||(unsubscribedDefaultFilters[t]=e[t]);var s=function(e){backgroundPage.fetch(e).then((function(e){return e.text()})).then((function(e){for(var t=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("subscription"),s=0;s<t.length;s++){var n=t[s];n&&subscriptionsNodes.push(n)}}))};s("subscriptions.xml"),s("adblock-subscriptions.xml");SAFARI?$(".chrome_only").hide():($(".safari_only").hide(),$("li[i18n='disableforchromestepone']").find("a").click((function(){OPERA?chrome.tabs.create({url:"opera://extensions/"}):chrome.tabs.create({url:"chrome://extensions/"})})));var n=$("#step_language_lang option");n.sort((function(e,t){return e.text?t.text&&e.value?t.value?"lang_english"==e.getAttribute("i18n")?-1:"lang_english"==t.getAttribute("i18n")||e.text>t.text?1:-1:-1:1:-1})),$("#step_language_lang").empty().append(n),n[0].selected=!0,$("#step_update_filters_DIV").show(),$("#UpdateFilters").click((function(){$(this).prop("disabled",!0),recordMessage("update_filters_click"),updateFiltersClicked=!0,backgroundPage.updateFilterLists(),$(".afterFilterUpdate input").prop("disabled",!1),$(".afterFilterUpdate").removeClass("afterFilterUpdate")})),$("#step_update_filters_no").click((function(){recordMessage("update_filters_no"),$("#step_update_filters").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("adalreadyblocked"))})),$("#step_update_filters_yes").click((function(){recordMessage("update_filters_yes"),$("#step_update_filters").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>");var e=backgroundPage.getAllSubscriptionsMinusText();e&&e.acceptable_ads&&e.acceptable_ads.subscribed?($("#step_update_aa_DIV").show(),$(".odd").css("background-color","#f8f8f8")):($("#step_disable_extensions_DIV").fadeIn().css("display","block"),$(".even").css("background-color","#f8f8f8"))})),$("#DisableAA").click((function(){$(this).prop("disabled",!0),recordMessage("disable_aa_click"),setTimeout((function(){var e=Subscription.fromURL(Prefs.subscriptions_exceptionsurl);FilterStorage.removeSubscription(e),$(".afterDisableAA input").prop("disabled",!1),$(".afterDisableAA").removeClass("afterDisableAA")}),1)})),$("#step_update_aa_no").click((function(){recordMessage("disable_aa_no"),$("#step_update_aa").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("aamessageadreport")),$("#checkupdatelink").text(translate("aalinkadreport")),$("#checkupdatelink_DIV").fadeIn().css("display","block")})),$("#step_update_aa_yes").click((function(){recordMessage("disable_aa_yes"),$("#step_update_aa").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#step_disable_extensions_DIV").fadeIn().css("display","block")})),$("#step_disable_extensions_no").click((function(){recordMessage("disable_extensions"),$("#step_disable_extensions").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("reenableadsonebyone"))})),$("#step_disable_extensions_yes").click((function(){$("#step_disable_extensions").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#step_language_DIV").fadeIn().css("display","block"),extensionsDisabled.length>0&&chrome.permissions.request({permissions:["management"]},(function(e){if(e){for(var t=0;t<extensionsDisabled.length;t++)chrome.management.setEnabled(extensionsDisabled[t],!0);alert(translate("enableotherextensionscomplete"))}else alert(translate("manuallyenableotherextensions"))}))})),$("#OtherExtensions").click((function(){$("#OtherExtensions").prop("disabled",!0),SAFARI||chrome.permissions.request({permissions:["management"]},(function(e){e?($("#step_disable_extensions").fadeOut().css("display","none"),chrome.management.getAll((function(e){for(var t=0;t<e.length;t++)if(e[t].enabled&&e[t].mayDisable&&"gighmmpiobklfepjocnamgkkbiglidom"!==e[t].id&&"aobdicepooefnbaeokijohmhjlleamfj"!==e[t].id&&"pljaalgmajnlogcgiohkhdmgpomjcihk"!==e[t].id){if("development"===e[t].installType&&"extension"===e[t].type&&"AdBlock"===e[t].name)continue;chrome.management.setEnabled(e[t].id,!1),extensionsDisabled.push(e[t].id)}chrome.permissions.remove({permissions:["management"]},(function(e){}));alert(translate("disableotherextensionscomplete")),backgroundPage.reloadTab(parseInt(tabId),(function(){!0,alert(translate("tabreloadcomplete")),$("#step_disable_extensions").fadeIn().css("display","block")}))}))):$("#OtherExtensions").prop("disabled",!1)}))})),$("#step_language_lang").change((function(){var e=$("#step_language_lang option:selected");if($("#step_language").html("<span class='answer'>"+e.text()+"</span>"),$("#step_language span").attr("chosen",e.attr("i18n")),e.text()==translate("other")){if(!$("#checkupdate").get(0).firstChild)return void log("returning, no first child found",$(this).attr("i18n"));if(!$("#checkupdate").get(0).lastChild)return void log("returning, no last child found",$(this).attr("i18n"));var t=translate("nodefaultfilter1"),s=splitMessageWithReplacementText(t);return $("#checkupdate").get(0).firstChild.nodeValue=s.anchorPrefixText,void($("#checkupdate").get(0).lastChild.nodeValue=s.anchorPostfixText)}for(var n=e.attr("value").split(";"),a=0;a<n.length-1;a++)if(unsubscribedDefaultFilters[n[a]])return void $("#checkupdate").text(translate("retryaftersubscribe",[translate("filter"+n[a])]));var r=n[n.length-1];contact=function(e){if(0===subscriptionsNodes.length)return"";for(var t=0;t<subscriptionsNodes.length;t++){var s=subscriptionsNodes[t];if(s){var n=s.getAttribute("prefixes"),a=s.getAttribute("homepage");if(null!==n&&null!==a&&n.split(",").indexOf(e)>=0)return a}}}(r),$("#step_firefox_DIV").fadeIn().css("display","block"),$("#checkinfirefox1").html(translate("checkinfirefox_1")),$("#checkinfirefox2").html(translate("checkinfirefox_2")),$("#checkinfirefox").html(translate("checkinfirefoxtitle"))})),$("#step_firefox_yes").click((function(){if(recordMessage("filterlistproblem"),$("#step_firefox").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),/^mailto\:/.test(contact)&&(contact=contact.replace(" at ","@")),$("#checkupdate").get(0).firstChild)if($("#checkupdate").get(0).lastChild){var e=translate("reportfilterlistproblem"),t=splitMessageWithReplacementText(e);$("#checkupdate").get(0).firstChild.nodeValue=t.anchorPrefixText,$("#checkupdate").get(0).lastChild.nodeValue=t.anchorPostfixText,$("#checkupdatelink").prop("href",contact),$("#checkupdatelink").text(contact.replace(/^mailto\:/,"")),$("#privacy").show()}else log("returning, no last child found",$(this).attr("i18n"));else log("returning, no first child found",$(this).attr("i18n"))})),$("#step_firefox_no").click((function(){$("#step_firefox").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),SAFARI?$("#step_flash_DIV").fadeIn().css("display","block"):(recordMessage("adblockissue"),$("#step_report_DIV").fadeIn().css("display","block"),debugInfo&&$("#debug-info").val(createReadableReport({debug:debugInfo})))})),$("#step_firefox_wontcheck").click((function(){recordMessage("firefox_wontcheck"),SAFARI?$("#checkupdate").text(translate("fixityourself")):$("#step_firefox_yes").click(),$("#step_firefox").html("<span class='answer' chosen='wont_check'>"+translate("refusetocheck")+"</span>")})),$("#step_flash_yes").click((function(){recordMessage("flash_yes"),$("#step_flash").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#checkupdate").text(translate("cantblockflash"))})),$("#step_flash_no").click((function(){recordMessage("flash_no"),$("#step_flash").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#step_report_DIV").fadeIn().css("display","block"),debugInfo&&$("#debug-info").val(createReadableReport({debug:debugInfo}))})),$("#step_report_submit").click((function(){recordMessage("sendReport"),sendReport()}))})),backgroundPage.getDebugInfo((function(e){debugInfo={},debugInfo.filter_lists=JSON.stringify(e.subscriptions,null,"\t"),debugInfo.other_info=JSON.stringify(e.other_info,null,"\t"),debugInfo.custom_filters=e.custom_filters,debugInfo.settings=JSON.stringify(e.settings,null,"\t"),debugInfo.language=determineUserLanguage()}));var createReadableReport=function(e){var t=[];return e.location&&(t.push("* Location of ad *"),t.push(e.location)),e.expect&&(t.push(""),t.push("* Working Filter? *"),t.push(e.expect)),t.push(""),content=[],content.push("* Debug Info *"),content.push(""),e.debug&&e.debug.filter_lists&&(content.push("=== Filter Lists ==="),content.push(e.debug.filter_lists)),content.push(""),e.custom_filters&&(content.push("=== Custom Filters ==="),content.push(e.debug.custom_filters),content.push("")),e.exclude_filters&&(content.push("=== Exclude Filters ==="),content.push(e.debug.exclude_filters),content.push("")),e.debug&&e.debug.settings&&(content.push("=== Settings ==="),content.push(e.debug.settings)),content.push(""),e.debug&&e.debug.other_info&&(content.push("=== Other Info ==="),content.push(e.debug.other_info)),t.push(content.join("\n")),t.push(""),t.join("\n")},prepareManualReport=function(e,t,s,n){var a=[];a.push(createReadableReport(e)),t&&a.push("Status: "+t),s&&a.push("HTTP error code: "+s),n&&a.push("Server error information: "+JSON.stringify(n)),$("#manual_submission").val(a.join("\n"))};$("input, select").change((function(e){e.preventDefault(),$("html, body").animate({scrollTop:15e3},50)}));