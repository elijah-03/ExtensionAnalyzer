/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{getParentElementForNativeViewerPrompt}from"../../gmail/util.js";import state from"../../gmail/state.js";import ImageToolsDropdown from"../image-tools-dropdown.js";import SingleClickCTA from"../single-click-cta.js";import expressUtils from"../express-utils.js";import{getFileDetails}from"../../utils/util.js";import ConvertToPdfCTA from"../../convert-to-pdf-cta.js";let previewEntryPointId="express-gmail-native-viewer-entry-point";const touchpoint="gmailNativeViewer",gmailExpressStateKey="gmailExpressState",imageEditDropdownStateKey="imageEditDropdownState",convertToPdfFteKey="acrobat-gmail-convert-to-pdf-verb-fte-config",convertToPdfOnlyMimeTypes=[],unsupportedMimeTypes=["image/tiff","image/tiff-fx","image/svg+xml","image/avif","image/x-icon","image/vnd.microsoft.icon","image/heic"],editImageOnlyMimeTypes=["image/webp","image/heif"],_getVisibleViewer=()=>{const e=state?.expressConfig?.selectors?.activeViewElementId??["drive-active-item-info"],t=e.length;for(let i=0;i<t;i+=1){const t=document.getElementById(e[i]);if(t){const e=getFileDetails(t);return state.expressState.mimeType=e?.mimeType,state.expressState.imageName=e?.title,t.parentElement}}return null},_isImagePreviewed=()=>{const e=(state?.expressConfig?.selectors??{}).imgPrev??["aLF-aPX-J1-J3"],t=_getVisibleViewer();if(!t)return null;const i=expressUtils.getElementsFromClassNames(t,e);return i&&i.length>0?i[0].getAttribute("src"):null},_removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()},_removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&state.expressState.tooltip&&(state.expressState.tooltip.tooltip.remove(),state.expressState.tooltip=null)},_setTouchpointClickedForFteState=async e=>{_removeContextualFte();const t={imageTools:{storageKey:"imageEditDropdownState",field:"previewTouchpointUsed"},convertToPdf:{storageKey:convertToPdfFteKey,field:"touchPointClicked"},editImage:{storageKey:"gmailExpressState",field:"previewTouchpointUsed"}}[e];if(!t)return;const{storageKey:i,field:s}=t,o=(await chrome.storage.local.get(i))[i]||{};o[s]=!0,chrome.storage.local.set({[i]:o})},_getImageSrc=e=>{if("convertToPdf"===e){const e=new URL(state.expressState?.imageURL);return e.searchParams.set("view","att"),e.searchParams.delete("disp"),e.searchParams.delete("sz"),e.toString()}return state.expressState?.imageURL},_clickCallback=(e,t="editImage")=>{const i=_getImageSrc(e);"convertToPdf"===e?chrome.runtime.sendMessage({main_op:"execute-direct-verb",fileUrl:i,fileName:state.expressState.imageName,viewerURL:state?.viewerURLPrefix,promotionSource:"gmail_chrome-convert_to_pdf_from_images",verb:"createpdf"}):chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:i,intent:e,touchpoint:touchpoint}),_setTouchpointClickedForFteState(t)},toggleButtonSize=(e,t)=>{e.style.width=t?"32px":"";const i=e.getElementsByClassName("cc440d50ba-express-entrypoint-button-text")[0],s=e.getElementsByClassName("cc440d50ba-express-entrypoint-button-icon")[0];i&&(i.style.display=t?"none":""),s&&(s.style.padding=t?"7px 9px 7px 5px":"",s.style.width=t?"32px":"")},updateButtonStyles=e=>{if(!e)return;e.style.visibility="hidden",toggleButtonSize(e,!1);const t=e.offsetWidth,i=window.innerWidth-t<1e3;toggleButtonSize(e,i),e.style.visibility="visible"},_handleResponsiveButton=e=>{const t=e.getElementsByClassName("cc440d50ba-express-entrypoint-button")[0];updateButtonStyles(t),state.expressState.resizeHandler=()=>updateButtonStyles(t),window.addEventListener("resize",state.expressState.resizeHandler)},_addTouchpoint=async()=>{const e=state?.expressConfig?.enableGmailConvertToPdfInImages;let t=!0;const i=state.expressState.mimeType;let s=new SingleClickCTA,o="editImage";e&&(editImageOnlyMimeTypes.includes(i)?s=new SingleClickCTA:convertToPdfOnlyMimeTypes.includes(i)?(s=new ConvertToPdfCTA,t=!1,o="convertToPdf",previewEntryPointId="acrobat-covert-to-pdf-native-viewer-touch-point"):(s=new ImageToolsDropdown,previewEntryPointId="edit-image-dropdown-gmail-native-viewer-entry-point",o="imageTools")),state.expressState.nativeViewerTouchpointVisible=!0;const n=state.expressConfig.enableGmailConvertToPdfInImages||state.expressConfig.enableGmailConvertToPdfInImagesControl,r=await s.renderMenuButton(e=>_clickCallback(e,o),touchpoint,{showAnalytics:n,mimeType:i});r.id=previewEntryPointId;const a=getParentElementForNativeViewerPrompt();a&&a?.childNodes?.length>0&&(a.insertBefore(r,a.childNodes[0]),_handleResponsiveButton(r),t&&(state.expressState.tooltip=s.attachTooltip("bottom")),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Gmail:NativeViewerEntryPoint:Shown"]]))},removeExpressTouchpoints=()=>{["express-gmail-native-viewer-entry-point","edit-image-dropdown-gmail-native-viewer-entry-point","acrobat-covert-to-pdf-native-viewer-touch-point"].forEach(e=>{const t=document.getElementById(e);t&&t.parentElement?.removeChild(t)}),state.expressState?.resizeHandler&&(window.removeEventListener("resize",state.expressState.resizeHandler),state.expressState.resizeHandler=null),state.expressState.imageURL=null,state.expressState.nativeViewerTouchpointVisible=!1,state.expressState.tooltip?.tooltip?.remove(),state.expressState.tooltip=null},addExpressNativeViewerTouchpoint=()=>{_removeTooltipIfFteRendered();const e=_isImagePreviewed();if(!e)return void removeExpressTouchpoints();const{nativeViewerTouchpointVisible:t,imageURL:i}=state?.expressState;t||_addTouchpoint(),i!==e&&(state.expressState.imageURL=e)},sendConvertToPdfInImagesExperimentAnalytics=()=>{const e=state.expressState.mimeType;e&&unsupportedMimeTypes.includes(e)&&expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:DirectVerb:NonPdf:Opened",{source:"Gmail",workflow:"ConvertToPdf",eventContext:e}]])};export{addExpressNativeViewerTouchpoint,removeExpressTouchpoints,sendConvertToPdfInImagesExperimentAnalytics};