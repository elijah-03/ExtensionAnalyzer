"use strict";!function(){let e=new Set;(ext.PageMap=function(){this._map=new Map}).prototype={_delete(t){this._map.delete(t),0==this._map.size&&e.delete(this)},keys(){return Array.from(this._map.keys()).map(ext.getPage)},get(e){return this._map.get(e.id)},set(t,a){this._map.set(t.id,a),e.add(this)},has(e){return this._map.has(e.id)},clear(){this._map.clear(),e.delete(this)},delete(e){this._delete(e.id)}},ext._removeFromAllPageMaps=t=>{for(let a of e)a._delete(t)};let t=ext.Page=function(e){this.id=e.id,this._url=e.url&&new URL(e.url),this.browserAction=new r(e.id),this.contextMenus=new l(this)};function a(e){return a=>{let n=(o,r,s)=>{o==a.id&&"complete"==r.status&&(chrome.tabs.onUpdated.removeListener(n),e(new t(a)))};chrome.tabs.onUpdated.addListener(n)}}function n(e,a,n,o){if(0==e){let e=new t({id:a,url:n});ext._removeFromAllPageMaps(a),chrome.tabs.get(a,(()=>{chrome.runtime.lastError&&ext.pages.onLoading._dispatch(e)}))}let r=function(e,t){let a=d.get(e);a||(a=new Map,d.set(e,a));let n=a.get(t);return n||(n={},a.set(t,n)),n}(a,e);r.url=new URL(n);let s=d.get(a).get(o);s&&(r.parent=s)}function o(e){ext.pages.onRemoved._dispatch(e),ext._removeFromAllPageMaps(e),d.delete(e)}t.prototype={get url(){if(this._url)return this._url;let e=d.get(this.id);if(e){let t=e.get(0);if(t)return t.url}},sendMessage(e,t){chrome.tabs.sendMessage(this.id,e,t)}},ext.getPage=e=>new t({id:parseInt(e,10)}),ext.pages={open(e,t){chrome.tabs.create({url:e},t&&a(t))},query(e,a){let n={};for(let t in e)switch(t){case"active":case"lastFocusedWindow":n[t]=e[t]}chrome.tabs.query(n,(e=>{a(e.map((e=>new t(e))))}))},onLoading:new ext._EventTarget,onActivated:new ext._EventTarget,onRemoved:new ext._EventTarget},chrome.tabs.onUpdated.addListener(((e,a,n)=>{"loading"==a.status&&ext.pages.onLoading._dispatch(new t(n))})),chrome.webRequest.onHeadersReceived.addListener((e=>{if(204!=e.statusCode&&205!=e.statusCode){for(let t of e.responseHeaders){let a=t.name.toLowerCase();if("location"==a&&t.value&&(301==e.statusCode||302==e.statusCode||303==e.statusCode||307==e.statusCode||308==e.statusCode))return;if("content-disposition"==a){let e=t.value.split(";")[0].replace(/[ \t]+$/,"");if("inline"!=e.toLowerCase()&&/^[\x21-\x7E]+$/.test(e)&&!/[()<>@,;:\\"/[\]?={}]/.test(e))return}if("content-type"==a){let e=t.value.split(/[ \t;(]/)[0].toLowerCase();if(e.includes("/")&&"*/*"!=e&&"application/unknown"!=e&&"unknown/unknown"!=e&&"text/html"!=e&&"text/xml"!=e&&"application/xml"!=e&&"application/xhtml+xml"!=e&&"image/svg+xml"!=e)return}}n(e.frameId,e.tabId,e.url,e.parentFrameId)}}),{types:["main_frame","sub_frame"],urls:["http://*/*","https://*/*"]},["responseHeaders"]),chrome.webNavigation.onBeforeNavigate.addListener((e=>{let t=new URL(e.url);"http:"!=t.protocol&&"https:"!=t.protocol&&n(e.frameId,e.tabId,e.url,e.parentFrameId)})),chrome.tabs.onReplaced.addListener(((e,t)=>{o(t)})),chrome.tabs.onRemoved.addListener(o),chrome.tabs.onActivated.addListener((e=>{ext.pages.onActivated._dispatch(new t({id:e.tabId}))})),"getPopup"in chrome.browserAction||chrome.browserAction.onClicked.addListener((()=>{ext.showOptions()}));let r=function(e){this._tabId=e,this._changes=null};r.prototype={_applyChanges(){"iconPath"in this._changes&&"setIcon"in chrome.browserAction&&chrome.browserAction.setIcon({tabId:this._tabId,path:{16:this._changes.iconPath.replace("$size","16"),19:this._changes.iconPath.replace("$size","19"),20:this._changes.iconPath.replace("$size","20"),32:this._changes.iconPath.replace("$size","32"),38:this._changes.iconPath.replace("$size","38"),40:this._changes.iconPath.replace("$size","40")}}),"badgeText"in this._changes&&"setBadgeText"in chrome.browserAction&&chrome.browserAction.setBadgeText({tabId:this._tabId,text:this._changes.badgeText}),"badgeColor"in this._changes&&"setBadgeBackgroundColor"in chrome.browserAction&&chrome.browserAction.setBadgeBackgroundColor({tabId:this._tabId,color:this._changes.badgeColor}),this._changes=null},_queueChanges(){chrome.tabs.get(this._tabId,(()=>{if(chrome.runtime.lastError){let e=(t,a)=>{t==this._tabId&&(chrome.tabs.onReplaced.removeListener(e),this._applyChanges())};chrome.tabs.onReplaced.addListener(e)}else this._applyChanges()}))},_addChange(e,t){this._changes||(this._changes={},this._queueChanges()),this._changes[e]=t},setIcon(e){this._addChange("iconPath",e)},setBadge(e){e?("number"in e&&this._addChange("badgeText",e.number.toString()),"color"in e&&this._addChange("badgeColor",e.color)):this._addChange("badgeText","")}};let s=new ext.PageMap,i=!1,c=()=>{"contextMenus"in chrome&&!i&&(i=!0,chrome.tabs.query({active:!0,lastFocusedWindow:!0},(e=>{chrome.contextMenus.removeAll((()=>{if(i=!1,0==e.length)return;let a=s.get({id:e[0].id});a&&a.forEach((e=>{chrome.contextMenus.create({title:e.title,contexts:e.contexts,onclick(a,n){e.onclick(new t(n))}})}))}))})))},l=function(e){this._page=e};l.prototype={create(e){let t=s.get(this._page);t||s.set(this._page,t=[]),t.push(e),c()},remove(e){let t=s.get(this._page);if(t){let a=t.indexOf(e);-1!=a&&(t.splice(a,1),c())}}},chrome.tabs.onActivated.addListener(c),"windows"in chrome&&chrome.windows.onFocusChanged.addListener((e=>{e!=chrome.windows.WINDOW_ID_NONE&&c()}));let d=new Map;ext.getFrame=(e,t)=>{let a=d.get(e);return a&&a.get(t)};let h=chrome.webRequest.MAX_HANDLER_BEHAVIOR_CHANGED_CALLS_PER_10_MINUTES;function g(){h>0&&(chrome.webNavigation.onBeforeNavigate.removeListener(g),chrome.webRequest.handlerBehaviorChanged(),h--,setTimeout((()=>{h++}),6e5))}ext.webRequest={onBeforeRequest:new ext._EventTarget,handlerBehaviorChanged(){let{onBeforeNavigate:e}=chrome.webNavigation;e.hasListener(g)||e.addListener(g)}},chrome.tabs.query({},(e=>{e.forEach((e=>{chrome.webNavigation.getAllFrames({tabId:e.id},(t=>{if(t&&t.length>0){let a=new Map;d.set(e.id,a);for(let e of t){let t={url:new URL(e.url)};a.set(e.frameId,t),-1!=e.parentFrameId&&(t.parent=a.get(e.parentFrameId))}}}))}))})),chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"==e.type)return;let a=new URL(e.url);if("http:"!=a.protocol&&"https:"!=a.protocol&&"ws:"!=a.protocol&&"wss:"!=a.protocol)return;let{frameId:n,type:o}=e;"sub_frame"==o&&(n=e.parentFrameId);let r=null,s=null;return-1!=e.tabId&&(r=ext.getFrame(e.tabId,n),s=new t({id:e.tabId})),ext.webRequest.onBeforeRequest._dispatch(a,o,s,r).includes(!1)?{cancel:!0}:void 0}),{urls:["<all_urls>"]},["blocking"]),chrome.runtime.onMessage.addListener(((e,a,n)=>{let o={};return"tab"in a&&(o.page=new t(a.tab),o.frame={id:a.frameId,url:a.url?new URL(a.url):null,get parent(){let e=d.get(a.tab.id);if(!e)return null;let t=e.get(a.frameId);return t?t.parent||null:e.get(0)||null}}),ext.onMessage._dispatch(e,o,n).includes(!0)})),ext.storage={get(e,t){chrome.storage.local.get(e,t)},set(e,t,a){let n={};n[e]=t,chrome.storage.local.set(n,a)},remove(e,t){chrome.storage.local.remove(e,t)},onChanged:chrome.storage.onChanged},ext.showOptions=e=>{let n=require("info");if("openOptionsPage"in chrome.runtime&&("fennec"!=n.application||parseInt(n.applicationVersion,10)>=57))e?chrome.runtime.openOptionsPage((()=>{chrome.runtime.lastError||chrome.tabs.query({active:!0,lastFocusedWindow:!0},(n=>{n.length>0&&("complete"==n[0].status?e(new t(n[0])):a(e)(n[0]))}))})):chrome.runtime.openOptionsPage();else if("windows"in chrome){let a="options.html",n=ext.getURL(a);chrome.tabs.query({},(o=>{let r=o.find((e=>e.url==n));r?(chrome.windows.update(r.windowId,{focused:!0}),chrome.tabs.update(r.id,{active:!0}),e&&e(new t(r))):ext.pages.open(a,e)}))}else ext.pages.open("options.html",e)},ext.windows={create(e,t){chrome.windows.create(e,(e=>{a(t)(e.tabs[0])}))}}}();