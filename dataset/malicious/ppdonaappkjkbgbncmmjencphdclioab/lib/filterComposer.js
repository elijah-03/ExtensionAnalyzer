"use strict";const{defaultMatcher:defaultMatcher}=require("matcher"),{RegExpFilter:RegExpFilter}=require("filterClasses"),{FilterNotifier:FilterNotifier}=require("filterNotifier"),{Prefs:Prefs}=require("prefs"),{extractHostFromFrame:extractHostFromFrame,stringifyURL:stringifyURL,isThirdParty:isThirdParty}=require("url"),{getKey:getKey,checkWhitelisted:checkWhitelisted}=require("whitelisting"),{port:port}=require("messaging"),info=require("info");let readyPages=new ext.PageMap;function isValidString(e){return e&&-1==e.indexOf("\0")}function escapeChar(e){let t=e.charCodeAt(0);return t<=31||127==t||/[\d{}]/.test(e)?"\\"+t.toString(16)+" ":"\\"+e}exports.isPageReady=e=>readyPages.has(e);let escapeCSS=exports.escapeCSS=e=>e.replace(/^[\d-]|[^\w\-\u0080-\uFFFF]/g,escapeChar),quoteCSS=exports.quoteCSS=e=>'"'+e.replace(/["\\{}\x00-\x1F\x7F]/g,escapeChar)+'"';function composeFilters(e){let{page:t,frame:s}=e,r=[],i=[];if(!checkWhitelisted(t,s)){let o=RegExpFilter.typeMap[e.type],a=extractHostFromFrame(s),n=checkWhitelisted(t,s,RegExpFilter.typeMap.GENERICBLOCK);for(let i of e.urls){let l=new URL(i,e.baseURL);if(i=stringifyURL(l),!defaultMatcher.whitelist.matchesAny(i,o,a,isThirdParty(l,a),getKey(t,s),n)){let e=i.replace(/^[\w-]+:\/+(?:www\.)?/,"||");n&&(e+="$domain="+a),r.includes(e)||r.push(e)}}if(0==r.length&&!checkWhitelisted(t,s,RegExpFilter.typeMap.ELEMHIDE)){isValidString(e.id)&&i.push("#"+escapeCSS(e.id));let t=e.classes.filter(isValidString);t.length>0&&i.push(t.map((e=>"."+escapeCSS(e))).join("")),isValidString(e.src)&&i.push(escapeCSS(e.tagName)+"[src="+quoteCSS(e.src)+"]"),isValidString(e.style)&&0==i.length&&0==r.length&&i.push(escapeCSS(e.tagName)+"[style="+quoteCSS(e.style)+"]");for(let e of i)r.push(a.replace(/^www\./,"")+"##"+e)}}return{filters:r,selectors:i}}let contextMenuItem={title:ext.i18n.getMessage("block_element"),contexts:["image","video","audio"],onclick(e){e.sendMessage({type:"composer.content.contextMenuClicked"})}};function updateContextMenu(e,t){e.contextMenus.remove(contextMenuItem),void 0===t&&(t=checkWhitelisted(e)),"fennec"!=info.application&&!t&&Prefs.shouldShowBlockElementMenu&&readyPages.has(e)&&e.contextMenus.create(contextMenuItem)}FilterNotifier.on("page.WhitelistingStateRevalidate",updateContextMenu),Prefs.on("shouldShowBlockElementMenu",(()=>{ext.pages.query({},(e=>{for(let t of e)updateContextMenu(t)}))})),port.on("composer.ready",((e,t)=>{readyPages.set(t.page,null),updateContextMenu(t.page)})),port.on("composer.openDialog",((e,t)=>new Promise((e=>{ext.windows.create({url:ext.getURL("composer.html"),left:50,top:50,width:420,height:200,type:"popup"},(s=>{let r=s.id;ext.pages.onRemoved.addListener((function e(s){r==s&&(t.page.sendMessage({type:"composer.content.dialogClosed",popupId:r}),ext.pages.onRemoved.removeListener(e))})),e(r)}))})))),port.on("composer.getFilters",((e,t)=>composeFilters({tagName:e.tagName,id:e.id,src:e.src,style:e.style,classes:e.classes,urls:e.urls,type:e.mediatype,baseURL:e.baseURL,page:t.page,frame:t.frame}))),port.on("composer.quoteCSS",((e,t)=>quoteCSS(e.CSS))),ext.pages.onLoading.addListener((e=>{e.sendMessage({type:"composer.content.finished"})}));