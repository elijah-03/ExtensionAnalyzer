import{a as W,d as he,f as we,g as Se}from"../chunks/chunk-ZWPJUU63.js";import"../chunks/chunk-BNHGR4RR.js";import{a as F,f as pe,g as ge,i as le,x as me,z as fe}from"../chunks/chunk-NPIK4BSC.js";import"../chunks/chunk-Y42W4ZQD.js";import"../chunks/chunk-XNVYV2NQ.js";import"../chunks/chunk-VCPNQHGQ.js";import"../chunks/chunk-G3WW6RJZ.js";import{a as Ce,b as _e,c as ye,d as De}from"../chunks/chunk-NXWKPA26.js";import{a as ke,b as ve}from"../chunks/chunk-RVO3M5CT.js";import"../chunks/chunk-PFBRUDBV.js";import"../chunks/chunk-BDOU7XT6.js";import"../chunks/chunk-57TRHH3E.js";import{a as D,b as x}from"../chunks/chunk-N3S7YKRT.js";import{G as se,J as re,L as M,c as te,d as oe,e as ae,i as ie}from"../chunks/chunk-HH5UG254.js";import{c as ne}from"../chunks/chunk-EA7CGSTM.js";import"../chunks/chunk-AGWLSUX4.js";import"../chunks/chunk-MFH6BM6M.js";import{b as ce}from"../chunks/chunk-N2ICXIKO.js";import"../chunks/chunk-JDXM4SX2.js";import"../chunks/chunk-NT3RH36Y.js";import"../chunks/chunk-XH6MVEJG.js";import{a as ue}from"../chunks/chunk-6JGDJAZ5.js";import{a as U}from"../chunks/chunk-CQXN2NRJ.js";import"../chunks/chunk-IPZXBZPC.js";import"../chunks/chunk-E2GNLB6L.js";import{a as Te}from"../chunks/chunk-UW4IVTWM.js";import{a as de}from"../chunks/chunk-6ILBPYHJ.js";import{b as Ue}from"../chunks/chunk-GNZEMFDT.js";import{a as q,b as We}from"../chunks/chunk-J7QHBV67.js";import"../chunks/chunk-VGEMM5MB.js";import"../chunks/chunk-JDV5FZKX.js";import{a as ee}from"../chunks/chunk-VV56VTSO.js";import"../chunks/chunk-BCG2KUGW.js";import{a as Q}from"../chunks/chunk-WJZEHHRO.js";import"../chunks/chunk-HPSGHK7L.js";import{b as Z}from"../chunks/chunk-GXPO46BF.js";import"../chunks/chunk-IYAFYZRF.js";import"../chunks/chunk-F2BE3OL5.js";import"../chunks/chunk-XZWN3GGK.js";import"../chunks/chunk-2Q63MOXU.js";import"../chunks/chunk-DPMK7ZVG.js";import"../chunks/chunk-D3B67B3M.js";import"../chunks/chunk-H6FSK4DZ.js";import"../chunks/chunk-TYA5STFG.js";import"../chunks/chunk-2GAAOKGQ.js";import{k as X,q as E}from"../chunks/chunk-KJBXKQ52.js";import{a as R,b as Y,g as f,h as t,n as T,o as w,r as j,v as K}from"../chunks/chunk-4XUWKJYA.js";import"../chunks/chunk-VM2OHO33.js";import"../chunks/chunk-74K3EJN3.js";import"../chunks/chunk-W7K6NY26.js";import{g as z,n as G,s as Fe}from"../chunks/chunk-QWQLNDJC.js";import{b as H,c as Be}from"../chunks/chunk-WXGZPSEB.js";import{F as $}from"../chunks/chunk-K2PA57PF.js";import"../chunks/chunk-ECXCPAF6.js";import"../chunks/chunk-CBPLEXH3.js";import{b as Le,c as Ee}from"../chunks/chunk-AYDLOBCW.js";import{b as y,c as Me}from"../chunks/chunk-JENJKWHP.js";import"../chunks/chunk-53OM6ECF.js";import"../chunks/chunk-KUOYBGP4.js";import"../chunks/chunk-PDIOZR2P.js";import"../chunks/chunk-WO6N5TBT.js";import"../chunks/chunk-BTBTC4NL.js";import{e as I}from"../chunks/chunk-3GYLW4KZ.js";var Ae=I(Le());Fe();var o=I(Ee());var V=I(Ue());Me();We();Be();var be=()=>K("hasDeferredCouponRewards");var B=I($());window.__wb_timing.couponsRequireAt=performance.now();var Je=new Set(["etsy.com","amazon.com"]),N=!1,A=!1,Ne=!1,ze=o.default.throttle(ee,2e3),Ge=()=>{setTimeout(()=>{let e={currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},r=o.default.extend({},window.__wb_timing,e);w("track","pageTimingMetrics",r)},5e3)};function qe(){return Ae.default.all([de(),U(),ie(),ue(),be(),_e(),Ce()]).spread((e,r,c,i,n,p,u)=>{Te(e),t.merge({siteAPIData:r}),t.merge({cashback:c}),t.set("lifetimeSavings",i),t.set(["couponView","hasDeferredCouponRewards"],n),t.set(["couponView","elasticityUserDomain"],p),t.set("domainLists",u)})}var He=[{domain:"etsy.com"},{domain:"amazon.com",condition:e=>{let r=o.default.get(e,"pageType")==="checkoutPage",c=o.default.get(e,"pageData.meta"),i=c?c.coupon_input_present:!1;return r&&i}}];function Ie(e,r){return!!o.default.find(He,i=>i.domain===e&&(i.condition?i.condition(r):!0))}async function $e(){y("COUPONS INIT");let[e,r,c,i]=await Promise.all([D("emailCreateAccount"),D("affiliateRedirect"),D("couponRun"),D("tripId"),qe()]);y("COUPONS DATA LOADED");let n=R();if(Ge(),navigator.userAgent.indexOf("Firefox")>-1&&n.match(/eyebuydirect\.com/))return!1;let p=t.get("cashback");if(e&&JSON.parse(e)?.shouldLoadNotification&&(await x("emailCreateAccount"),ne(o.default.get(p,"reward",null))),r){let s=JSON.parse(r);t.set("affiliateRedirect",s);let{fromAutoRun:a,hasCredits:S}=s||{};i&&T("ext_deferred_coupon_rewards_v_2")&&t.get("cashback","redirectUrl")&&a&&S===!1&&he(i)}else c||(sessionStorage.removeItem("__s_sitehub_try_codes"),i&&x("tripId"));i&&t.set(["couponView","tripId"],i),t.set("couponsVisible",!1);let u=t.get("siteAPIData");await Xe(u);let l=await Ze(u),g;try{g=JSON.parse(sessionStorage.getItem("ogPageData")),g&&g.expires<q()&&(sessionStorage.removeItem("ogPageData"),g=null)}catch{}async function C(s){if(y("onDeweyResult",s),ze(n,s),await Qe(s),s.callSource==="internal"&&s.pageData)try{let a=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(a.value)){let S=Date.now()-a.time;s.pageData?.order?.total>a.value&&S<2e3&&w("track","extensionError",{type:"coupon_error"})}}catch{}if(s.callSource==="coupons_start"&&s.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...s.pageData,expires:G(z(new Date,3))}));else if(s.callSource==="coupons_end"){let a=t.select("couponView").get("resultTemp");a||(a=t.select("couponView").get("result"),a.pageReload=void 0);try{g=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let S=o.default.get(g,"order.total");if(a.deweyOriginalTotal=S,a.savings>0){o.default.get(s,"pageData.products.length")>1?s.pageData.products=o.default.map(s.pageData.products,(h,L)=>(o.default.has(h,"list_price")&&o.default.has(g,`products[${L}].list_price`)&&g.products[L].list_price-h.list_price&&(h.coupon_savings=g.products[L].list_price-h.list_price),h.coupon_applied=a.bestCoupon.code,h)):o.default.get(s,"pageData.products.length")===1&&(s.pageData.products[0].coupon_savings=a.savings,s.pageData.products[0].coupon_applied=a.bestCoupon.code);let b=s.pageData?.order?.total;b>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:b,time:Date.now()}))}let O=R(),m=t.get("couponsConfig");if(m&&m.pageWasReloaded){m.result=a;let b=t.get("couponView"),h=o.default.get(b,"resultTemp.allCoupons",[]);Je.has(O)&&h.length>0&&(m.coupons=o.default.cloneDeep(h)),k(m,p)}else t.select("couponView").set("result",a);a&&a.couponScriptType==="roo"&&w("track","rooActionTiming",{triggerType:F({automaticCouponsRun:a.automaticCouponsRun,autoFallback:a.autoFallback,isSiteHub:a.isSiteHub}),couponRunId:a.couponRunId,aggApplyCodeTime:a.aggApplyCodeTime,aggGetTotalTime:a.aggGetTotalTime,aggRemovePreviousTime:a.aggRemovePreviousTime,aggWaitForReloadTime:a.aggWaitForReloadTime,initialActionTime:a.initialActionTime,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{automaticCouponsRun:Ve,autoFallback:Pe,isSiteHub:Oe}=a,xe=F({automaticCouponsRun:Ve,autoFallback:Pe,isSiteHub:Oe});tt({couponResult:a,triggerType:xe,siteAPIData:u}),w("track","deweyResult",o.default.assign(s,{url:window.location.href}))}else if(g&&o.default.get(s,"pageType")&&!A)A=!0,l();else if(Ie(n,s)&&!N){if(o.default.get(s,"pageData"))if(n==="amazon.com")await Re(s,l,p);else{let a=await l();if(a){N=!0;let S=await f({message:"getClassifierCodes",domain:n,pageData:s.pageData});if(S){let O=o.default.get(u,"siteData.coupons.count"),m=o.default.concat(S,a.coupons);m=o.default.uniqBy(m,"code"),m=m.slice(0,O),a.coupons=m}k(a,p)}}}else if(A&&T("ext_coupons_skip_cashback_fallback")&&u?.siteData?.coupons?.type==="roo"&&(s.pageType==="cartPage"||s.pageType==="checkoutPage")&&!t.get(["couponView","rooIsCheckingForCouponPage"])&&!t.get(["couponView","rooIsCouponPage"])){let a=await l();a&&k(a,p)}else!T("ext_coupons_skip_cashback_fallback")&&!t.get("cashbackVisible")&&!o.default.get(p,"postCoupons")&&setTimeout(()=>{if(!t.get("couponsVisible")&&!Ne){let a=t.get("deweyResult");M(a)}},1e3)}let P=await D("rooReloading"),d=t.get("deweyResult");d&&!P&&C(d),P&&await x("rooReloading"),ce.emitter.on("result",async s=>{let a=await ye();De(a),C(s)}),await j(),d=t.get("deweyResult");let _=Ie(n,d),v;!_&&!A&&(A=!0,v=await l());let J=o.default.get(d,"pageData");if(_){if(n==="amazon.com")await Re(d,l,p);else if(J&&!N){let s=await l();if(s){N=!0;let a=await f({message:"getClassifierCodes",domain:n,pageData:J});a&&(s.coupons=a),k(s,p)}}}v&&!v.pageWasReloaded&&k(v,p)}async function k(e,r){y("PREPARE COUPONS",{coupons:e,cashback:r});let{standDown:c}=e,i=R();t.merge("couponView",e);let n=t.get("cashbackView")||r;t.set("cashbackView",n);let p={cssUrl:"coupons.css"};if(n&&o.default.get(n,"user.compInactivated")&&re()&&!t.get("cashbackReactivateVisible")&&!t.get("throttleCreditsReactivation")){t.set(["warnAboutStandDown"],!0),t.set("cashbackReactivateVisible",!0),E({...p,appName:"reactivate",app:(0,B.jsx)(se,{})});return}(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto"))&&await f({domain:i,message:"endThrottle"});let l=le(),g=i;Q(i)&&t.get("deweyResult","pageType")==="checkoutPage"&&(g="amazon.com_checkout");let C=await f({domain:g,message:"isThrottled",isAutoCoup:l});if(l&&await f({domain:g,message:"isAutoCoupThrottled",isAutoCoup:l})){if(t.get("affiliateRedirect")&&!localStorage.getItem("__wb_redirecting")){C||ge();return}t.select("couponView").set("autoCoupThrottled",!0)}let P=!!t.get(["events","hasSeenCouponsThrottleToolTip"]),d=C&&!P&&!e.pageWasReloaded;if(t.select("couponView").set("showThrottleToolTip",d),C&&!e.pageWasReloaded&&(t.set("couponsThrottled",!0),!d)){T("ext_coupons_skip_cashback_fallback")&&!T("ext_coupons_skip_cashback_when_throttled")&&M(t.get("deweyResult"));return}if(c){t.set("couponsThrottled",!0),oe();return}else if(te()){ae();return}if(i==="groupon.com"&&w("track","foundCouponsEnd",{pageViewId:t.get("pageViewId")}),(T("ext_to_eml_abe_checkout")||T("ext_to_ma_abe_checkout"))&&!e?.pageWasReloaded){let _=await ke(t.get("deweyResult"),["cartPage","checkoutPage"],{allowOnly:[V.BonusOfferType.firstTimeEmailActivationBonus,V.BonusOfferType.desktopToMobileAppBonus]});if(_){ve(_),Ne=!0,t.set("cashbackVisible",!1);return}}t.get("couponsVisible")||(t.set("couponsVisible",!0),E({...p,appName:we,app:(0,B.jsx)(Se,{})}))}function Ye(e){w("track","platformIdentified",{platform:e,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}async function je(){if(t.get("platform")==="Shopify"){let r=window.location.hostname,c=t.get("platformSiteUrl");c&&(r=(0,V.getSiteDomainFromUrl)(c));let i=await f({message:"makeRequest",reqInfo:{method:"GET",url:`https://${r}/cart.json`,headers:{Accept:"*/*"}}});if(i?.items?.length>0)return Ke(i)}}function Ke(e){let r=o.default.map(e.items,c=>o.default.pick(c,["id","product_id","sku","url","discounts","discounted_price","original_price","image","title","variant_title"]));return JSON.stringify({cartLevelDiscountApplications:e?.cart_level_discount_applications,cartItems:r,originalTotal:e?.original_total_price,totalDiscount:e?.total_discount,totalPrice:e?.total_price})}async function Qe(e){let r=R();if(t.get("platform")==="Shopify"&&e&&e.pageType==="checkoutPage"){let i=document.querySelectorAll(".notice.notice--warning .notice__text"),n=o.default.find(i,p=>p.offsetHeight>0);if(n){let p=n.querySelector("strong").innerText.trim();w("track","shopifyInvalidCouponDetected",{domain:r,coupon:p})}}}async function Xe(e){let r=o.default.get(e,"tld");Y(r);let[c,i,n]=await Promise.all([f({message:"getPlatform"}),f({message:"getPlatformDomain"}),f({message:"getPlatformSiteUrl"})]);c&&(t.set("platform",c),Ye(c),i&&t.set("platformDomain",i),n&&t.set("platformSiteUrl",n))}async function Ze(e){let r=t.get("platform"),c=t.get("platformDomain"),i=t.get("platform")==="Shopify";return o.default.get(e,"siteData.coupons.ignoreSite")?o.default.noop:o.default.get(e,"siteData.coupons.type")==="eeyore"&&o.default.get(e,"siteData.coupons.coupons.length")>0?o.default.get(e,"siteData.coupons.identifiers")?fe:o.default.noop:o.default.get(e,"siteData.coupons.type")==="tigger"&&r?(c&&i&&(e.siteData.coupons.shopify=!0,e.siteData.appliedCodeSelector=".applied-reduction-code__information",await U(o.default.assign(e,{domain:c,setSite:!0}))),i||X.includes(r)?W:me):o.default.get(e,"siteData.coupons.type")==="roo"?pe.initCoupons:o.default.get(e,"siteData.coupons.type")==="asyncTigger"?o.default.get(e,"siteData.coupons.identifiers")?W:o.default.noop:o.default.noop}async function Re(e,r,c){if(e){let i=await r({experience:"checkout"});N=!0;let n=await f({message:"getClassifierCodes",domain:"amazon.com",pageData:e.pageData,pageViewId:t.get("pageViewId")});n&&(i.coupons=n),n&&n.length>=1&&(i.couponCount=n.length,k(i,c))}}function et(e){let i=!1,n=e||0;return n=parseInt(n),isNaN(n)&&(i=!0,n=0),n>1e8?(i=!0,n=1e8):n<-1e8&&(i=!0,n=-1e8),{cleanedSavings:n,wasCleaned:i}}y(document.readyState);async function tt({couponResult:e,triggerType:r,siteAPIData:c}={}){let{cleanedSavings:i,wasCleaned:n}=et(e.savings),p=new Date().getTime()-o.default.get(e,"startTime")||null,u=Z(i,{noDollarSign:!0})??"0",l=o.default.round(parseFloat(u),2);await chrome.storage.local.set({lastCouponSavings:l});let g=await je();w("track","tryCouponsResult",{triggerType:r,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:H(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,deweyOriginalTotal:e.deweyOriginalTotal,originalTotal:e.originalTotal,originalTotalV2:e.originalTotalV2,baseTotal:e.baseTotal,finalTotal:e.finalTotal,savingsOld:e.savings||0,savings:i,savingsCurrency:c?.siteData?.merchantPage?.currency,savingsWasCleaned:n,shopifyLoggedIn:e.shopLoggedIn,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:p,totalCouponsTested:o.default.get(e,"coupons.length"),coupons:o.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:o.default.get(e,"bestCoupon.code"),platform:e.platform,cartData:g,actionLog:e.actionLog,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}$e();
