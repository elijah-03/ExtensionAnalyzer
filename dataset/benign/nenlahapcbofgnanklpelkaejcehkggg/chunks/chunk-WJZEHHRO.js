import{a as p,h as n,n as k,o as c,v as f}from"./chunk-4XUWKJYA.js";import{l as I,n as R,s as x}from"./chunk-QWQLNDJC.js";import{b as z,c as A,d as D}from"./chunk-AYDLOBCW.js";import{a as v,c as N}from"./chunk-JENJKWHP.js";import{e as l}from"./chunk-3GYLW4KZ.js";function m(e){return e==="amazon.com"||e==="amazon.ca"||e==="c1-uk.amazon.co.uk"||e==="amazon.com.au"}var S=l(z());x();var r=l(A()),w=l(D());N();var P=e=>f("loadProduct",e);var i=n.select("notification");function O(e){if((e.asin||r.default.get(e,"gtins[0]"))!==n.get("currentASIN")&&!n.get("ignoreCurrentASIN")&&!e.instantOffers)return;e.instantOffers&&c("track","instantOffersReceived",{parentQuoteId:e.instantOffers.runId,quoteId:e.instantOffers.instantOffersRunId,trigger:n.get("trigger"),currentLocation:r.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let t=r.default.clone(i.get("run")||{});r.default.get(e,"run.runId")===r.default.get(t,"runId")&&e.modal&&(t.betterResults=r.default.map(r.default.get(t,"betterResults"),a=>(a.id===e.modal.id&&(a=e.modal),a))),i.merge({details:e.modal,run:r.default.isEmpty(t)?e.run:t,lastChance:!1,cartPricing:e.cartPricing}),C(e)}function C(e,o){let t=r.default.get(e,"cartPricing.savings")||e.run.savings;if((r.default.get(e,"run.inputData.asin")||r.default.get(e,"run.inputData.gtins[0]"))!==n.get("currentASIN")&&!o||i.get("activeRunId")===r.default.get(e.run,"runId"))return;e.run.status==="complete"&&(c("page","quoteCompleteNotification",{view:"quoteCompleteNotification",type:"notification",matchDomain:r.default.get(e.run,"betterResults[0].vendor",null),matchUrl:r.default.get(e.run,"betterResults[0].product.url",null),savings:t>0?t:null,paymentsSupport:!!r.default.get(e,"cartPricing.paymentsSupport")}),b(e.run),i.merge({activeRunId:r.default.get(e.run,"runId")}));let s=t>0;i.merge({run:e.run,currentSavings:t,updating:!0,lastSavings:i.get("currentSavings"),showPopup:s,resetting:!1,ignoreRun:!1})}function y(e){window.priceCheckId=w.default.v4(),i.set(["priceCheckStarted"],!0),c("track","priceCheckStart",{quoteId:e,priceCheckId:window.priceCheckId,trigger:n.get("trigger"),currentLocation:r.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}function b(e){i.get("priceCheckStarted")||(y(e.runId),i.set(["endFiredFirst"],e.runId)),i.set(["priceCheckStarted"],!1),c("track","priceCheckEnd",{quoteId:e.runId,category:r.default.get(e,"originResult.product.vendorCategory"),priceCheckId:window.priceCheckId,matchId:r.default.get(e,"betterResults[0].id")})}function B(){i.merge({run:{},estimateRun:null,firstResultWithSavings:null,details:null,cartPricing:null,currentSavings:0,updating:!0,lastSavings:i.get("currentSavings"),showPopup:!1,resetting:!0,ignoreRun:!1,communityDeal:null}),n.set("bestAmazonResult",null)}function X(){i.merge({ignoreRun:!0})}async function Y(){n.set("appReady",!0);let e=n.get("messages");await S.default.delay(1e3),r.default.forEach(e,o=>{o.type!=="resetNotification"&&F(o)}),n.set("messages",[])}function G(e,o){let t=r.default.find(e,s=>!!r.default.get(s,"meta.isOrigin")),a=r.default.get(t,"pricing.total");if(!t||!a)return!1;let u=(0,r.default)(e).map(s=>{let g=r.default.get(s,"pricing.total")?a-r.default.get(s,"pricing.total"):0;if(s.savings=g>0?g:0,!s.product.wbpid)try{let d=s.product.url.match(/gp\/product\/(.*)\/|dp\/(.*)\?/),h=d[2]||d[1];h&&(s.product.wbpid=`amazon.com_${h}`)}catch{}return s}).filter(s=>!!s.savings).sortBy(["savings",s=>{try{return R(I(s?.details?.arrival_date,"ccc. MMM. d"))}catch(g){v("*** failed to parse amazon result arrival date ***",g)}return 1/0}],["desc","asc"]).reverse().value();u&&u.length&&n.set("bestAmazonResult",u[0])}function F(e){if(!n.get("appReady")){n.push(["messages"],e);return}let{type:o,...t}=e;if(t)switch(o){case"setInputData":i.merge({inputData:t.inputData});break;case"modalDetailsReceived":O(t);break;case"runUpdated":C(t);break;case"abortRun":i.merge({run:{status:"complete",runId:r.default.get(t,"run.runId"),aborted:!0},currentSavings:0,updating:!1,lastSavings:i.get("currentSavings"),showPopup:!1,resetting:!1}),t.run&&b(t.run);break;case"resetNotification":B();break;case"setRunId":{i.get("endFiredFirst")!==t.runId&&(y(t.runId),i.set(["endFiredFirst"],null));break}case"amazonResultsReceived":G(e.amazonResults,e.runId);break;case"estimateRunReceived":i.set(["estimateRun"],t.run);break;case"firstResultWithSavingsReceived":i.set(["firstResultWithSavings"],t);break;default:console.log("unknown message",e)}}window.handleMessage=F;function Z(){let e=m(p()),o=k("ac_elasticity_2"),t=n.get(["couponView","partnerGroupsList"])?.groupA?.includes(p());return o&&t&&!e||!e&&!o}async function ee(e){if(n.get(["ProductPage","lastRunId"])===e.runId)return;n.get(["ProductPage"])?n.merge("ProductPage",{isFetching:!0,lastRunId:e.runId}):n.set("ProductPage",{isFetching:!0,lastRunId:e.runId});let t=await P(e);t?(t.isFetching=!1,n.merge("ProductPage",t)):n.merge("ProductPage",{isFetching:!1})}export{m as a,B as b,X as c,Y as d,Z as e,ee as f};
