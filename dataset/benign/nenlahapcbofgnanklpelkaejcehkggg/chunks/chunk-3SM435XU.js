import{f as b}from"./chunk-WJZEHHRO.js";import{d as h,h as s}from"./chunk-4XUWKJYA.js";import{b as E}from"./chunk-VWGTEQCV.js";import{b as H,c as L}from"./chunk-AYDLOBCW.js";import{a,c as O}from"./chunk-JENJKWHP.js";import{a as C}from"./chunk-PDIOZR2P.js";import{d as $,e as m}from"./chunk-3GYLW4KZ.js";var D=m(C());var R={};$(R,{abortRun:()=>x,addPriceRun:()=>T,amazonResultsReceived:()=>N,communityDealReceived:()=>k,estimateRunReceived:()=>S,firstResultWithSavingsReceived:()=>A,modalDetailsReceived:()=>M,setupPriceRunPusherBindings:()=>I,terminatePriceRun:()=>f,updatePriceRun:()=>_});var v=m(H()),P=m(E());O();var c=e=>g("pusherEvents",e);var d={},i={};function _(e,t){i[e]&&(i[e]={...i[e],...t})}function z(e,t){return setTimeout(()=>{f(e,t)},3e4)}function B(e,t){if(e)return setTimeout(()=>{o("abortRun",{run:{runId:t}}),c({eventType:"run-aborted",response:{runId:t}})},3e4)}function T(e,t,n){let r=z(t.userId,e),u=B(t.meta.isAmzProductPage,e);i[e]={input:t,inTabTimeoutIds:{abortAmzProductPageRunId:u,terminateRunId:r},pageData:n},a("**** added price run ****",e,i[e])}function f(e,t){i[t]&&(delete i[t],a("**** terminated price run ****",t)),V(e)}async function V(e){if(Object.keys(i).length>0)return;let t=await d[e];t&&(t.disconnect(),delete d[e],a("**** disconnected pusher ****",e))}function I(e){let{userId:t}=e;return d[t]?d[t].then(()=>v.default.resolve()):(d[t]=(0,P.setupPriceRunPusherBindings)(e,q(t),W,G,U),d[t].then(()=>v.default.resolve()))}function q(e){return async t=>{let n="run-finished-v2",{runId:r}=t;try{if(a(`**** handling event ${n} ****`,r,i[r]),!i[r]){a(`*** Terminating ${n} handler. Price run is not available.`);return}clearTimeout(i[r].inTabTimeoutIds.terminateRunId),clearTimeout(i[r].inTabTimeoutIds.abortAmzProductPageRunId),c({eventType:n,response:t,additionalData:i[r]})}catch(u){a("**** run-finished-v2 error ****",u.message,u.stack,{runId:r})}finally{f(e,r)}}}function W(e){let t="run-instantOffers",{runId:n}=e;try{if(a(`**** handling event ${t} ****`,n,i[n]),!i[n]){a(`*** Terminating ${t} handler. Price run is not available.`);return}c({eventType:t,response:e,additionalData:i[n]})}catch(r){a("**** run-instantOffers error ****",r.message,r.stack,{runId:n})}}function G(e){try{let t="run-priceRequest-v2",n=e.inputData?.meta?.tab?.id,r=s.get("tabId"),u=i[e.runId]||n===r&&{input:e.inputData};if(a(`**** handling event ${t} ****`,e.runId,e.result?.id,u),!i[e.runId]&&(!n||n!==r)){a(`*** Terminating ${t} handler. No price run or tab data available.`);return}c({eventType:t,response:e,additionalData:u})}catch(t){a("**** run price request error ****",t.message,t.stack,{runId:e.runId,priceId:e.result?.id})}}function U(e){let t="first-result-with-savings",{runId:n}=e;try{a(`**** handling event ${t} ****`,n,i[n]);let r=e.tabId,u=s.get("tabId");if(!i[n]&&(!r||r!==u)){a(`*** Terminating ${t} handler. No price run or tab data available.`);return}c({eventType:t,response:e})}catch(r){a(`**** ${t} error ****`,r.message,r.stack,{runId:n})}}var x=e=>{o("abortRun",e)};var l=m(L());var y;async function w(e){y=e,s.set(["siteHubView","primaryDeal"],e),j([]);let t=e.id,n=e.runId,r=e.asin;b({id:t,asin:r,runId:n})}function j(e){e=l.default.filter(e,n=>n.savings);let t=s.get(["siteHubView","deals"]);t?t=(0,l.default)(t.concat(e)).uniq("asin").filter(n=>n.asin!==l.default.get(y,"asin")).value():t=e,s.set(["siteHubView","deals"],t)}var k=e=>{if(e&&!e.error&&e.deal.asin===s.get("currentASIN")){s.set(["notification","communityDeal"],e);let t=e.deal;w(t)}else e&&e.error&&s.set(["notification","communityDeal"],e)};var N=e=>{o("amazonResultsReceived",e)};var S=e=>{o("estimateRunReceived",e)};var A=e=>{o("firstResultWithSavingsReceived",e)};var M=e=>{o("modalDetailsReceived",e)};var F="__wikibuy_instant_content_pc",J="__wikibuy_instant_bg_pc",K="__wikibuy_instant_external_messages_pc";function Q(e){return R[e]}var p=window.wb_messenger_pc;if(!p){let e=chrome.runtime.connect(chrome.runtime.id,{name:K});p=window.wb_messenger_pc=(0,D.default)(Q,t=>{chrome.runtime.sendMessage({src:F,data:t})},{getId:h}),chrome.runtime.onMessage.addListener(t=>{t.src===J&&p.handleMessage(t.data)})}function g(e,t={}){return p.invoke(e,[t])}function o(e,t={}){window.handleMessage&&window.handleMessage({type:e,...t})}export{g as a,o as b};
