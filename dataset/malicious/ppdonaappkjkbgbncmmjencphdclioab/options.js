"use strict";function wrapper(e,...t){return function(...i){let o,n=Object.assign(Object.create(null),e);if(i.length>0){let e=i[i.length-1];"function"==typeof e&&(o=e);for(let e=0;e<i.length-(o?1:0);e++)n[t[e]]=i[e]}ext.backgroundPage.sendMessage(n,o)}}const getDocLink=wrapper({type:"app.get",what:"doclink"},"link"),getInfo=wrapper({type:"app.get"},"what"),getPref=wrapper({type:"prefs.get"},"key"),togglePref=wrapper({type:"prefs.toggle"},"key"),getSubscriptions=wrapper({type:"subscriptions.get"},"downloadable","special"),removeSubscription=wrapper({type:"subscriptions.remove"},"url"),addSubscription=wrapper({type:"subscriptions.add"},"url","title","homepage"),toggleSubscription=wrapper({type:"subscriptions.toggle"},"url","keepInstalled"),updateSubscription=wrapper({type:"subscriptions.update"},"url"),importRawFilters=wrapper({type:"filters.importRaw"},"text","removeExisting"),addFilter=wrapper({type:"filters.add"},"text"),removeFilter=wrapper({type:"filters.remove"},"text"),quoteCSS=wrapper({type:"composer.quoteCSS"},"CSS"),whitelistedDomainRegexp=/^@@\|\|([^/:]+)\^\$document$/,statusMessages=new Map([["synchronize_invalid_url","filters_subscription_lastDownload_invalidURL"],["synchronize_connection_error","filters_subscription_lastDownload_connectionError"],["synchronize_invalid_data","filters_subscription_lastDownload_invalidData"],["synchronize_checksum_mismatch","filters_subscription_lastDownload_checksumMismatch"]]);let acceptableAdsUrl,delayedSubscriptionSelection=null;function loadOptions(){document.title=i18n.getMessage("options"),getPref("subscriptions_exceptionsurl",(e=>{acceptableAdsUrl=e,$("#acceptableAdsLink").attr("href",acceptableAdsUrl)})),getDocLink("acceptable_ads",(e=>{$("#acceptableAdsDocs").attr("href",e)})),getDocLink("filterdoc",(e=>{setLinks("filter-must-follow-syntax",e)})),getInfo("application",(e=>{getInfo("platform",(t=>{"chromium"==t&&"opera"!=e&&(e="chrome"),getDocLink(e+"_support",(e=>{setLinks("found-a-bug",e)})),"gecko"==t&&$("#firefox-warning").removeAttr("hidden")}))})),$("#updateFilterLists").click(updateFilterLists),$("#startSubscriptionSelection").click(startSubscriptionSelection),$("#subscriptionSelector").change(updateSubscriptionSelection),$("#addSubscription").click(addSubscriptionClicked),$("#acceptableAds").click(toggleAcceptableAds),$("#whitelistForm").submit(addWhitelistDomain),$("#removeWhitelist").click(removeSelectedExcludedDomain),$("#customFilterForm").submit(addTypedFilter),$("#removeCustomFilter").click(removeSelectedFilters),$("#rawFiltersButton").click(toggleFiltersInRawFormat),$("#importRawFilters").click(importRawFiltersText),$("#tabs").tabs(),$("button").button(),$(".refreshButton").button("option","icons",{primary:"ui-icon-refresh"}),$(".addButton").button("option","icons",{primary:"ui-icon-plus"}),$(".removeButton").button("option","icons",{primary:"ui-icon-minus"}),initCheckbox("shouldShowBlockElementMenu"),initCheckbox("show_devtools_panel"),initCheckbox("shouldShowNotifications","notifications_ignoredcategories"),getInfo("features",(e=>{e.devToolsPanel||(document.getElementById("showDevtoolsPanelContainer").hidden=!0)})),getPref("notifications_showui",(e=>{e||(document.getElementById("shouldShowNotificationsContainer").hidden=!0)})),ext.backgroundPage.sendMessage({type:"app.listen",filter:["addSubscription","focusSection"]}),ext.backgroundPage.sendMessage({type:"filters.listen",filter:["added","loaded","removed"]}),ext.backgroundPage.sendMessage({type:"prefs.listen",filter:["notifications_ignoredcategories","notifications_showui","show_devtools_panel","shouldShowBlockElementMenu"]}),ext.backgroundPage.sendMessage({type:"subscriptions.listen",filter:["added","disabled","homepage","lastDownload","removed","title","downloadStatus","downloading"]}),loadRecommendations(),reloadFilters()}function convertSpecialSubscription(e){for(let t of e.filters)whitelistedDomainRegexp.test(t.text)?appendToListBox("excludedDomainsBox",RegExp.$1):appendToListBox("userFiltersBox",t.text)}function reloadFilters(){let e=document.getElementById("filterLists");for(;e.lastChild;)e.removeChild(e.lastChild);getSubscriptions(!0,!1,(e=>{for(let t of e)t.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!t.disabled):addSubscriptionEntry(t)})),getSubscriptions(!1,!0,(e=>{document.getElementById("userFiltersBox").innerHTML="",document.getElementById("excludedDomainsBox").innerHTML="";for(let t of e)convertSpecialSubscription(t)}))}function initCheckbox(e,t){t=t||e;let i=document.getElementById(e);getPref(t,(e=>{onPrefMessage(t,e)})),i.addEventListener("click",(()=>{togglePref(t)}),!1)}function loadRecommendations(){fetch("subscriptions.xml").then((e=>e.text())).then((e=>{let t=0,i=null,o=0,n=document.getElementById("subscriptionSelector"),s=(new DOMParser).parseFromString(e,"application/xml").documentElement.getElementsByTagName("subscription");for(let e=0;e<s.length;e++){let l=s[e],r=new Option;r.text=l.getAttribute("title")+" ("+l.getAttribute("specialization")+")",r._data={title:l.getAttribute("title"),url:l.getAttribute("url"),homepage:l.getAttribute("homepage")};let a=l.getAttribute("prefixes");a&&(a=a.replace(/\W/g,"_"),r.style.fontWeight="bold",r.style.backgroundColor="#E0FFE0",r.style.color="#000000",!i||i.length<a.length?(t=e,i=a,o=1):i&&i.length==a.length&&(o++,Math.random()*o<1&&(t=e,i=a))),n.appendChild(r)}let l=new Option,r=i18n.getMessage("filters_addSubscriptionOther_label");l.text=r+"…",l._data=null,n.appendChild(l),n.selectedIndex=t,delayedSubscriptionSelection&&startSubscriptionSelection(...delayedSubscriptionSelection)}))}function startSubscriptionSelection(e,t){let i=document.getElementById("subscriptionSelector");0!=i.length?($("#tabs").tabs("select",0),$("#addSubscriptionContainer").show(),$("#addSubscriptionButton").hide(),$("#subscriptionSelector").focus(),void 0!==t&&(i.selectedIndex=i.length-1,document.getElementById("customSubscriptionTitle").value=e,document.getElementById("customSubscriptionLocation").value=t),updateSubscriptionSelection(),document.getElementById("addSubscriptionContainer").scrollIntoView(!0)):delayedSubscriptionSelection=[e,t]}function updateSubscriptionSelection(){let e=document.getElementById("subscriptionSelector");e.options[e.selectedIndex]._data?$("#customSubscriptionContainer").hide():($("#customSubscriptionContainer").show(),$("#customSubscriptionTitle").focus())}function addSubscriptionClicked(){let e=document.getElementById("subscriptionSelector"),t=e.options[e.selectedIndex]._data;if(t)addSubscription(t.url,t.title,t.homepage);else{let e=document.getElementById("customSubscriptionLocation").value.trim();if(!/^https?:/i.test(e))return alert(i18n.getMessage("global_subscription_invalid_location")),void $("#customSubscriptionLocation").focus();let t=document.getElementById("customSubscriptionTitle").value.trim();t||(t=e),addSubscription(e,t,null)}$("#addSubscriptionContainer").hide(),$("#customSubscriptionContainer").hide(),$("#addSubscriptionButton").show()}function toggleAcceptableAds(){toggleSubscription(acceptableAdsUrl,!0)}function findSubscriptionElement(e){for(let t of document.getElementById("filterLists").childNodes)if(t._subscription.url==e.url)return t;return null}function updateSubscriptionInfo(e,t){t?e._subscription=t:t=e._subscription;let i=e.getElementsByClassName("subscriptionTitle")[0];i.textContent=t.title,i.setAttribute("title",t.url),t.homepage?i.href=t.homepage:i.href=t.url,e.getElementsByClassName("subscriptionEnabled")[0].checked=!t.disabled;let o=e.getElementsByClassName("subscriptionUpdate")[0];o.classList.remove("error");let{downloadStatus:n}=t;if(t.isDownloading)o.textContent=i18n.getMessage("filters_subscription_lastDownload_inProgress");else if(n&&"synchronize_ok"!=n)statusMessages.has(n)?o.textContent=i18n.getMessage(statusMessages.get(n)):o.textContent=n,o.classList.add("error");else if(t.lastDownload>0){let e=i18nTimeDateStrings(1e3*t.lastDownload),i=e[1]?"last_updated_at":"last_updated_at_today";o.textContent=i18n.getMessage(i,e)}}function onSubscriptionMessage(e,t){let i=findSubscriptionElement(t);switch(e){case"disabled":case"downloading":case"downloadStatus":case"homepage":case"lastDownload":case"title":i&&updateSubscriptionInfo(i,t);break;case"added":0==t.url.indexOf("~user")?convertSpecialSubscription(t):t.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!0):i||addSubscriptionEntry(t);break;case"removed":t.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!1):i&&i.parentNode.removeChild(i)}}function onPrefMessage(e,t){switch(e){case"notifications_showui":return void(document.getElementById("shouldShowNotificationsContainer").hidden=!t);case"notifications_ignoredcategories":e="shouldShowNotifications",t=-1==t.indexOf("*")}let i=document.getElementById(e);i&&(i.checked=t)}function onFilterMessage(e,t){switch(e){case"loaded":reloadFilters();break;case"added":whitelistedDomainRegexp.test(t.text)?appendToListBox("excludedDomainsBox",RegExp.$1):appendToListBox("userFiltersBox",t.text);break;case"removed":whitelistedDomainRegexp.test(t.text)?removeFromListBox("excludedDomainsBox",RegExp.$1):removeFromListBox("userFiltersBox",t.text)}}function appendToListBox(e,t){let i=new Option;i.text=t,i.value=t,document.getElementById(e).appendChild(i)}function removeFromListBox(e,t){let i=document.getElementById(e);quoteCSS(t,(e=>{let t="option[value="+e+"]";for(let e of i.querySelectorAll(t))i.removeChild(e)}))}function addWhitelistDomain(e){e.preventDefault();let t=document.getElementById("newWhitelistDomain").value.replace(/\s/g,"");document.getElementById("newWhitelistDomain").value="",t&&addFilter("@@||"+t+"^$document")}function addTypedFilter(e){e.preventDefault();let t=document.getElementById("newFilter");addFilter(t.value,(e=>{e.length>0?alert(e.join("\n")):t.value=""}))}function removeSelectedExcludedDomain(e){e.preventDefault();let t=[];for(let e of document.getElementById("excludedDomainsBox").options)e.selected&&t.push(e.value);if(t.length)for(let e of t)removeFilter("@@||"+e+"^$document")}function removeSelectedFilters(e){e.preventDefault();let t=document.querySelectorAll("#userFiltersBox > option:checked");for(let e of t)removeFilter(e.value)}function toggleFiltersInRawFormat(e){e.preventDefault();let t=document.getElementById("rawFilters"),i=[];if("table-row"!=t.style.display){t.style.display="table-row";for(let e of document.getElementById("userFiltersBox").options)i.push(e.value)}else t.style.display="none";document.getElementById("rawFiltersText").value=i.join("\n")}function importRawFiltersText(){let e=document.getElementById("rawFiltersText").value;importRawFilters(e,!0,(e=>{e.length>0?alert(e.join("\n")):$("#rawFilters").hide()}))}function updateFilterLists(){updateSubscription()}function addSubscriptionEntry(e){let t=document.getElementById("subscriptionTemplate").cloneNode(!0);t.removeAttribute("id"),t._subscription=e;let i=t.getElementsByClassName("subscriptionRemoveButton")[0];i.setAttribute("title",i.textContent),i.textContent="×",i.addEventListener("click",(()=>{confirm(i18n.getMessage("global_remove_subscription_warning"))&&removeSubscription(e.url)}),!1),getPref("additional_subscriptions",(t=>{t.includes(e.url)&&(i.style.visibility="hidden")})),t.getElementsByClassName("subscriptionEnabled")[0].addEventListener("click",(()=>{e.disabled=!e.disabled,toggleSubscription(e.url,!0)}),!1),updateSubscriptionInfo(t),document.getElementById("filterLists").appendChild(t)}function setLinks(e,...t){let i=document.getElementById(e);if(!i)return;let o=i.getElementsByTagName("a");for(let e=0;e<o.length;e++)"string"==typeof t[e]?(o[e].href=t[e],o[e].setAttribute("target","_blank")):"function"==typeof t[e]&&(o[e].href="javascript:void(0);",o[e].addEventListener("click",t[e],!1))}$(loadOptions),ext.onMessage.addListener((e=>{switch(e.type){case"app.respond":switch(e.action){case"addSubscription":let t=e.args[0];startSubscriptionSelection(t.title,t.url);break;case"focusSection":for(let t of document.getElementsByClassName("ui-tabs-panel")){let i=t.querySelector("[data-section='"+e.args[0]+"']");if(!i)continue;let o=document.getElementsByClassName("focused");o.length>0&&o[0].classList.remove("focused");let n=$("[href='#"+t.id+"']").parent().index();$("#tabs").tabs("select",n),i.classList.add("focused")}}break;case"filters.respond":onFilterMessage(e.action,e.args[0]);break;case"prefs.respond":onPrefMessage(e.action,e.args[0]);break;case"subscriptions.respond":onSubscriptionMessage(e.action,e.args[0])}}));