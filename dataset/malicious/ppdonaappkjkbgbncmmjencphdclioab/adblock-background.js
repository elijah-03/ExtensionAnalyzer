var getDecodedHostname=require("url").getDecodedHostname;with(require("filterClasses"))this.Filter=Filter,this.WhitelistFilter=WhitelistFilter;with(require("subscriptionClasses"))this.Subscription=Subscription,this.SpecialSubscription=SpecialSubscription,this.DownloadableSubscription=DownloadableSubscription;with(require("filterValidation"))this.parseFilter=parseFilter,this.parseFilters=parseFilters;var FilterStorage=require("filterStorage").FilterStorage,FilterNotifier=require("filterNotifier").FilterNotifier,Prefs=require("prefs").Prefs,Synchronizer=require("synchronizer").Synchronizer,Utils=require("utils").Utils,NotificationStorage=require("notification").Notification,punycode=require("punycode");const{RegExpFilter:RegExpFilter}=require("filterClasses");var SAFARI=!1,createPageWhitelistFilter=function(e){var t=(e=e.replace(/#.*$/,"")).match(/^([^\?]+)(\??)/),r=t[2],o="@@|"+t[1]+(r?"?":"|")+"$document";return addCustomFilter(o)},tryToUnwhitelist=function(e){e=e.replace(/#.*$/,"");var t=getUserFilters();if(!t||0===!t.length)return!1;for(var r=0;r<t.length;r++){var o=t[r];if(o.search(/@@\*\$document,domain=\~/)>-1){e=e.replace(/((http|https):\/\/)?(www.)?/,"").split(/[/?#]/)[0];var i=Filter.fromText(o);FilterStorage.removeFilter(i);var n=Filter.fromText(o+"|~"+e);return FilterStorage.addFilter(n),!0}if(isWhitelistFilter(o)){try{var s=Filter.fromText(o)}catch(e){continue}if(s.matches(e,RegExpFilter.typeMap.DOCUMENT,!1))return FilterStorage.removeFilter(s),!0}}return!1},addCustomFilter=function(e){try{var t=Filter.fromText(e);return FilterStorage.addFilter(t),isSelectorFilter(e)&&countCache.addCustomFilterCount(e),null}catch(e){return e.toString()}},removeCustomFilter=function(e){var t=getUserFilters();if(!t||0===!t.length)return!1;for(var r=e,o=0;o<t.length;o++){var i=t[o];if(0===i.indexOf(r)){var n=Filter.fromText(i);FilterStorage.removeFilter(n)}}},countCache=function(){var e,t=function(){ext.storage.set("custom_filter_count",e)};return{updateCustomFilterCountMap:function(r){e=r||e,t()},removeCustomFilterCount:function(r){r&&e[r]&&(delete e[r],t())},getCustomFilterCount:function(t){return e[t]||0},addCustomFilterCount:function(r){var o=r.split("##")[0];e[o]=this.getCustomFilterCount(o)+1,t()},init:function(){ext.storage.get("custom_filter_count",(function(t){e=t.custom_filter_count||{}}))}}}();countCache.init();var updateCustomFilterCountMap=function(e){countCache.updateCustomFilterCountMap(e)},removeCustomFilterForHost=function(e){countCache.getCustomFilterCount(e)&&(removeCustomFilter(e),countCache.removeCustomFilterCount(e))},confirmRemovalOfCustomFiltersOnHost=function(e,t){var r=countCache.getCustomFilterCount(e),o=translate("confirm_undo_custom_filters",[r,e]);confirm(o)&&(removeCustomFilterForHost(e),SAFARI?t.url=t.url:chrome.tabs.reload(t.id))},reloadTab=function(e,t){var r=t,o=function(e,t,i){"complete"===t.status&&"complete"===i.status&&setTimeout((function(){chrome.tabs.sendMessage(e,{command:"reloadcomplete"}),"function"==typeof r&&r(i),chrome.tabs.onUpdated.removeListener(o)}),2e3)};"string"==typeof e&&(e=parseInt(e)),chrome.tabs.onUpdated.addListener(o),chrome.tabs.reload(e,{bypassCache:!0},(function(){}))},isSelectorFilter=function(e){return/\#\@?\#./.test(e)},isWhitelistFilter=function(e){return/^\@\@/.test(e)},isSelectorExcludeFilter=function(e){return/\#\@\#./.test(e)};ext.onMessage.addListener((function(e,t,r){if("call"==e.command){var o=window[e.fn];e.args&&e.args.push&&e.args.push(t),r(o.apply(window,e.args))}}));var getAdblockUserId=function(){return STATS.userId()},addGABTabListeners=function(e){gabQuestion.addGABTabListeners(e)},removeGABTabListeners=function(e){gabQuestion.removeGABTabListeners(e)},getCurrentTabInfo=function(e,t){ext.pages.query({active:!0,lastFocusedWindow:!0},(function(r){if(0!==r.length)if(page=r[0],!page||page.url){page.unicodeUrl=getUnicodeUrl(page.url.href);var o=pageIsUnblockable(page.unicodeUrl),i=(Prefs.show_statsinicon,{page:page,disabledSite:o,settings:getSettings()});o||(i.whitelisted=checkWhitelisted(page)),e(i)}else t||window.setTimeout((function(){getCurrentTabInfo(e,!0)}),250)}))},pageIsUnblockable=function(e){if(e){var t="";return"http:"!==(t=e.protocol?e.protocol:parseUri(e).protocol)&&"https:"!==t&&"feed:"!==t}return!0},pageIsWhitelisted=function(e){return null!=checkWhitelisted(e.page)},pausedKey="paused",pausedFilterText1="@@",pausedFilterText2="@@^$document",adblockIsPaused=function(e){if(void 0===e)return!0===sessionstorage_get(pausedKey);var t=parseFilter(pausedFilterText1),r=parseFilter(pausedFilterText2);!0===e?(FilterStorage.addFilter(t.filter),FilterStorage.addFilter(r.filter),ext.storage.set(pausedKey,!0)):(FilterStorage.removeFilter(t.filter),FilterStorage.removeFilter(r.filter),ext.storage.remove(pausedKey)),sessionstorage_set(pausedKey,e)};ext.storage.get(pausedKey,(function(e){if(e[pausedKey]){var t=function(e){if("load"==e){FilterNotifier.removeListener(t);var r=parseFilter(pausedFilterText1),o=parseFilter(pausedFilterText2);FilterStorage.removeFilter(r.filter),FilterStorage.removeFilter(o.filter),ext.storage.remove(pausedKey)}};FilterNotifier.addListener(t)}}));var readfile=function(e){var t=new XMLHttpRequest;return t.open("GET",chrome.extension.getURL(e),!1),t.send(),t.responseText};SAFARI||""!==chrome.runtime.id||chrome.runtime.onInstalled.addListener((function(e){"update"===e.reason||e.reason}));var updateStorageKey="last_known_version";chrome.runtime.onInstalled.addListener((function(e){"update"!==e.reason&&"install"!==e.reason||localStorage.setItem(updateStorageKey,chrome.runtime.getManifest().version)}));var openTab=function(e){ext.pages.open(e)},createWhitelistFilterForYoutubeChannel=function(e){if(/ab_channel=/.test(e))var t=e.match(/ab_channel=([^]*)/)[1];else t=e.split("/").pop();if(t)return addCustomFilter("@@|https://www.youtube.com/*"+t+"|$document")};if(!SAFARI){var runChannelWhitelist=function(e,t){"www.youtube.com"===parseUri(e).hostname&&getSettings().youtube_channel_whitelist&&!parseUri.parseSearch(e).ab_channel&&chrome.tabs.executeScript(t,{file:"adblock-ytchannel.js",runAt:"document_start"}),"www.youtube.com"===parseUri(e).hostname&&chrome.tabs.executeScript(t,{file:"adblock-ytpreroll.js",runAt:"document_start"})};chrome.tabs.onCreated.addListener((function(e){chrome.runtime.lastError||chrome.tabs.get(e.id,(function(e){chrome.runtime.lastError||e&&e.url&&e.id&&runChannelWhitelist(e.url,e.id)}))})),chrome.tabs.onUpdated.addListener((function(e,t,r){if(!chrome.runtime.lastError&&"loading"===t.status){if(chrome.runtime.lastError)return;chrome.tabs.get(e,(function(e){e&&e.url&&e.id&&runChannelWhitelist(e.url,e.id)}))}}));var youTubeHistoryStateUpdateHanlder=function(e){if(e&&e.hasOwnProperty("frameId")&&e.hasOwnProperty("tabId")&&e.hasOwnProperty("url")&&e.hasOwnProperty("transitionType")&&"link"===e.transitionType){var t=new URL(e.url);if("www.youtube.com"===t.hostname){var r=ext.getFrame(e.tabId,e.frameId),o=ext.getPage(e.tabId),i=checkWhitelisted(o);o.url=t,o._url=t,r.url=t,r._url=t;var n=checkWhitelisted(o);n||n===i||o.sendMessage({type:"reloadStyleSheet"})}}},addYouTubeHistoryStateUpdateHanlder=function(){chrome.webNavigation.onHistoryStateUpdated.addListener(youTubeHistoryStateUpdateHanlder)},removeYouTubeHistoryStateUpdateHanlder=function(){chrome.webNavigation.onHistoryStateUpdated.removeListener(youTubeHistoryStateUpdateHanlder)};_settings.onload().then((function(){getSettings().youtube_channel_whitelist&&addYouTubeHistoryStateUpdateHanlder()}))}function isSafariContentBlockingAvailable(){return SAFARI&&safari&&safari.extension&&"function"==typeof safari.extension.setContentBlocker}var getDebugInfo=function(e){response={},response.other_info={},SAFARI?safari.extension.baseURI.indexOf("com.betafish.adblockforsafari-UAMUU4S2D9")>-1?response.other_info.buildtype=" Stable":response.other_info.buildtype=" Unofficial":"pljaalgmajnlogcgiohkhdmgpomjcihk"===chrome.runtime.id?response.other_info.buildtype=" Beta":"gighmmpiobklfepjocnamgkkbiglidom"===chrome.runtime.id||"aobdicepooefnbaeokijohmhjlleamfj"===chrome.runtime.id?response.other_info.buildtype=" Stable":response.other_info.buildtype=" Unofficial",response.other_info.version=chrome.runtime.getManifest().version;var t={},r=getSubscriptionsMinusText();for(var o in r)r[o].subscribed&&(t[o]={},t[o].lastSuccess=new Date(1e3*r[o].lastSuccess),t[o].lastDownload=new Date(1e3*r[o].lastDownload),t[o].downloadCount=r[o].downloadCount,t[o].downloadStatus=r[o].downloadStatus);response.subscriptions=t;var i=getUserFilters();i&&i.length&&(response.custom_filters=i.join("\n"));var n={},s=getSettings();for(setting in s)n[setting]=JSON.stringify(s[setting]);if(response.settings=n,response.prefs=JSON.stringify(Prefs),response.other_info.browser=STATS.browser,response.other_info.browserVersion=STATS.browserVersion,response.other_info.osVersion=STATS.osVersion,response.other_info.os=STATS.os,window.blockCounts&&(response.other_info.blockCounts=blockCounts.get()),localStorage&&localStorage.length){response.other_info.localStorageInfo={},response.other_info.localStorageInfo.length=localStorage.length;var a=1;for(var l in localStorage)response.other_info.localStorageInfo["key"+a]=l,a++}else response.other_info.localStorageInfo="no data";response.other_info.is_adblock_paused=adblockIsPaused(),ext.storage.get("total_pings",(function(t){response.other_info.total_pings=t.total_pings||0;var r="exclude_filters";chrome.storage.local.get(r,(function(t){t&&t.exclude_filters&&(response.excluded_filters=t.exclude_filters);var r="migrateLogMessageKey";chrome.storage.local.get(r,(function(t){if(t&&t.migrateLogMessageKey){messages=t.migrateLogMessageKey.split("\n");for(var r=0;r<messages.length;r++){var o="migration_message_"+r;response.other_info[o]=messages[r]}}e&&e(response)}))}))}))};function updateFilterLists(){for(var e=0;e<FilterStorage.subscriptions.length;e++){var t=FilterStorage.subscriptions[e];t instanceof DownloadableSubscription&&Synchronizer.execute(t,!0,!0)}}function getUserFilters(){for(var e=[],t=0;t<FilterStorage.subscriptions.length;t++){var r=FilterStorage.subscriptions[t];if(r instanceof SpecialSubscription)for(var o=0;o<r.filters.length;o++){var i=r.filters[o];e.push(i.text)}}return e}getUnicodeDomain=function(e){return e?punycode.toUnicode(e):e},getUnicodeUrl=function(e){if(e&&e.indexOf("xn--")>0){var t=parseUri(e);return t.href=t.href.replace(t.hostname,punycode.toUnicode(t.hostname)),t.href}return e};