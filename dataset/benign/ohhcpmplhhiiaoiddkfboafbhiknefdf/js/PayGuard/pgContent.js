(()=>{"use strict";function t(){return-1!=navigator.userAgent.indexOf("Firefox")}function e(){return t()?browser:chrome}function n(){e().storage.local.get("debug",t=>{t.debug&&console&&console.log&&console.log.apply(this,arguments)})}function a(){console&&console.error&&console.error.apply(this,arguments)}const o={isFirefox:t,getBrowser:e,logInfo:n,logError:a,getCurrentLocale:function t(){void 0===t.locale_map&&TMExt_$.ajax({url:getURL("settings.json"),async:!1,dataType:"json",success:function(e){n(e),t.locale_map=e.supportLanguage,t.default_lang=e.defaultLanguage,t.l10n_map=e.l10nFolderMap}});let e=navigator.language,a=!1,o=t.locale_map,r="";for(var s=0;s<o.length;++s)if(o[s].includes(e)){r=o[s],a=!0;break}a||(r=t.default_lang);let i=r;return void 0!==t.l10n_map[r]&&(i=t.l10n_map[r]),i},tbc_sendRequest:function(t,n,a){var o={action:t,params:n};e().runtime.sendMessage(o,a)},getBankingList:async function(){let t=[];try{const n=await fetch(e().runtime.getURL("PbBankingList.txt"));t=(await n.text()).split("\n")}catch(t){a("getBankingList: e = "+t)}return n("getBankingList: size of banking list = "+t.length),t},binarySearch:function t(e,n,a,o){if(o<a)return-1;if(o-a<=1)return n===e[a]?a:n===e[o]?o:-1;let r=Math.floor((a+o)/2);return e[r]===n?r:e[r]<n?t(e,n,r,o):e[r]>n?t(e,n,a,r):-1},sendMessageToActiveTab:function(t){return new Promise((n,a)=>{const o=e();o.tabs.query({active:!0,currentWindow:!0},e=>{e.length<=0?n(!1):o.tabs.sendMessage(e[0].id,t,()=>{o.runtime.lastError&&a(o.runtime.lastError.message)})})})},sha256:async function(t){let e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(n)].map(t=>t.toString(16).padStart(2,"0")).join("")},Lock:class{constructor(){this._locked=!1,this._waiting=[]}async acquire(){for(;this._locked;)await new Promise(t=>this._waiting.push(t));this._locked=!0}release(){this._locked=!1,this._waiting.length>0&&this._waiting.shift()()}}};let r=e();const s=function(t){return new Promise(e=>{r.storage.local.get(t,t=>{e(t)})})},i=o.getBrowser(),l="[PG][Content]";let u=0,c=!1;const g=()=>u,d=()=>new Promise(t=>{window.getPgTutorialFlag=g;let e={scripts:["js/PayGuard/pgPromotion.js"],csses:["js/PayGuard/styles.css"],all_frames:!1};o.logInfo(l,"loadPromotionLoader: param = "+JSON.stringify(e)),i.runtime.sendMessage({action:"tbb_inject_resources",parameters:e},()=>{o.logInfo(l,"loadPromotionLoader: sciprts are injected"),t(!0)})}),f=t=>{o.logInfo(l,"onShowPayguardTutorialResult: result = "+JSON.stringify(t)),t.hasOwnProperty("need_tutorial")&&!c&&(c=!0,u=t.need_tutorial,o.logInfo(l,"onShowPayguardTutorialResult: _tutorialFlag = "+u),1===u||4===u?i.runtime.sendMessage({action:"tbb_paygurad_check_banking_list",url:document.location.href,tutorial_flag:u},t=>{(t=>{if(o.logInfo(l,"onPayGuardCheckBankingListResult: result = "+t),t)switch(u){case 1:d();break;case 4:d(),i.runtime.sendMessage({action:"tbb_open_paygurad",url:document.location.href,autoOpen:!0})}})(t)}):o.logInfo(l,"onShowPayguardTutorialResult: do not take action"))},_=()=>{s({framework_status:!1,ratingResult:{}}).then(t=>{if(!t.framework_status)return void setTimeout(()=>{_()},1e3);let e=!1,n=!1;for(let a in t.ratingResult){let r=t.ratingResult[a];if(r.wtp_blocked_url===location.href){e=!0;let t=r.wtp_rating_result;switch(o.logInfo("checkPayguardPromotion: level = "+t),t){case 3:case 4:case 7:case 8:case 9:n=!0}break}}e?n||(()=>{const t=()=>{c||(i.runtime.sendMessage({action:"tbb_show_paygurad_tutorial"},f),setTimeout(t,5e3))};t()})():setTimeout(()=>{_()},1e3)})};_()})();