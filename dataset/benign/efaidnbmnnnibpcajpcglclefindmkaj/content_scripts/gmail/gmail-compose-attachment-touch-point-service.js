/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{createURLForAttachment,updateDrivePDFUrl}from"./util.js";import{getElementListForSelectors,buildAcrobatPromotionSource,createAcrobatIconElement,getElementsListBasedOnSelectors,getFirstElementBasedOnSelectors,sendAnalytics,sendErrorLog}from"../utils/util.js";import state from"./state.js";const GMAIL_COMPRESS_TOUCH_POINT_ICON_CLASS="gmail-compress-pdf-touch-point-icon",GMAIL_COMPRESS_TOUCH_POINT_TEXT_CLASS="gmail-compress-pdf-touch-point-text",GMAIL_COMPRESS_TOUCH_POINT_CLASS="gmail-compress-pdf-touch-point",GMAIL_COMPRESS_TOUCH_POINT_DRIVE_CLASS="gmail-compress-pdf-drive-touch-point",GMAIL_COMPRESS_PDF_CONTAINER_HOVER_CLASS="acrobat-compress-pdf-container-hover",GMAIL_DRIVE_ATTACHMENT_HOSTNAME="drive.google.com",GMAIL_FILES_ATTACHMENT_HOSTNAME="mail.google.com",ACROBAT_PROCESSED_ATTRIBUTE="acrobat-compress-pdf-processed",ACROBAT_PROCESSED_VALUE="Y",SOURCE="gmail_chrome",createCompressPDFTextElement=()=>{const e=document.createElement("span");return e.setAttribute("class","gmail-compress-pdf-touch-point-text"),e.textContent=state?.gmailCompressPDFConfig?.compressPDFString,e},createCompressPDFTouchPoint=(e,t)=>{const o=document.createElement("div"),s=createAcrobatIconElement("gmail-compress-pdf-touch-point-icon","browser/images/acrobat_dc_appicon_128.png"),r=createCompressPDFTextElement();return o.appendChild(s),o.appendChild(r),o.setAttribute("class","gmail-compress-pdf-touch-point"),"drive"===t&&(o.classList.add("gmail-compress-pdf-drive-touch-point"),e.style.position="relative"),o},handleCompressPDFTouchPointClick=(e,t)=>o=>{try{o.preventDefault(),o.stopPropagation(),window.open(e,"_blank"),sendAnalytics([["DCBrowserExt:DirectVerb:CTA:Clicked",{source:SOURCE,workflow:t}]]),chrome.runtime.sendMessage({main_op:"akamai-ping"})}catch(e){sendErrorLog("GmailCompressPDFTouchPoint","Failure in opening pdf on compress PDF touch point click")}},addTouchPointToMessageWithPDFAttachment=(e,t)=>{try{const o="file"===t?"compress_pdf_file":"compress_pdf_drive",s=buildAcrobatPromotionSource(SOURCE,o);let r=e.url.toString();r&&"drive"===t&&(r=updateDrivePDFUrl(r));const n=createURLForAttachment(r,s,e.name,"compresspdf"),a=createCompressPDFTouchPoint(e.message,t);a.addEventListener("click",handleCompressPDFTouchPointClick(n,o)),e.message.classList.add("acrobat-compress-pdf-container-hover"),e.message.appendChild(a),e.message.setAttribute(ACROBAT_PROCESSED_ATTRIBUTE,"Y"),sendAnalytics([["DCBrowserExt:DirectVerb:CTA:Shown",{source:SOURCE,workflow:o}]])}catch(e){sendErrorLog("GmailCompressPDFTouchPoint","Failure in adding compress PDF touch point to message with PDF attachment")}},isValidPDFDocumentUrl=({message:e,url:t,name:o})=>{if("drive.google.com"===t.hostname){if(getFirstElementBasedOnSelectors(state?.gmailCompressPDFConfig?.selectors?.pdfAttachmentIcon,e))return!0;return!(!getFirstElementBasedOnSelectors(state?.gmailCompressPDFConfig?.selectors?.genericAttachmentIcon,e)||!o.toLowerCase().endsWith(".pdf"))}return!("mail.google.com"!==t.hostname||!o.toLowerCase().endsWith(".pdf"))},getSanitizedPDFAttachmentName=e=>{if(!e)return"";const t=e.toLowerCase(),o=t.lastIndexOf(".pdf");if(-1!==o)return e.substring(0,o+4).trim();const s=t.lastIndexOf("(");return-1!==s?t.substring(0,s).trim():e.trim()},getPDFAttachmentSize=e=>{const t=e.match(/\(([^)]*)\)/);if(!t)return null;return t[1].replace(/[^\d,]/g,"")},getAllUnprocessedMessagesWithPDFAttachment=(e,t)=>{const o=state?.gmailCompressPDFConfig?.selectors?.[t]?.attachmentContainer,s=o.map(e=>`${e}:not([${ACROBAT_PROCESSED_ATTRIBUTE}="Y"])`),r=getElementsListBasedOnSelectors(s,e);return Array.isArray(r)&&0!==r.length?r.map(e=>{const o=state?.gmailCompressPDFConfig?.selectors?.[t]?.pdfAttachmentElement,s=getFirstElementBasedOnSelectors(o,e);if(!s)return null;let r=null;try{r=new URL(s.href)}catch{return sendErrorLog("GmailCompressPDFTouchPoint","Failed to get attachment URL - invalid href"),null}const n=getPDFAttachmentSize(s.innerText),a=getSanitizedPDFAttachmentName(s.innerText);if("file"===t&&null!==n)try{const e=Number(n);if(!Number.isNaN(e)&&e<state?.gmailCompressPDFConfig?.compressPDFSizeThreshold)return null}catch(e){return sendErrorLog("GmailCompressPDFTouchPoint","Failed to convert PDF attachment size to number"),null}return{message:e,url:r,name:a}}).filter(e=>e&&isValidPDFDocumentUrl({...e})):null},addTouchPointInComposeBoxPDFAttachment=(e,t)=>{const o=getAllUnprocessedMessagesWithPDFAttachment(e,t);Array.isArray(o)&&o.forEach(e=>{addTouchPointToMessageWithPDFAttachment(e,t)})},getAllComposeBoxes=()=>getElementListForSelectors(state?.gmailCompressPDFConfig?.selectors?.composeBox,document),addTouchPointToComposeBoxPDFAttachment=()=>{const e=getAllComposeBoxes();Array.isArray(e)&&e.forEach(e=>{addTouchPointInComposeBoxPDFAttachment(e,"file"),addTouchPointInComposeBoxPDFAttachment(e,"drive")})};export{addTouchPointToComposeBoxPDFAttachment};