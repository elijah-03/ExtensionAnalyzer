var storyUtils=window.storyUtils;var DownloadZipModule=(function(){return{zipCanceledByUser:false,dlBtnClassName:'ext_btn_dl_all',isMac:false,downloadZIP:function(files,prefixName,callback){var self=this;var zip=new JSZip();prefixName=prefixName||'Instagram';prefixName=storyUtils.filename.modify(prefixName);var modalBox=App.getModalBox();var xhrsStatus={aborted:false,};var rejectedLinks=[null,[],[],[]];var allCount=files.length;var progressBarInfo={allCount:allCount,successCount:0,rejectedCount:0,retrySuccessCount:0,retryRequestsCount:undefined,oneValuePercent:100 / allCount,lastSuccess:false,};var timeoutDefault=60000;var timeoutRetry=300000;var modalBoxCallbacks={enoughCallback:enoughCallback,};modalBoxCallbacks.cancelCallback=function(){self.zipCanceledByUser=true;xhrsStatus.aborted=true;};modalBox.showDownloadProcess(allCount,modalBoxCallbacks);function enoughCallback(){self.zipCanceledByUser=true;xhrsStatus.aborted=true;zipFiles();}
function nextAttempt(attemptNo){if(self.zipCanceledByUser){xhrsStatus.aborted=true;return;}
if(typeof rejectedLinks[attemptNo]=='undefined'){zipFiles();}
else if(rejectedLinks[attemptNo].length==0&&rejectedLinks[attemptNo+1]&&rejectedLinks[attemptNo+1].length){setTimeout(function(){nextAttempt(attemptNo+1);},(attemptNo+1)*1000);}
else if(rejectedLinks[attemptNo].length==0&&(!rejectedLinks[attemptNo+1]||!rejectedLinks[attemptNo+1].length)){zipFiles();}
else if
(rejectedLinks[attemptNo].length){var file=rejectedLinks[attemptNo].shift();JSZipUtils.getBinaryContent(file.url,function(err,data){if(err){if(rejectedLinks[attemptNo+1]){rejectedLinks[attemptNo+1].push(file);}}else{progressBarInfo.rejectedCount--;progressBarInfo.successCount++;progressBarInfo.retrySuccessCount++;progressBarInfo.lastSuccess=true;modalBox.updateDownloadZipProgressBar(progressBarInfo);zip.file(file.filename,data,{binary:true});}
setTimeout(function(){nextAttempt(attemptNo);},(attemptNo)*1000);},xhrsStatus,timeoutRetry);}
else{zipFiles();}}
function zipFiles(){zip.generateAsync({type:"blob"}).then(function(content){var date=new Date();var zipFileName=prefixName+'_'
+date.getFullYear()
+'_'+(date.getMonth()+1)
+'_'+date.getDate()
+'_'+date.getHours()
+'_'+date.getMinutes()
+'_'+date.getSeconds()
+'.zip';saveAs(content,zipFileName);modalBox.close();if(typeof callback=='function'){callback({success:1});}
storyUtils.sendMessage({action:'downloadZip',count:allCount,successCount:progressBarInfo.successCount});});}
App.customPromiseAll({data:files,asyncCount:12,},function(file,resolve,reject){if(self.zipCanceledByUser){xhrsStatus.aborted=true;return reject();}
JSZipUtils.getBinaryContent(file.url,function(err,data){if(err){progressBarInfo.rejectedCount++;rejectedLinks[1].push(file);resolve(file.filename);}else{progressBarInfo.successCount++;progressBarInfo.lastSuccess=true;modalBox.updateDownloadZipProgressBar(progressBarInfo);zip.file(file.filename,data,{binary:true});resolve(file.filename);}},xhrsStatus,timeoutDefault);}).thenOne(function(result){if(self.zipCanceledByUser){return;}
if(rejectedLinks[1].length){progressBarInfo.retryRequestsCount=rejectedLinks[1].length;progressBarInfo.text=chrome.i18n.getMessage('retry_requests');progressBarInfo.lastSuccess=false;modalBox.updateDownloadZipProgressBar(progressBarInfo);setTimeout(function(){nextAttempt(1);},1000);}else{zipFiles();}},function(result){if(!self.zipCanceledByUser){modalBox.showErrorBox(chrome.i18n.getMessage('errorZip'));if(typeof callback=='function'){callback({error:1});}}});},}})();var UploadModule=(function(){function readURL(input,callback){if(input.files&&input.files[0]){var reader=new FileReader();reader.onload=callback;reader.readAsDataURL(input.files[0]);}}
return{uploadId:undefined,size:null,showSettings:function(){var $uploadFromAnywhereOption=$('.upload_from_anywhere');$uploadFromAnywhereOption.find('.title').text(chrome.i18n.getMessage('upload_from_external_link'));function addListeners(){var $pushToggles=$uploadFromAnywhereOption.find('.push-toggle');$pushToggles.on('click',function(){if($uploadFromAnywhereOption.hasClass('active')){$uploadFromAnywhereOption.removeClass('active');chrome.storage.sync.set({upload_external:false});}
else{$uploadFromAnywhereOption.addClass('active');chrome.storage.sync.set({upload_external:true});}});var helpImgWrap;var $helpImageIcon=$('.img-icon');$helpImageIcon.on('mouseover',function(){helpImgWrap=document.createElement('div');var imgEl=document.createElement('img');imgEl.src='img/help_screen.jpg';helpImgWrap.className='help_image_wrap';helpImgWrap.appendChild(imgEl);$('#upload').append(helpImgWrap);});$helpImageIcon.on('mouseleave',function(){helpImgWrap.innerHTML='';helpImgWrap.remove();});$uploadFromAnywhereOption.data({event:'on'});}
chrome.storage.sync.get('upload_external',function(data){data.upload_external&&$uploadFromAnywhereOption.addClass('active');});$uploadFromAnywhereOption.data().event||addListeners();},leaveFromUploadClick:function(callback){if(document.querySelector('.upload_preview_wrap')){return App.getModalBox().showCloseUploadWarning({continueCallback:callback});}
callback();},requestExternalFile:function(url,callback){var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.responseType="arraybuffer";xhr.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){try{var resText=this.response||this.responseText;var blob=new Blob([resText],{type:'application/octet-stream'});var reader=new FileReader();reader.onload=callback;reader.readAsDataURL(blob);}catch(e){}}
else{}}};xhr.send();},getExternalUploadLink:function(callback){var self=this;chrome.runtime.sendMessage('get_external_link',function(externalLink){if(!externalLink)return;if(!self.isValidLink(externalLink))return;self.requestExternalFile(externalLink,function(e){UploadModule.uploadBtn.disable();var src=e.target.result;UploadModule.uploadPreviewBlock.create(src);});});},isValidLink:function(link){return!!link.match(/^https?:\/\/(www\.)?[^\.]+\.[^\.]+/);},uploadStateInit:function(){var container=document.querySelector('#upload');this.uploadBtn.create(container);this.form.create();this.showSettings()},stateReset:function(){this.uploadId=undefined;this.size=null;this.form.reset();this.uploadPreviewBlock.destroySelf();this.uploadBtn.uploadBtnEl&&this.uploadBtn.enable();},showSuccessMessage:function(){var $el=$('<div class="uploaded_successfull_msg">'+
chrome.i18n.getMessage('story_is_added')+'<div class="close_uploaded_successfull_msg">&times;</div>'+'</div>');$('#upload').append($el);function hideMessage(){$el.css('padding','1px').css('opacity','0');setTimeout(function(){$el.find('.close_uploaded_successfull_msg').off('click',hideMessage);$el.remove();},400);}
setTimeout(function(){$el.css('padding','20px').css('opacity','1');},400);setTimeout(hideMessage,5000);$el.find('.close_uploaded_successfull_msg').on('click',hideMessage);},uploadBtnOnClick:function(){if(this.uploadBtn.disabled){return;}
UploadModule.form.inputDispatchClick();},uploadBtn:{uploadBtnEl:null,disabled:false,create:function(){UploadModule.stateReset();var self=this;var uploadBtn=document.querySelector('.ext_upload_btn');uploadBtn.innerText=chrome.i18n.getMessage('upload_photo_to_stories');self.uploadBtnEl=uploadBtn;self.enable();},enable:function(){this.uploadBtnEl.style.display='inline-block';this.uploadBtnEl.dataset.disabled='0';this.disabled=false;},disable:function(){this.uploadBtnEl.style.display='none';this.uploadBtnEl.dataset.disabled='1';this.disabled=true;},},form:{formEl:null,inputEl:null,create:function(){var form=document.createElement('form'),input=document.createElement('input');form.id='ext_upload_form';form.setAttribute('enctype','multipart/form-data');input.id='ext_upload_input';input.setAttribute('type','file');input.setAttribute('name','photo');input.setAttribute('accept','image/jpeg');form.appendChild(input);document.querySelector('body').appendChild(form);input.addEventListener('change',this.onInputChange);this.formEl=form;this.inputEl=input;},reset:function(){this.formEl&&this.formEl.reset();},inputDispatchClick:function(){this.inputEl&&this.inputEl.click();},onInputChange:function(){readURL(this,function(e){var src=e.target.result;UploadModule.uploadPreviewBlock.create(src);});}},uploadRequest:{factory:function(type,data,cb){var self=this;self.sendPhoto(data,function(res){if(res.error){self.handleBadResponse(res);UploadModule.stateReset();cb();}
else{UploadModule.uploadId=res.upload_id;self.configurePhoto({caption:'',uploadId:UploadModule.uploadId,},function(res){if(!res.error){UploadModule.stateReset();UploadModule.showSuccessMessage();}
else{self.handleBadResponse(res);UploadModule.stateReset();}
cb();});}});},sendPhoto:function(blob,callback){storyUtils.sendMessage('getCookies',function(instagramCookies){if(!instagramCookies){return StoriesModule.requireAuthorize();}
var width=(UploadModule.size&&UploadModule.size.width)||1080;var height=(UploadModule.size&&UploadModule.size.height)||1080;var now=new Date().getTime();var url='https://www.instagram.com/rupload_igphoto/fb_uploader_'+now;var xhr=new XMLHttpRequest();xhr.open('POST',url,true);xhr.setRequestHeader('x-csrftoken',instagramCookies.csrftoken);xhr.setRequestHeader('x-entity-length',blob.size);xhr.setRequestHeader('x-entity-name','fb_uploader_'+now);xhr.setRequestHeader('x-ig-app-id','1217981644879628');xhr.setRequestHeader('x-instagram-rupload-params',JSON.stringify({media_type:1,upload_id:now,upload_media_height:height,upload_media_width:width}));xhr.setRequestHeader('offset',0);xhr.onload=function(){try{var res=JSON.parse(this.responseText);}catch(e){return callback({error:1,status:200});}
callback(res);};xhr.send(blob);});},configurePhoto:function(opts,callback){var caption=opts.caption;var uploadId=opts.uploadId;var userTags=opts.usertags;storyUtils.sendMessage('getCookies',function(cookies){if(!cookies||!cookies.sessionid){return callback({error:1});}
var data={upload_id:uploadId,caption:caption,};if(userTags){data.usertags=JSON.stringify({in:userTags});}
var url='https://www.instagram.com/create/configure_to_story/';$.ajax({url:url,method:'POST',data:data,headers:{'x-csrftoken':cookies.csrftoken,'x-ig-app-id':'1217981644879628',},}).done(function(res){if(!res||typeof res!='object'||res.status!='ok'){return callback({error:1,res:res,status:200});}
callback({success:1});}).fail(function(res){callback({error:1,res:res.responseJSON,status:res.status});});});},handleBadResponse:function(res){var errorUploadFileText=chrome.i18n.getMessage('upload_error');var possibleReasonsText=chrome.i18n.getMessage('error403_possible_reasons');var reason1Text=chrome.i18n.getMessage('error403_reason_1');var reason2Text=chrome.i18n.getMessage('error403_reason_2');var errorNetworkText=chrome.i18n.getMessage('error_network');var checkNetworkText=chrome.i18n.getMessage('check_network');var xzReasonText=chrome.i18n.getMessage('error_reason_xz');var errorText;if(res.status=='403'){errorText='<h3 style="margin-bottom:15px;font-weight:600;">'+errorUploadFileText+'</h3>'+'<p style="margin-bottom:10px;">'+possibleReasonsText+':</p>'+'<ol style="text-align: justify; list-style: decimal;padding: 10px;margin-left: 10px;font-size: 0.8em;">'+'<li style="margin-bottom:15px">'+reason1Text+'</li>'+'<li style="margin-bottom:15px">'+reason2Text+'</li>'+'</ol>';}
else if(res.status=='0'&&typeof res.res=='undefined'){errorText='<h3 style="margin-bottom: 15px;font-weight: 600;">'+errorNetworkText+'</h3>'+'<p>'+checkNetworkText+'</p>';}
else{errorText='<h3 style="margin-bottom: 15px;font-weight: 600;">'+errorUploadFileText+'</h3>'+'<p>'+xzReasonText+'</p>';}
var modalBox=App.getModalBox();modalBox.showErrorBox(errorText);}},uploadPreviewBlock:{btnNextLastClickTime:0,croppieObj:null,imgSrc:null,width:null,height:null,currentTransformation:null,currentSize:{},currentRotate:0,container:null,create:function(src){var self=this;UploadModule.uploadBtn.disable();var container=document.querySelector('#upload');var el=document.createElement('div');el.className='upload_preview_wrap';self.container=el;var nextText=chrome.i18n.getMessage('add');var newStoryText=chrome.i18n.getMessage('new_story');var cancelText=chrome.i18n.getMessage('btn_cancel');el.innerHTML='<div class="upload_preview_header">'+'<button class="cancel">'+cancelText+'</button>'+'<span class="text">'+newStoryText+'</span>'+'<button class="next">'+nextText+'</button>'+'</div>'+'<div class="upload_content">'+'<div class="upload_preview_img">'+'<div class="rotate_btn"></div>'+'</div>'+'<div class="uploaded_image_preview"></div>'+'<img id="img_hidden">'+'</div>';container.appendChild(el);var btnCancel=el.querySelector('.cancel');var btnNext=el.querySelector('.next');var btnRotate=el.querySelector('.rotate_btn');var imgDiv=el.querySelector('.upload_preview_img');var imgHidden=el.querySelector('#img_hidden');self.imgDiv=imgDiv;btnCancel.addEventListener('click',self.onCancelBtnClick);btnNext.addEventListener('click',self.onFirstNextClick.bind(self));this.imgSrc=src;imgHidden.onload=function(){imgDiv.style.display='block';self.width=imgHidden.naturalWidth;self.height=imgHidden.naturalHeight;btnRotate.addEventListener('click',self.rotateImage.bind(self));self.rectangleStoryTransformation();el.style.display='block';};imgHidden.src=src;},onCancelBtnClick:function(){UploadModule.stateReset();},destroySelf:function(){$('.upload_preview_wrap').remove();},createCroppieObj:function(viewport,points,needInitRotate){var imgDiv=document.querySelector('.upload_preview_img');var self=this;self.croppieObj=new Croppie(imgDiv,{viewport:viewport,boundary:{width:400,height:400},enableZoom:true,enableOrientation:true,showZoomer:true,update:function(obj){self.currentSize.width=obj.points[2]-obj.points[0];self.currentSize.height=obj.points[3]-obj.points[1];},});var bindObj={url:self.imgSrc,points:points,};if(needInitRotate){bindObj.orientation=6;}
self.croppieObj.bind(bindObj);},destroyCroppieObj:function(){if(this.croppieObj){this.croppieObj.destroy();this.croppieObj=null;}},rectangleStoryTransformation:function(){var self=this;self.destroyCroppieObj();self.currentTransformation='rectangle_vertical';var width=self.width,height=self.height;var needInitRotate=false;if(width>height){needInitRotate=true;self.width=height;self.height=width;width=self.width;height=self.height;}
var ratioHW=height / width;var minRatioHW=1.77;var maxRatioHW=1.78;var left,top,right,bottom;var middlePoint;var visibleWidth;var visibleHeight;var viewport={height:350,width:350 / ratioHW};top=0;left=0;bottom=height;right=width;if(ratioHW>=maxRatioHW){visibleHeight=width*maxRatioHW;middlePoint=height / 2;top=middlePoint-(visibleHeight / 2);bottom=top+visibleHeight;viewport.width=350 / maxRatioHW;}
if(ratioHW<=minRatioHW){visibleWidth=height / minRatioHW;middlePoint=width / 2;left=middlePoint-(visibleWidth / 2);right=left+visibleWidth;viewport.width=350 / minRatioHW;}
var points=[left,top,right,bottom];self.createCroppieObj(viewport,points,needInitRotate);},rotateImage:function(){this.croppieObj&&this.croppieObj.rotate(90);},getOptimalSize:function(){var currentSize=this.currentSize;if(!currentSize.width||!currentSize.height){return null;}
var koef;var needWidth=1080;koef=currentSize.width / needWidth;return{width:needWidth,height:Math.floor(currentSize.height / koef)};},getBlobPreview:function(callback){if(!this.croppieObj){callback()}
var size=this.getOptimalSize();var options={type:'blob',format:'jpeg',size:'original'};if(size){options.size=size;}
this.croppieObj.result(options).then(callback);},showLoader:function(btnNext){if(!btnNext)return;btnNext.innerText='';btnNext.classList.add('loader');},hideLoader:function(btnNext){btnNext&&btnNext.classList.remove('loader');},onFirstNextClick:function(){var now=Date.now();if(now<this.btnNextLastClickTime+500){return;}
var self=this;self.btnNextLastClickTime=now;var btnNext=document.querySelector('.next');self.showLoader(btnNext);self.getBlobPreview(function(blob){UploadModule.uploadRequest.factory('photo',blob,function(){self.hideLoader();});});},},}})();var StoriesModule=(function(){return{dlBtnClassName:'ext_stories_dl_btn',showingStoryItems:[],gallery:null,lastTimeLiveStoriesUpdate:0,liveStoriesUpdatePeriod:60*1000,downloadJoinedPostLiveAllowed:false,defaultNavItem:'friends',currentNavItem:null,needSmartScreenWarn:false,showingAuthor:null,prepareLiveStory:function(storyObj){var storyItems=[];try{if(storyObj.broadcasts){storyObj.broadcasts.forEach(function(broadcast){try{storyItems.push({story_type:'post_live',dash_manifest:broadcast.dash_manifest,html:'<div class="video_post_live_removed">'+chrome.i18n.getMessage('post_live_removed')+'</div>'+'<div class="video_post_live_preparing"></div>'+'<video class="ext_video_story_player" controls></video>',user_pk:broadcast.broadcast_owner.pk,username:broadcast.broadcast_owner.username,userPic:broadcast.broadcast_owner.profile_pic_url});}catch(e){}})}else{var playbackUrl=storyObj.dash_playback_url||storyObj.dash_abr_playback_url||storyObj.dash_live_predictive_playback_url;if(!playbackUrl)return null;var mediaId=playbackUrl.match(/(\d+)\.mpd/);mediaId=mediaId?mediaId[1]:storyObj.id;try{storyItems.push({story_type:'live',media_id:mediaId,playback_url:playbackUrl,user_pk:storyObj.broadcast_owner.pk,username:storyObj.broadcast_owner.username,userPic:storyObj.broadcast_owner.profile_pic_url,poster:storyObj.cover_frame_url,viewer_count:parseInt(storyObj.viewer_count),});}catch(e){}}}catch(e){}
return storyItems;},prepareIgtv2SavedLive:function(broadcasts){var storyItems=[];broadcasts.forEach(function(broadcast){try{var itemMedia={filename:storyUtils.getIgtvFileName(broadcast),story_type:'post_live_igtv',html:`<video class="ext_video_story_player" controls><source src="${broadcast.url}" type="video/mp4"></video>`,user_pk:broadcast.owner.pk,username:broadcast.owner.username,userPic:broadcast.owner.profile_pic_url,url:broadcast.url,};storyItems.push(itemMedia);}catch(e){}});return storyItems;},prepareStoryItems:function(items){var storyItems=[];items.forEach(function(item){try{var src=null;var maxWidth=0;var maxHeight=0;var minWidth=undefined,prev=undefined,ext;var isVideo=typeof item.video_versions!='undefined';if(isVideo){item.video_versions.forEach(function(item){if(item.width>maxWidth){maxWidth=item.width;maxHeight=item.height;src=item.url;}});item.image_versions2.candidates.forEach(function(item){if(!minWidth||item.width<minWidth){minWidth=item.width;prev=item.url;}});ext='mp4';if(src.indexOf('.flv')!==-1){ext='flv';}}else{item.image_versions2.candidates.forEach(function(item){if(item.width>maxWidth){maxWidth=item.width;maxHeight=item.height;src=item.url;}
if(typeof minWidth=='undefined'){minWidth=item.width;prev=item.url;}else if(!minWidth||item.width<minWidth){minWidth=item.width;prev=item.url;}});ext='jpg';if(src.indexOf('.png')!==-1){ext='png';}}
var filename=src.match(/\/([^\/?]+)(?:$|\?)/);filename=filename&&filename[1];if(!filename){filename='noname.'+ext;}
var userName=item.user.username||'';if(userName.length){filename=`${userName}_${filename}`}
filename=storyUtils.filename.modify(filename);var itemMedia={w:maxWidth,h:maxHeight,isVideo:isVideo,type:isVideo?'video':'photo',url:src,prev:prev,filename:filename,story_type:'tray',username:userName,userPic:item.user.profile_pic_url,locations:item.story_locations,hashtags:item.story_hashtags};isVideo?itemMedia.html='<video class="ext_video_story_player" controls><source src="'+src+'" type="video/mp4"> </video>':itemMedia.src=src;storyItems.push(itemMedia);}catch(e){}});return storyItems;},getPswp:function(){var pswpElement=document.querySelector('.insta_down');if(pswpElement){return pswpElement;}
return $(`<div class="pswp insta_down" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="pswp__bg"></div>
      <div class="pswp__scroll-wrap"> 
       <div class="pswp__container"> 
        <div class="pswp__item"></div> 
        <div class="pswp__item"></div> 
        <div class="pswp__item"></div> 
       </div> 
       <div class="pswp__ui pswp__ui--hidden pswp__ctrls-wrap"> 
        <div class="pswp__top-bar"> 
         <div class="pswp__counter"></div>
         <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
         <div class="dl_btns_container"> 
          <a type="button" class="${StoriesModule.dlBtnClassName} ext_ds_dl_btn ext_story__download" title="${chrome.i18n.getMessage("download")}">
           <span class="ext_icon"></span><span class="ext_text">${chrome.i18n.getMessage("download")}</span>
          </a> 
          <a type="button" class="${StoriesModule.dlBtnClassName} ext_ds_dl_all_btn ext_story__download_all" title="${chrome.i18n.getMessage("download_all")}">
           <span class="ext_icon"></span><span class="ext_text">${chrome.i18n.getMessage("download_all")}</span>
          </a> 
         </div>
         <div class="pswp__preloader"> 
          <div class="pswp__preloader__icn"> 
           <div class="pswp__preloader__cut"> 
            <div class="pswp__preloader__donut"></div> 
           </div> 
          </div> 
         </div> 
        </div> 
        <div class="story_author_wrap"> 
         <div class="story_author_wrap_2"> 
          <a target="_blank" class="author_link"> 
           <img src="" class="story_author_icon"> 
          </a>
          <div class="story_author_name"></div> 
         </div> 
        </div> 
        <div class="ext_story_privacy_msg_in_view">
         <div class="ext_story_privacy_icon"><img src="${chrome.runtime.getURL('img/eye_crossed_out_white.png')}"></div>
        </div>
        <div class="story_location_hashtags_wrap"></div>
        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> 
        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button> 
        <div class="pswp__caption"> 
         <div class="pswp__caption__center"></div> 
        </div> 
       </div> 
      </div>
     </div>`).appendTo(document.body).get(0);},stopAllVideos:function(){document.querySelectorAll('video').forEach(function(video){video.pause();});this.DashJsPlayer.destroy();},showInPswp:function(items){try{var self=this;if(!items||!items.length){return;}
var pswpElement,gallery,htmlPlayerElement,showingStoryType,downloadAllBtn;var setAuthorStory=function(story){var storyAuthorWrap=pswpElement.querySelector('.story_author_wrap');if(!story){return storyAuthorWrap.style.display='none';}
storyAuthorWrap.querySelector('.author_link').href='https://www.instagram.com/'+story.username;storyAuthorWrap.querySelector('.story_author_icon').src=story.userPic;storyAuthorWrap.querySelector('.story_author_name').innerText=story.username;storyAuthorWrap.style.display='block';};var setLocationAndTagsStory=function(story){var $parent=$('.story_location_hashtags_wrap');$parent.html('');if(story.locations&&story.locations.length){story.locations.forEach(function(item){$('<div class="story_location_item" data-id="'+item.location.pk+'">'+'<div class="icon"></div>'+'<div class="name">'+item.location.name+'</div>'+'</div>').appendTo($parent);});}
if(story.hashtags&&story.hashtags.length){story.hashtags.forEach(function(item){$('<div class="story_hashtag_item" data-tag="'+item.hashtag.name+'">'+'<div class="icon"></div>'+'<div class="name">'+item.hashtag.name+'</div>'+'</div>').appendTo($parent);});}};self.showingStoryItems=items;showingStoryType=items[0].story_type;pswpElement=self.getPswp();var options={index:0,closeOnScroll:false,history:false,focus:true,bgOpacity:0.96,escKey:true,};gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);self.gallery=gallery;tippy('.ext_story_privacy_msg_in_view',{content:chrome.i18n.getMessage('privacy_watching_msg')});downloadAllBtn=pswpElement.querySelector('.ext_ds_dl_all_btn');if(showingStoryType=='post_live'){$('.ext_ds_dl_btn').addClass('ext_post_live');downloadAllBtn.style.display='none';}
else if(showingStoryType=='post_live_igtv'){downloadAllBtn.style.display='none';}
else{downloadAllBtn.style.display=self.showingStoryItems.length>1?'block':'none';}
gallery.listen('afterChange',function(){if(!this.currItem.container){return;}
setAuthorStory(this.currItem);$('.ext_ds_dl_btn').show();if(this.currItem.isVideo||showingStoryType=='post_live'||showingStoryType=='post_live_igtv'){$(".video_post_live_preparing").show();htmlPlayerElement=this.currItem.container.querySelector(".ext_video_story_player");htmlPlayerElement.currentTime=0;if(showingStoryType=='post_live'){self.DashJsPlayer.create(this.currItem,htmlPlayerElement,function(){$('.ext_ds_dl_btn').hide();htmlPlayerElement.pause();$('.video_post_live_removed').show();self.DashJsPlayer.destroy();});}
else{htmlPlayerElement.play();}}});gallery.listen('beforeChange',function(){self.stopAllVideos();$('.video_post_live_removed').hide();});gallery.listen('close',function(){self.stopAllVideos();self.showingStoryItems=[];});gallery.listen('destroy',function(){self.gallery=null;pswpElement.remove();});gallery.init();}catch(e){Math.random()<0.01&&storyUtils.trackCodeError(e,'showInPswp');}},DashJsPlayer:{instance:null,create:function(videoData,htmlPlayerElement,failCallback){var self=this;try{self.instance=dashjs.MediaPlayer().create();}catch(e){Math.random()<0.01&&storyUtils.trackCodeError(e,'DashJsPlayer.create() 1');return typeof failCallback=='function'&&failCallback();}
if(videoData.story_type=='post_live'){var manifest=videoData.dash_manifest;try{var xmlO=$.parseXML(manifest);var $xml=$(xmlO);var videoNode=$xml.find('Representation[mimeType="video/mp4"]');var videoUrl=storyUtils.getMaxResolutionsUrl(videoNode);}catch(e){}
if(!videoUrl){return typeof failCallback=='function'&&failCallback();}
$.ajax({method:'HEAD',url:videoUrl,}).done(function(){if(!self.instance)return;self.instance.initialize(htmlPlayerElement);self.instance.on('error',function(e){if(e.error==='download'){typeof failCallback=='function'&&failCallback();}});var XlinkController=dashjs.FactoryMaker.getClassFactoryByName('XlinkController');var DashParser=dashjs.FactoryMaker.getClassFactoryByName('DashParser');var xlink=XlinkController().create({});var parser=DashParser().create({});var mpd=parser.parse(manifest,xlink);mpd.loadedTime=new Date();xlink.resolveManifestOnLoad(mpd);self.instance.attachSource(mpd);self.afterInitialized();}).fail(function(){typeof failCallback=='function'&&failCallback();});}
else{try{var url=videoData.playback_url;self.instance.initialize(htmlPlayerElement,url,true);self.afterInitialized();}catch(e){typeof failCallback=='function'&&failCallback();Math.random()<0.01&&storyUtils.trackCodeError(e,'DashJsPlayer.create() 3');}}},afterInitialized:function(){this.instance.getDebug().setLogToBrowserConsole(false);this.instance.setStableBufferTime(2);this.instance.setFragmentLoaderRetryAttempts(3);$(".video_post_live_preparing").hide();this.instance.play();},destroy:function(){if(this.instance){try{this.instance.pause();this.instance.reset();}catch(e){}
this.instance=null;}},},liveBox:{successCommentSent:false,commentProblemReported:false,createHtml:function(){return $(`<div class="insta-live-wrapper">
     <div class="iw-bg"></div>
     <div class="ext_story_privacy_msg_in_view">
      <div class="ext_story_privacy_icon"><img src="${chrome.runtime.getURL('img/eye_crossed_out_white.png')}"></div>
     </div>
     <div class="iw-holder">
      <a class="iw-close" href='#'></a>
      <a class="iw-toggle-comments" href='#'></a>
      <div class="iw-content">
       <video preload="auto" controls autoplay></video>
      </div>
      <div class="iw-comments">
       <div class="iw-header">
        <span class="iw-logo" role="link" tabindex="0" style="width: 32px; height: 32px;">
         <img src="">
        </span>
        <div class="iw-username"></div>
        <div class="iw-status">${chrome.i18n.getMessage('just_live')}</div>
        <div class="iw-look">
         <span class="iw-icon"></span>
         <span class="iw-count"></span>
        </div>
       </div>
       <div class="iw-body"></div>
       <div class="iw-footer">
        <div class="iw-pinned-comment"></div>
        <div class="input_wrap">
         <input type="text" placeholder="${chrome.i18n.getMessage('add_comment')}">
        </div>
       </div>
      </div>
     </div></div>`);},showBroadcastFinishedMessage:function($html){$('.iw-content',$html).append(`<div class="broadcast_finished">${chrome.i18n.getMessage('broadcast_finished')}</div>`);},setAuthor:function(data,$html){$('.iw-username',$html).text(data.username);$('.iw-logo img',$html).attr('src',data.userPic);},setViewerCount:function(count,$html){$('.iw-count',$html).text(count);},hideComments:function(liveComments){window.localStorage.comments_hided='1';$('.iw-toggle-comments').text(chrome.i18n.getMessage('show_comments'));document.querySelector('.iw-content').insertBefore(document.querySelector('.iw-header'),document.querySelector('.iw-content video'));$('.iw-comments').hide();$('.iw-holder').css({width:'30vw'});liveComments.stop();},showComments:function(liveComments){window.localStorage.comments_hided='0';$('.iw-toggle-comments').text(chrome.i18n.getMessage('hide_comments'));document.querySelector('.iw-comments').insertBefore(document.querySelector('.iw-header'),document.querySelector('.iw-comments .iw-body'));$('.iw-comments').show();$('.iw-holder').css({width:'80vw'});liveComments.start();},show:function(liveData){var self=this;var $html=self.createHtml();var liveComments,liveInfo;self.setAuthor(liveData,$html);self.setViewerCount(liveData.viewer_count,$html);$html.appendTo(document.body);var videoEl=$('video',$html).get(0);$('.page_wrap').hide();var enterTapListener=function(e){if(e.keyCode!=13&&e.key!="Enter")return;var $input=$('.input_wrap input');if(!$input.is(":focus"))return;var text=$input.val();if(!text.length)return;$input.val('');self.sendCommentToLive({broadcast_id:liveData.media_id,text:text,},function(){liveComments.force();});};function stopBroadcastProcesses(){videoEl.pause();StoriesModule.DashJsPlayer.destroy();if(liveInfo){liveInfo.stop();}
if(liveComments){liveComments.stop();}
window.removeEventListener('keypress',enterTapListener);}
function liveVideoEnded(){stopBroadcastProcesses();self.commentInputHide();self.showBroadcastFinishedMessage();$('.iw-status').hide();$('.iw-look').hide();StoriesModule.friendsPage.removeEndedLive(liveData.media_id);}
var closeBox=function(){stopBroadcastProcesses();$('.insta-live-wrapper').remove();$('.page_wrap').show();window.onkeyup=null;};StoriesModule.DashJsPlayer.create(liveData,videoEl,function(){});$('.iw-close',$html).on('click',function(e){e.preventDefault();e.stopPropagation();closeBox();});$('.iw-bg',$html).on('click',function(e){e.preventDefault();e.stopPropagation();closeBox();});$('.iw-logo',$html).on('click',function(e){e.preventDefault();e.stopPropagation();App.openTab('https://instagram.com/'+liveData.username+'/');});$('.iw-toggle-comments').on('click',function(){if(window.localStorage.comments_hided=='1'){self.showComments(liveComments);}
else{self.hideComments(liveComments);}});liveComments=self.getLiveComments(liveData.media_id,$html,liveVideoEnded);liveInfo=self.getLiveInfo(liveData.media_id,function(count){self.setViewerCount(count,$html);},liveVideoEnded);window.localStorage.comments_hided=window.localStorage.comments_hided||'0';if(window.localStorage.comments_hided==='1'){self.hideComments(liveComments);}
else{self.showComments(liveComments);}
tippy('.ext_story_privacy_msg_in_view',{content:chrome.i18n.getMessage('privacy_watching_msg')});window.addEventListener('keypress',enterTapListener);window.onkeyup=function(e){if(e.key==="Escape"){closeBox();}};},getLiveComments:function(mediaId,$html,liveFinishedCallback){var baseUrl='https://i.instagram.com/api/v1/live/'+mediaId+'/get_comment/';var commentsUrl=baseUrl;var lastCommentTs;var needStop=false;var requestTimeout=3000;var failsCount=0;var chatBoxElement=$('.iw-comments .iw-body',$html).get(0);var self=this;var commentsMuted=false;function request(force,callback){if(needStop){return;}
$.ajax({method:'GET',url:commentsUrl,dataType:'json'}).done(function(res){failsCount=0;if(handleCommentResponse(res)&&!force){setTimeout(request,requestTimeout);}
if(typeof callback=='function')callback();}).fail(function(){if(force)return;failsCount++;if(failsCount<4){setTimeout(function(){request();},1000);return;}
if(typeof liveFinishedCallback=='function'){liveFinishedCallback();}});}
function handleCommentResponse(res){try{if(!res||typeof res!='object'||res.status!='ok'){return failsCount<=4;}
if(res.comment_muted==1){if(!commentsMuted){commentsMuted=true;self.commentsMutedShow();requestTimeout=120000;}
return true;}
if(commentsMuted){self.commentsMutedHide();commentsMuted=false;requestTimeout=3000;}
self.addPinnedComment(res.pinned_comment);storyUtils.objectSortByProp(res.comments,'created_at');res.comments.forEach(function(comment){self.addComment(comment,chatBoxElement);lastCommentTs=parseInt(comment.created_at);});if(!lastCommentTs||isNaN(lastCommentTs)){return true;}
commentsUrl=baseUrl+'?last_comment_ts='+lastCommentTs;self.removeOldComments();return true;}catch(e){}}
return{stop:function(){needStop=true;},start:function(){needStop=false;request();},force:function(callback){request(true,callback);},};},getLiveInfo:function(mediaId,updateCallback,liveFinishedCallback){var infoUrl='https://i.instagram.com/api/v1/live/'+mediaId+'/info/';var failsCount=0;var requestTimeout=10000;var needStop=false;function request(){if(needStop){return;}
$.ajax({method:'GET',url:infoUrl,dataType:'json'}).done(function(res){failsCount=0;if(handleInfoResponse(res)){setTimeout(request,requestTimeout);}}).fail(function(res){var resJson=res.responseJSON;failsCount++;if(failsCount<5){setTimeout(function(){request();},1000);}else{if(res.status==400&&resJson&&resJson.message!='login_required'&&typeof liveFinishedCallback=='function'){liveFinishedCallback();}}});}
function handleInfoResponse(res){if(!res||typeof res!='object'||res.status!='ok'){return failsCount<=4;}
if(res.broadcast_status=='post_live')return liveFinishedCallback();var viewerCount=res.viewer_count;if(isNaN(viewerCount))viewerCount=0;updateCallback(viewerCount);return true;}
request();return{stop:function(){needStop=true;}};},addComment:function(comment,chatBoxElement){try{if(chatBoxElement.querySelector(`.one_comment_wrap[data-pk="${comment.pk}"]`)){return;}
var href='https://www.instagram.com/'+comment.user.username;$(`
       <div class="one_comment_wrap" data-pk="${comment.pk}">
       <a class="author_link" target="_blank" href="${href}">
        <img class="comment_author_icon" src="${comment.user.profile_pic_url}">
       </a>
       <div class="comment_text_wrap">
        <span class="comment_author_name">${comment.user.username}</span>
        <span class="live_comment_text">${comment.text}</span>
       </div>
       </div>
       `).appendTo(chatBoxElement);var prevScrollHeigth=chatBoxElement.scrollHeight;if(prevScrollHeigth<(chatBoxElement.scrollTop+chatBoxElement.clientHeight+50)){$(chatBoxElement).animate({scrollTop:chatBoxElement.scrollHeight},800);}}catch(e){Math.random()<0.01&&storyUtils.trackCodeError(e,'addComment');}},removeOldComments:function(){var $comments=$('.one_comment_wrap','.iw-body');if($comments.length>200){$comments.slice(0,$comments.length-200).remove();}},commentsMutedShow:function(){$(`<div class="iw_comments_muted">${chrome.i18n.getMessage('comment_muted')}</div>`).appendTo(document.querySelector('.iw-comments'));this.commentInputHide();},commentsMutedHide:function(){$('.iw_comments_muted').remove();this.commentInputShow()},commentInputShow:function(){$('.input_wrap').show();},commentInputHide:function(){$('.input_wrap').hide();},addPinnedComment:function(comment){var $container=$('.iw-pinned-comment');if(!comment){if($container.length){$container.html('');$container.removeData('created_at');$container.hide();$('.iw-body').removeClass('with_pinned')}
return;}
if($container.data().created_at==comment.created_at)return;if(comment.content_type!='comment')return;var href='https://www.instagram.com/'+comment.user.username;$container.html(`<div class="one_comment_wrap">
        <a class="author_link" target="_blank" href="${href}">
         <img class="comment_author_icon" src="${comment.user.profile_pic_url}">
        </a>
        <div class="comment_text_wrap">
         <div>
          <span class="comment_author_name">${comment.user.username}</span>
          <span class="comment_pinned_word">&nbsp;Â·&nbsp;${chrome.i18n.getMessage('pinned')}</span>
         </div>
         <span class="live_comment_text">${comment.text}</span>
        </div>
       </div>`).show().data({created_at:comment.created_at});$('.iw-body').addClass('with_pinned');},sendCommentToLive:function(opts,callback){var self=this;storyUtils.sendMessage('getCookies',function(instagramCookies){if(!instagramCookies){return StoriesModule.requireAuthorize();}
$.ajax({method:'POST',url:'https://i.instagram.com/api/v1/live/'+opts.broadcast_id+'/comment/',headers:{'x-csrftoken':instagramCookies.csrftoken,'x-ig-app-id':'936619743392459',},data:{comment_text:opts.text,}}).done(function(){self.successCommentSent=true;typeof callback=='function'&&callback(true);}).fail(function(res){if(!self.successCommentSent&&!self.commentProblemReported){self.commentProblemReported=true;storyUtils.trackEvent("error_sending_comment",{status:res.status,data:res.responseJSON||res.responseText,ua:window.navigator.userAgent,});}
typeof callback=='function'&&callback(false);})});},},storiesPause:{isPausedByAs:false,getCurrentVideoPlayer:function(){if(!StoriesModule.gallery||!StoriesModule.gallery.currItem||!StoriesModule.gallery.currItem.container){return null;}
return StoriesModule.gallery.currItem.container.querySelector(".ext_video_story_player");},playStories:function(){this.isPausedByAs=false;var videoPlayer=this.getCurrentVideoPlayer();if(videoPlayer&&videoPlayer.paused){videoPlayer.play();}},on:function(){var videoPlayer=this.getCurrentVideoPlayer();if(videoPlayer&&!videoPlayer.paused){videoPlayer.pause();this.isPausedByAs=true;}},off:function(){if(!this.isPausedByAs)return;this.isPausedByAs=false;var videoPlayer=this.getCurrentVideoPlayer();if(videoPlayer&&videoPlayer.paused){videoPlayer.play();}}},onClickDlBtnOurStoryOne:function(e){var storyMediaItem=StoriesModule.gallery.currItem;var el=this;var filename=storyMediaItem.filename;StoriesModule.storiesPause.on();filename=storyUtils.filename.modify(filename);storyUtils.downloadFile({url:storyMediaItem.url,filename:filename,isStory:true,},function(){});},onClickDlBtnOurStoryAll:function(e){DownloadZipModule.zipCanceledByUser=false;StoriesModule.storiesPause.on();DownloadZipModule.downloadZIP(StoriesModule.showingStoryItems.slice(0),StoriesModule.showingAuthor,function(res){if(res&&res.error){StoriesModule.storiesPause.off();}},true);},requestOneUserAllTypesStories:function(options,callback){storyUtils.sendMessage({action:'requestOneUserAllTypesStories',options:options},function(res){callback(res);});},buildStoriesPage:function(){window.localStorage.tryNoDlLiveStory=window.localStorage.tryNoDlLiveStory||0;document.querySelector('.title_text').innerHTML=chrome.i18n.getMessage('extTitle');document.head.querySelector('title').innerText=chrome.i18n.getMessage('extName');StoriesModule.darkModeInit();storyUtils.sendMessage('getPopupRate',StoriesModule.showPopupRate);StoriesModule.showMenuItems();StoriesModule.arrowUpObj.init();StoriesModule.isMac=App.isMacOs();var currentNavName=window.location.hash.replace(/#/,'')||StoriesModule.defaultNavItem;if(['friends','locations','search','upload','upload_from_external'].indexOf(currentNavName)==-1){currentNavName=App.defaultNavItem;}
StoriesModule.navigate(currentNavName);StoriesModule.addUserListeners();StoriesModule.addMessagesListener();$('.page_wrap').show();},addMessagesListener:function(){chrome.runtime.onMessage.addListener(function(message,sender,cb){if(!message){return false;}
else if(message=='storyPauseOffByDownloadId'){StoriesModule.storiesPause.off();}
else if(message.action=='storyPauseOffByBlobUrl'){StoriesModule.storiesPause.off();}
else if(message.action=='postLiveLoaderDownloadStarted'){}
else if(message.action=='postLiveLoaderDownloadFinished'){}});},showMenuItems:function(){$('.nav_item','#nav').each(function(){$(this).find('.text').text(chrome.i18n.getMessage('stories_page_'+this.dataset.nav_name));});},showPopupRate:function(res){if(res){return;}
var starClicked=false;var storeReviewPageOpened=false;var rateEl=document.querySelector('#rating-ask');rateEl.style.display='flex';var allStars=rateEl.querySelectorAll('#rating-ask .stars a');var ratingAskText=rateEl.querySelector('.ext_text');var over=false;if(allStars&&allStars.forEach){allStars.forEach(function(el){el.querySelector('.empty').style.display='inline';el.querySelector('.filled').style.display='none';});}else{return;}
ratingAskText.innerText=chrome.i18n.getMessage('rate_us_popup');function onOver(e){over=true;var pos=this.dataset.pos;allStars.forEach(function(el){if(el.dataset.pos<=pos){el.querySelector('.empty').style.display='none';el.querySelector('.filled').style.display='inline';}else{el.querySelector('.empty').style.display='inline';el.querySelector('.filled').style.display='none';}})}
function onOut(e){if(starClicked){return;}
over=false;setTimeout(function(){if(over){return;}
allStars.forEach(function(el){el.querySelector('.empty').style.display='inline';el.querySelector('.filled').style.display='none';})},100);}
function onClick(e){starClicked=true;var pos=this.dataset.pos;allStars.forEach(function(el){if(el.dataset.pos<=pos){el.querySelector('.empty').style.display='none';el.querySelector('.filled').style.display='inline';}});allStars.forEach(function(el){el.removeEventListener('mouseover',onOver);el.removeEventListener('mouseout',onOut);el.removeEventListener('click',onClick);});ratingAskText.innerText=chrome.i18n.getMessage('your_rate');storyUtils.sendMessage({action:'setPopupRate',value:pos});if(pos>3&&!storeReviewPageOpened){storeReviewPageOpened=true;chrome.tabs.create({url:'https://chrome.google.com/webstore/detail/'+chrome.runtime.id+'/reviews'});}
StoriesModule.trackEvent('user_popup_rate',{value:pos});}
allStars.forEach(function(el){el.addEventListener('mouseover',onOver);el.addEventListener('mouseout',onOut);el.addEventListener('click',onClick);});$('.feedback_wrap').show();},trackEvent:function(event,details){var send={action:'trackEvent',event:event};if(typeof(details)!=='undefined'){send.details=JSON.stringify(details);}
storyUtils.sendMessage(send);},addUserListeners:function(){var self=this;var lastButtonClick=0;var isRepeatClick=function(e){var now=Date.now();e.stopPropagation();e.preventDefault();if(lastButtonClick+1000>now){return true;}
lastButtonClick=now;return false;};var $body=$('body');$body.on('click','#nav .nav_item',function(e){if(isRepeatClick(e))return;var navName=this.dataset.nav_name;this.parentNode.childNodes.forEach(function(item,i){if(item.classList!==undefined){item.classList.remove('active');}});this.classList.add('active');if(StoriesModule.currentNavItem=='upload'){return UploadModule.leaveFromUploadClick(function(){StoriesModule.navigate(navName);});}
StoriesModule.navigate(navName);});var lastKeyPressId=null;$body.on('keydown','input[name="name_filter_input"]',function(e){var input=this;setTimeout(function(){var rand=Math.random();lastKeyPressId=rand;setTimeout(function(){if(rand!=lastKeyPressId)return;var userFilterVal=input.value.toLowerCase();var containerId='#'+self.currentNavItem;var $items=$('.story_item',containerId);if(self.currentNavItem=='friends'){var parentClassList={friends_lives:0,friends_post_lives:0,friends_stories:0,};var parentClass;}
$items.each(function(i,item){var $item=$(item);if(item.dataset.filter&&item.dataset.filter.toLowerCase().indexOf(userFilterVal)>-1){if(self.currentNavItem=='friends'){parentClass=item.parentNode.parentNode.className;typeof parentClassList[parentClass]!='undefined'&&parentClassList[parentClass]++;}
$item.show();}
else{$item.hide();}});if(self.currentNavItem=='friends'){for(var n in parentClassList){if(parentClassList[n]>0){$('.'+n,containerId).show();}
else{$('.'+n,containerId).hide();}}}},200)},100);});$body.on('click','#search_users, #search_tags, #search_places',function(e){if(isRepeatClick(e))return;this.parentNode.childNodes.forEach(function(item,i){if(item.classList!==undefined){item.classList.remove('active');}});this.classList.add('active');var whereSearch=this.id.replace(/search_/,'');self.searchPage.searchStart(whereSearch);});$body.on('click',['.line_story_item_image_wrap','.tile_story_item_header .user_icon','.line_story_item_title',].join(),function(e){if(isRepeatClick(e))return;var dataItem=$(this).closest('.story_item').data().item;if(['user','friends_post_live','friends_live'].indexOf(dataItem.type)>-1){App.openTab('https://instagram.com/'+dataItem.username+'/');}
else if(['location','place'].indexOf(dataItem.type)>-1){App.openTab('https://www.instagram.com/explore/locations/'+dataItem.location_id+'/');}
else if(dataItem.type=='tag'){App.openTab('https://www.instagram.com/explore/tags/'+dataItem.tag+'/');}});$body.on('click',['.tile_story_item_cover_image','.line_story_item_show'].join(),function(e){if(isRepeatClick(e))return;self.startShowStoriesByClickButton.call(this);});$body.on('click','.story_location_item',function(e){if(isRepeatClick(e))return;App.openTab('https://www.instagram.com/explore/locations/'+this.dataset.id+'/');});$body.on('click','.story_hashtag_item',function(e){if(isRepeatClick(e))return;App.openTab('https://www.instagram.com/explore/tags/'+this.dataset.tag+'/');});$body.on('click','.ext_ds_dl_btn',function(e){if(isRepeatClick(e))return;StoriesModule.onClickDlBtnOurStoryOne.call(this,e);});$body.on('click','.ext_ds_dl_all_btn',function(e){if(isRepeatClick(e))return;StoriesModule.onClickDlBtnOurStoryAll();});$body.on('click','.ext_upload_btn',function(e){if(isRepeatClick(e))return;if(this.dataset.disabled=='1')return;UploadModule.uploadBtnOnClick();});},startShowStoriesByClickButton:function(){var el=this;el.classList.add('loader');var dataItem=$(this).closest('.story_item').data().item;if(['friends_live','friends_post_live'].indexOf(dataItem.type)>-1){StoriesModule.requestLiveMedia(dataItem,function(data){if(!data){var errorText=dataItem.type=='friends_live'?chrome.i18n.getMessage('broadcast_finished'):chrome.i18n.getMessage('post_live_removed');return App.getModalBox().showErrorBox(errorText);}
if(dataItem.type=='friends_post_live'&&data.broadcasts[0].story_type=='post_live_igtv'){var storyItems=StoriesModule.prepareIgtv2SavedLive(data.broadcasts);StoriesModule.showInPswp(storyItems);return;}
storyItems=StoriesModule.prepareLiveStory(data);if(storyItems[0].story_type=='live'){StoriesModule.liveBox.show(storyItems[0]);}
else{StoriesModule.showInPswp(storyItems);}})}
else{StoriesModule.requestStoryMedia(dataItem,function(data){el.classList.remove('loader');if(data&&data.error){el.innerText=chrome.i18n.getMessage('stories_page_no_stories_something_went_wrong_msg');el.classList.add('no_stories');el.classList.add('error');return;}
else if(!data||!data.items){el.innerText=chrome.i18n.getMessage('stories_page_no_stories_msg');el.classList.add('no_stories');return;}
var storyItems=StoriesModule.prepareStoryItems(data.items);StoriesModule.showInPswp(storyItems);if(dataItem.type=='user'){StoriesModule.showingAuthor=dataItem.username}
else if(dataItem.type=='tag'){StoriesModule.showingAuthor=dataItem.tag}
else if(dataItem.type=='place'||dataItem.type=='location'){StoriesModule.showingAuthor=dataItem.liocation}});}},requestStoryMedia:function(options,callback){if(options.type=='user'||options.type=='friends_live'){storyUtils.requestUserStories(options.user_id,callback);}
else if(options.type=='location'||options.type=='place'){storyUtils.requestLocationStories(options.location_id,callback);}
else if(options.type=='tag'){storyUtils.requestTagStories(options.tag,callback);}
else{callback();}},requestLiveMedia:function(options,callback){storyUtils.sendMessage('getAllStories',function(stories){var res=null;if(options.type=='friends_post_live'){for(var k in stories.post_live){if(stories.post_live[k].pk==options.media_id){res=stories.post_live[k];break;}}}
else{for(var k in stories.broadcasts){if(stories.broadcasts[k].id==options.media_id){res=stories.broadcasts[k];break;}}}
return callback(res);});},arrowUpObj:{$el:null,shown:false,init:function(){this.$el=$('.up_to_top_button');Math.easeInOutQuad=function(t,b,c,d){t /=d/2;if(t<1)return c/2*t*t+b;t--;return-c/2*(t*(t-2)-1)+b;};var self=this;window.addEventListener('scroll',function(e){window.scrollY>1000?self.show():self.hide();});this.$el.on('click',function(){self.scrollUp();});},show:function(){if(this.shown)return;this.$el.show();this.$el.css({opacity:'0.7'});this.shown=true;},hide:function(){if(!this.shown)return;this.$el.css({opacity:'0'});this.$el.hide();this.shown=false;},scrollUp:function(){var duration=300,start=window.scrollY,change=0-start,currentTime=0,increment=20;var animateScroll=function(){currentTime+=increment;var val=Math.easeInOutQuad(currentTime,start,change,duration);window.scrollTo(0,val);if(currentTime<duration){setTimeout(animateScroll,increment);}};animateScroll();},},navigate:function(navName){if(this.currentNavItem&&this.currentNavItem==navName)return;var $contentContainer=$('.content_container > div');$contentContainer.hide();$('.nav_update_loader').show();$contentContainer.find('.content_list').html('');var func;switch(navName){case'friends':func=this.friendsPage.renderFriendsStories.bind(this.friendsPage);break;case'locations':func=this.locationPage.renderLocationsList.bind(this.locationPage);break;case'search':func=this.searchPage.renderSearch.bind(this.searchPage);break;case'upload':func=this.uploadPage.renderUpload.bind(this.uploadPage);break;case'upload_from_external':func=this.uploadPage.renderUploadFromExternal.bind(this.uploadPage);navName='upload';break;default:navName=this.defaultNavItem;func=this.friendsPage.renderFriendsStories.bind(this.friendsPage);}
this.currentNavItem=navName;window.location.hash=navName;setTimeout(function(){func(function(){$('.nav_update_loader').hide();$('.content_container #'+navName).show();});},200);},appendLineStoryItem:function($parent,data){var itemDataObj={username:data.user&&data.user.username,user_id:data.user&&data.user.id,location_id:data.location&&data.location.location_id,tag:data.tag,type:data.type,media_id:data.media_id};var imgWrapContent,title;if(data.type=='location'){if(this.isMac){imgWrapContent='<span class="flag_icon"><span>'+data.location.emoji+'</span></span>';}
else{imgWrapContent='<span class="location_code">'+data.location.code+'</span>';}
title=data.location.name;if(data.location.address&&data.location.address.length){title+=', '+data.location.address;}
if(data.location.city&&data.location.city.length){title+=', '+data.location.city;}
itemDataObj.liocation=title.replace(/[,\s]/,'_').toLowerCase();}
else if(data.type=='place'){imgWrapContent='<span class="place_default_icon"></span>';title=data.location.name;itemDataObj.liocation=title.replace(/[,\s]/,'_').toLowerCase();}
else if(data.type=='tag'){imgWrapContent='<span class="tag_default_icon"></span>';title=data.tag;}
else if(data.type=='user'){imgWrapContent='<span class="user_icon"><img src="'+data.user.profile_pic_url+'"></span>';title=data.user.username;}
var itemData=JSON.stringify(itemDataObj);$('<div class="story_item line_story_item" data-item=\''+itemData+'\' data-filter="'+title+'">'+'<div class="line_story_item_image_wrap">'+imgWrapContent+'</div>'+'<div class="line_story_item_title">'+title+'</div>'+'<div class="line_story_item_show"></div>'+'</div>'+'</div>').appendTo($parent);},appendTileStoryItem:function($parent,data){if(!data.user)return;var itemData=JSON.stringify({username:data.user.username,user_id:data.user.id,type:data.type,media_id:data.media_id}),userIconSrc=data.user.profile_pic_url,username=data.user.username,storyMessage=data.message,coverImgUrl=data.cover_frame_url,filterVal=data.user.username;$('<div class="story_item tile_story_item" data-item=\''+itemData+'\' data-filter="'+filterVal+'" data-story-id="'+data.media_id+'">'+'<div class="tile_story_item_header">'+'<span class="user_icon"><img src="'+userIconSrc+'"></span>'+'<span class="text_wrap">'+username+'</span>'+'</div>'+'<div class="tile_story_item_cover_image"><img src="'+coverImgUrl+'"></div>'+'</div>').appendTo($parent);},friendsPage:{updatePageInterval:undefined,renderFriendsStories:function(callback){var self=this;if(self.updatePageInterval){clearInterval(self.updatePageInterval);self.updatePageInterval=undefined;}
storyUtils.sendMessage('getAllStoriesForce',function(stories){if(StoriesModule.currentNavItem!='friends')return;self.updatePageInterval=setInterval(function(){if(StoriesModule.currentNavItem!='friends'){clearInterval(self.updatePageInterval);self.updatePageInterval=undefined;return;}
self.updateLivesAndPostLives();},60*1000);var $mainParent=$('.content_list','#friends');$mainParent.html('');if(!stories){$('input[name="name_filter_input"]','#friends').hide();$mainParent.append('<div class="no_stories_global">'+chrome.i18n.getMessage('stories_page_no_stories_something_went_wrong_msg')+'</div>');return typeof callback=='function'&&callback();}
else if(stories.broadcasts.length===0&&stories.post_live.length===0&&stories.tray.length===0){$('input[name="name_filter_input"]','#friends').hide();$mainParent.append('<div class="no_stories_global">'+chrome.i18n.getMessage('stories_page_no_stories_msg')+'</div>');return typeof callback=='function'&&callback();}
$('input[name="name_filter_input"]','#friends').val('').attr('placeholder',chrome.i18n.getMessage('stories_page_search')).show();$(`<div class="friends_lives">
       <div class="content_list_sub_header">
        <span class="icon"></span>
        <span class="text">${chrome.i18n.getMessage('live_videos')}</span>
       </div>
       <div class="content_sub_list"></div>
      </div>
      <div class="friends_post_lives">
       <div class="content_list_sub_header">
        <span class="icon"></span>
        <span class="text">${chrome.i18n.getMessage('saved_lives')}</span>
       </div>
       <div class="content_sub_list"></div>
      </div>
      <div class="friends_stories">
       <div class="content_list_sub_header">
        <span class="icon"></span>
        <span class="text">${chrome.i18n.getMessage('stories_page_friends_stories_header')}</span>
       </div>
       <div class="content_sub_list"></div>
      </div>`).appendTo($mainParent);var $liveParent=$mainParent.find('.friends_lives .content_sub_list'),$postLiveParent=$mainParent.find('.friends_post_lives .content_sub_list'),$storiesParent=$mainParent.find('.friends_stories .content_sub_list');stories.tray.forEach(function(storyItem){if(!storyItem.user)return;storyItem.items&&storyItem.items.forEach(function(item){item.user.username=storyItem.user.username;item.profile_pic_url=storyItem.user.profile_pic_url;});$storiesParent.parent().show();StoriesModule.appendLineStoryItem($storiesParent,{user:{username:storyItem.user.username,id:storyItem.user.pk,profile_pic_url:storyItem.user.profile_pic_url,},type:'user',media_id:storyItem.id,});});[].concat(stories.broadcasts,stories.post_live).forEach(function(storyItem){var isLive=!!storyItem.broadcast_owner;if(isLive){self.addLiveItem(storyItem,$liveParent);}
else{self.addPostLiveItem(storyItem,$postLiveParent);}});typeof callback=='function'&&callback();});},updateLivesAndPostLives:function(){var self=this;storyUtils.sendMessage('getAllStories',function(stories){if(!stories)return;if(StoriesModule.currentNavItem!='friends'){clearInterval(self.updatePageInterval);self.updatePageInterval=undefined;return;}
var $liveParent=$('.friends_lives .content_sub_list','#friends'),$postLiveParent=$('.friends_post_lives .content_sub_list','#friends');var $oldElements=$('.story_item',$liveParent).add($('.story_item',$postLiveParent));$oldElements.attr('data-updated','0');[].concat(stories.broadcasts,stories.post_live).forEach(function(storyItem){if($oldElements.filter(`[data-story-id="${storyItem.id}"]`).attr('data-updated','1').length>0)return;var isLive=typeof storyItem.broadcast_owner!='undefined';if(isLive){self.addLiveItem(storyItem,$liveParent);}
else{self.addPostLiveItem(storyItem,$postLiveParent);}});$oldElements.filter('[data-updated="0"]').remove();if($('.story_item',$liveParent).length===0){$liveParent.parent().hide();}
if($('.story_item',$postLiveParent).length===0){$postLiveParent.parent().hide();}});},addLiveItem:function(storyItem,$liveParent){$liveParent.parent().show();StoriesModule.appendTileStoryItem($liveParent,{user:{username:storyItem.broadcast_owner.username,id:storyItem.broadcast_owner.pk,profile_pic_url:storyItem.broadcast_owner.profile_pic_url,},type:'friends_live',media_id:storyItem.id,message:storyItem.broadcast_message,cover_frame_url:storyItem.cover_frame_url,});},addPostLiveItem:function(storyItem,$postLiveParent){if(!storyItem.user)return;$postLiveParent.parent().show();StoriesModule.appendTileStoryItem($postLiveParent,{user:{username:storyItem.user.username,id:storyItem.user.pk,profile_pic_url:storyItem.user.profile_pic_url,},type:'friends_post_live',media_id:storyItem.pk,message:'',cover_frame_url:storyItem.broadcasts[0].cover_frame_url,});},removeEndedLive:function(liveId){var $liveEl=$(`.story_item[data-story-id="${liveId}"]`);var $parent=$liveEl.closest('.friends_lives');$liveEl.remove();if($('.story_item',$parent).length===0){$parent.hide();}
chrome.runtime.sendMessage({action:'removeEndedLive',media_id:liveId});},},locationPage:{renderLocationsList:function(callback){var $parent=$('.content_list','#locations');$('input[name="name_filter_input"]','#locations').val('').attr('placeholder',chrome.i18n.getMessage('stories_page_search'));countriesList.forEach(function(country){StoriesModule.appendLineStoryItem($parent,{location:{emoji:country.emoji,code:country.code,location_id:country.locationId,name:country.name,},type:'location',});});callback();},},searchPage:{renderSearch:function(callback){$('[name="search_input"]').attr('placeholder',chrome.i18n.getMessage('stories_page_search')).val('');$('#search_users').text(chrome.i18n.getMessage('stories_page_search_btn_people'));$('#search_tags').text(chrome.i18n.getMessage('stories_page_search_btn_tags'));$('#search_places').text(chrome.i18n.getMessage('stories_page_search_btn_places'));callback();},searchStart:function(whereSearch){var self=this;var searchText=$('input[name="search_input"]').val();if(!searchText.length)return;var func;switch(whereSearch){case'users':func=storyUtils.requestSearchInUsers;break;case'tags':func=storyUtils.requestSearchInTags;break;case'places':func=storyUtils.requestSearchInPlaces;break;default:return;}
func(searchText,function(data){self.renderSearchResultsList(whereSearch,data.items);});},renderSearchResultsList:function(whereSearch,items){var $parent=$('.content_list','#search');$parent.html('');switch(whereSearch){case'users':items.forEach(function(item){StoriesModule.appendLineStoryItem($parent,{user:{username:item.username,id:item.pk,profile_pic_url:item.profile_pic_url,},type:'user',});});break;case'tags':items.forEach(function(item){StoriesModule.appendLineStoryItem($parent,{type:'tag',tag:item.name,});});break;case'places':items.forEach(function(item){StoriesModule.appendLineStoryItem($parent,{location:{addres:item.location.addres,city:item.location.city,location_id:item.location.pk,name:item.location.name,},type:'place',});});break;default:return;}},},uploadPage:{renderUpload:function(callback){UploadModule.uploadStateInit();callback();},renderUploadFromExternal:function(callback){UploadModule.uploadStateInit();chrome.storage.sync.get('upload_external',function(data){if(!data.upload_external)return callback();UploadModule.getExternalUploadLink();callback();});},},showLocationItemStories:function(locationId){storyUtils.requestLocationStories(locationId,function(data){var storyItems=StoriesModule.prepareStoryItems(data.story.items);if(!storyItems.length){return;}
StoriesModule.showInPswp(storyItems);})},darkModeInit:function(){chrome.storage.sync.get('stories_dark_mode',function(data){var settingsDarkMode=data.stories_dark_mode||false;settingsDarkMode&&document.body.classList.add('dark');var $darkModeOption=$('.dark_mode');if(settingsDarkMode){document.body.classList.add('dark');$darkModeOption.addClass('active');$darkModeOption.find('.title').text(chrome.i18n.getMessage('dark_mode'));}
else{$darkModeOption.find('.title').text(chrome.i18n.getMessage('light_mode'));}
var $pushToggles=$darkModeOption.find('.push-toggle');$pushToggles.on('click',function(){if($darkModeOption.hasClass('active')){$darkModeOption.removeClass('active');chrome.storage.sync.set({stories_dark_mode:false});$darkModeOption.find('.title').text(chrome.i18n.getMessage('light_mode'));}
else{$darkModeOption.addClass('active');chrome.storage.sync.set({stories_dark_mode:true});$darkModeOption.find('.title').text(chrome.i18n.getMessage('dark_mode'));}
document.body.classList.toggle('dark');});});},requireAuthorize:function(){$('.page_wrap').hide();$('body').append('<div class="unauthorized_msg">'+'<div class="text">'+chrome.i18n.getMessage('notAuthorizedMsg')+'</div>'+'<div class="link"><a href="https://www.instagram.com/accounts/login/">'+chrome.i18n.getMessage('go_to_instagram')+'</a></div>'+'</div>');},showWaitingLiveLoader:function(){$(`<div class="wait_live_placeholder"><span></span></div>`).appendTo(document.body);},hideWaitingLiveLoader:function(){document.querySelector('.wait_live_placeholder').remove();},checkPredefinedBroadcast:function(){var broadcastType=window.location.hash.match(/#type=([\w_]+)/);broadcastType=broadcastType&&broadcastType[1];if(!broadcastType)return;this.showWaitingLiveLoader();var self=this;var storyId,userId;userId=window.location.hash.match(/&user_id=([\w_]+)/);userId=userId&&userId[1];this.requestOneUserAllTypesStories({user_id:userId},function(allTypesStories){if(!allTypesStories){self.hideWaitingLiveLoader();return App.getModalBox().showErrorBox(chrome.i18n.getMessage('stories_page_live_not_found'));}
if(broadcastType=='live'){storyId=window.location.hash.match(/&live_id=([\w_]+)/);storyId=storyId&&storyId[1];if(allTypesStories&&allTypesStories.broadcast){var storyItems=StoriesModule.prepareLiveStory(allTypesStories.broadcast);StoriesModule.liveBox.show(storyItems[0]);self.hideWaitingLiveLoader();}
else{self.hideWaitingLiveLoader();return App.getModalBox().showErrorBox(chrome.i18n.getMessage('stories_page_live_not_found'));}}
else{var myPostLivesId='post_live_'+userId;storyUtils.sendMessage('getAllStories',function(stories){var postLiveItem;for(var k in stories.post_live){if(stories.post_live[k].pk&&stories.post_live[k].pk==myPostLivesId){postLiveItem=stories.post_live[k];break;}}
self.hideWaitingLiveLoader();postLiveItem=postLiveItem||allTypesStories.post_live_item||null;if(postLiveItem){var storyItems=StoriesModule.prepareLiveStory(postLiveItem);StoriesModule.showInPswp(storyItems);return;}
return App.getModalBox().showErrorBox(chrome.i18n.getMessage('stories_page_live_not_found'));});}});return true;},run:function(){var self=this;storyUtils.sendMessage('getUserSelfInfo',function(res){if(!res)return self.requireAuthorize();self.checkPredefinedBroadcast();self.buildStoriesPage();});},}})();var App=(function(){return{getModalBox:function(){var modalBox=document.querySelector('.ext_modal');if(!modalBox){modalBox=document.createElement('div');modalBox.className='ext_modal igsdr';modalBox.innerHTML='<div class="ext_modal_content"></div>';document.querySelector('body').appendChild(modalBox);}
var modalContent=modalBox.querySelector('.ext_modal_content');var btnContinue,btnCancel,btnEnough,checkBox,closeBtn,progressBar,downloadAllSuccessCount,downloadAllRetry,downloadAllRetryText,downloadPostLiveVideo,downloadPostLiveAudio;var allListeners=[];function modalClose(){checkBox=modalBox.querySelector('#ext_modal_checkbox');if(checkBox&&checkBox.checked){storyUtils.sendMessage('warning-off',function(){});}
removeListeners();modalBox.style.display="none";modalContent.innerHTML='';modalBox.opened=0;modalBox.remove();}
function onContinueBtnClick(cb){return function(){modalClose();cb();}}
function onEnoughBtnClick(cb){return function(){modalClose();cb();}}
function onCustomBtnClick(cb){return function(){cb();};}
function onCancelBtnClick(cb){return function(){modalClose();StoriesModule.storiesPause.off();if(typeof cb=='function'){cb();}};}
function closeByEsc(event){if(event.keyCode==27){onCancelBtnClick()();}}
function closeByClickOnWindow(event){if(event.target==modalBox){modalClose();}}
function addListener(el,event,listener){if(el&&event&&listener){el.addEventListener(event,listener);}
allListeners.push({el:el,event:event,listener:listener});}
function removeListeners(){allListeners.forEach(function(item){if(item.el&&item.event&&item.listener){item.el.removeEventListener(item.event,item.listener);}});window.removeEventListener('click',closeByClickOnWindow);window.removeEventListener('keydown',closeByEsc);}
function addListeners(listeners){btnContinue=modalBox.querySelector('.ext_btn_continue');btnCancel=modalBox.querySelector('.ext_btn_cancel');closeBtn=modalContent.querySelector('.ext_modal_close');downloadPostLiveVideo=modalContent.querySelector('.btn_dl_post_live_video');downloadPostLiveAudio=modalContent.querySelector('.btn_dl_post_live_audio');btnEnough=modalContent.querySelector('.ext_btn_enough');if(listeners){if(typeof listeners.continueCallback=='function'&&btnContinue){addListener(btnContinue,'click',onContinueBtnClick(listeners.continueCallback));}
if(typeof listeners.downloadPostLiveVideo=='function'&&downloadPostLiveVideo){addListener(downloadPostLiveVideo,'click',onCustomBtnClick(listeners.downloadPostLiveVideo));}
if(typeof listeners.downloadPostLiveAudio=='function'&&downloadPostLiveAudio){addListener(downloadPostLiveAudio,'click',onCustomBtnClick(listeners.downloadPostLiveAudio));}
if(typeof listeners.enoughCallback=='function'&&btnEnough){addListener(btnEnough,'click',onEnoughBtnClick(listeners.enoughCallback));}
if(typeof listeners.openByEnter=='function'){addListener(window,'keypress',listeners.openByEnter);}}
addListener(btnCancel,'click',onCancelBtnClick(listeners&&listeners.cancelCallback));addListener(closeBtn,'click',onCancelBtnClick(listeners&&listeners.cancelCallback));window.addEventListener('keydown',closeByEsc);}
modalBox.close=function(){modalClose();};modalBox.showPostLiveSeparatelyChoice=function(text,listeners){modalContent.innerHTML=`<span class="ext_modal_close">&times;</span> 
     <div class="ext_modal_header"> 
      <div>${text}</div> 
     </div> 
     <div class="ext_modal_buttons_wrap"> 
      <button class="btn_dl_post_live_video">${chrome.i18n.getMessage('btn_dl_post_live_video').toUpperCase()}</button> 
      <button class="btn_dl_post_live_audio">${chrome.i18n.getMessage('btn_dl_post_live_audio').toUpperCase()}</button> 
     </div>`;addListeners(listeners);window.addEventListener('click',closeByClickOnWindow);modalBox.style.display='block';modalBox.opened=1;};modalBox.showCloseUploadWarning=function(listeners){modalContent.innerHTML=`<div class="ext_modal_header"> 
      <div>${chrome.i18n.getMessage('are_you_sure_leave')}</div> 
      <div>${chrome.i18n.getMessage('all_your_changes_will_lost')}</div> 
     </div> 
     <div class="ext_modal_buttons_wrap"> 
      <button class="ext_btn_continue">${chrome.i18n.getMessage('btn_continue').toUpperCase()}</button> 
      <button class="ext_btn_cancel">${chrome.i18n.getMessage('btn_cancel').toUpperCase()}</button> 
     </div>`;addListeners(listeners);window.addEventListener('click',closeByClickOnWindow);modalBox.style.display='block';modalBox.opened=1;};modalBox.showDownloadProcess=function(allCount,cb){window.removeEventListener('click',closeByClickOnWindow);modalContent.innerHTML=`<div class="ext_download_all_process">
      <div class="download_all_process_state">${chrome.i18n.getMessage("download_zip")}</div> 
      <div class="download_all_retry">${chrome.i18n.getMessage("retry_requests")}
       <span></span>
      </div>
      <div id="ext_progress"> 
       <div id="ext_bar"></div> 
      </div> 
      <div class="download_all_success_count"></div>
      <div class="ext_modal_buttons_wrap"> 
       <button class="ext_btn_cancel cancel_download">${chrome.i18n.getMessage('btn_cancel').toUpperCase()}</button> 
       <button class="ext_btn_enough">${chrome.i18n.getMessage('btn_enough').toUpperCase()}</button> 
      </div>
     </div>`;downloadAllSuccessCount=modalContent.querySelector('.download_all_success_count');downloadAllRetry=modalContent.querySelector('.download_all_retry');downloadAllRetryText=modalContent.querySelector('.download_all_retry span');progressBar=modalBox.querySelector('#ext_bar');downloadAllSuccessCount.innerText='(0/'+allCount+')';addListeners(cb);modalBox.style.display='block';modalBox.opened=1;};modalBox.updateDownloadZipProgressBar=function(options){if(options.from_tagged){return;}
if(!modalBox.querySelector('.ext_download_all_process')){return;}
downloadAllSuccessCount.innerText='('+options.successCount+'/'+options.allCount+')';if(options.retryRequestsCount){downloadAllRetry.style.display='block';downloadAllRetryText.innerText=' ('+options.retrySuccessCount+'/'+options.retryRequestsCount+')';}
if(!options.lastSuccess){return;}
var value=options.oneValuePercent;if(!progressBar.style.width){progressBar.style.width='0%';}
var oldVal=parseFloat(progressBar.style.width);var newVal=oldVal+value;if(newVal==100||newVal>100){newVal=100;}
progressBar.style.width=newVal+'%';};modalBox.showDownloadPostLiveWarning=function(listeners){modalContent.innerHTML=`<span class="ext_modal_close">&times;</span>
     <div class="ext_modal_header download_post_live_warning">${chrome.i18n.getMessage('download_post_live_warning')}</div>
     <div class="ext_download_post_live_guide"> 
      <img src="${chrome.runtime.getURL('/img/guide_en.png')}"></div>
     <div class="ext_modal_buttons_wrap">
      <button class="ext_btn_continue continue_download_loader">${chrome.i18n.getMessage('btn_download_loader').toUpperCase()}</button>
     </div>
     <div class="ext_modal_footer post_live_do_not_show">
      <input type="checkbox" id="ext_modal_checkbox">
      <span>${chrome.i18n.getMessage('do_not_show_again')}</span>
     </div>`;modalContent.style['min-width']='600px';modalContent.style['max-width']='800px';modalContent.style['margin']='5% auto';addListeners(listeners);window.addEventListener('click',closeByClickOnWindow);modalBox.style.display='block';modalBox.opened=1;};modalBox.showPostLiveDownloadProcess=function(cb){window.removeEventListener('click',closeByClickOnWindow);modalContent.innerHTML=`<span class="ext_modal_close">&times;</span>
     <div class="ext_download_post_live_process">
      <div class="ext_text">${chrome.i18n.getMessage("post_live_loader_downloading")}</div>
      <div class="ext_loader"><span></span></div>
     </div>`;addListeners(cb);modalBox.style.display='block';modalBox.opened=1;};modalBox.showErrorBox=function(errorText){modalContent.innerHTML=`<span class="ext_modal_close">&times;</span>
     <div class="ext_error_modal_wrap">
      <div class="ext_error_modal_text">${errorText}</div>
     </div>`;addListeners();window.addEventListener('click',closeByClickOnWindow);modalBox.opened=1;modalBox.style.display='block';};modalBox.opened=0;modalContent.innerHTML='';return modalBox;},customPromiseAll:function(options,func){var PROMISE_PENDING=0;var PROMISE_RESOLVED=1;var PROMISE_REJECTED=2;var args=options.data,timeout=options.timeout||600000,asyncTasksCount=options.asyncCount||48;var rejected=false;var self=this;var res=[];var argsCount,resultsCount,statusIntervalId,promiseState,nextTask;var resolveFunc=function(){if(typeof nextTask.resolve!=='function'){return;}
args=res;setTimeout(function(){try{nextTask.resolve(args);}catch(e){res=e;rejectFunc();}},0);};var rejectFunc=function(){if(rejected){return;}
rejected=true;if(typeof nextTask.reject!=='function'){return;}
func=nextTask.reject;func(res);};var execAll=function(){resultsCount=0;argsCount=args.length;var asyncTasksInProcess=0;var resolveInnerCallback=function(index){return function(result){if(!Array.isArray(res)||promiseState==PROMISE_REJECTED){return;}
asyncTasksInProcess--;resultsCount++;res[index]=result;if(resultsCount===argsCount){promiseState=PROMISE_RESOLVED;}};};var rejectInnerCallback=function(result){promiseState=PROMISE_REJECTED;res=result;};promiseState=PROMISE_PENDING;checkerFunc();var foreachInterval=setInterval(function(){if(!args.length||promiseState!=PROMISE_PENDING){clearInterval(foreachInterval);return;}
var freeTasksSlots=asyncTasksCount-asyncTasksInProcess;if(freeTasksSlots<1){return;}
args.splice(0,freeTasksSlots).forEach(function(arg,index){setTimeout(function(){try{asyncTasksInProcess++;func(arg,resolveInnerCallback(index),rejectInnerCallback);}catch(e){res=e;promiseState=PROMISE_REJECTED;}},0);});},500);};function checkerFunc(){if(statusIntervalId){return;}
statusIntervalId=setInterval(function(){if(promiseState===PROMISE_PENDING){return;}
clearInterval(statusIntervalId);statusIntervalId=undefined;if(promiseState===PROMISE_RESOLVED){resolveFunc();}else{rejectFunc();}},10);}
this.thenOne=function(resolve,reject){nextTask={resolve:resolve,reject:reject};checkerFunc();return self;};execAll();return this;},openTab:function(url){chrome.runtime.sendMessage({action:'openPage',url:url,});},isMacOs:function(){return!!window.navigator.userAgent.toLowerCase().match(/mac\s*os/);},isWindows:function(){return window.navigator.userAgent.toLowerCase().indexOf('windows')>-1;},}})();StoriesModule.run();